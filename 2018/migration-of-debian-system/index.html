<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>系统移植2-Debian系统的移植 | Shuzang's Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=Description content="书藏的个人博客，包括Golang、数据结构、算法的学习记录，各类生活技能的学习，每周五发布一期自己的生活周刊"><link rel=prev href=https://shuzang.github.io/2018/android-system-migration/><link rel=next href=https://shuzang.github.io/2018/migration-related-knowledge/><link rel=canonical href=https://shuzang.github.io/2018/migration-of-debian-system/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta name=twitter:card content="summary"><meta name=twitter:title content="系统移植2-Debian系统的移植"><meta name=twitter:description content="Debian 系统的移植总分四部分：u-boot的编译与烧录，Linux内核的编译与烧录，Debian 基本根文件系统的制作、配置与烧录，开发板设置。 1. u"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"系统移植2-Debian系统的移植","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/shuzang.github.io\/2018\/migration-of-debian-system\/"},"image":{"@type":"ImageObject","url":"https:\/\/shuzang.github.io\/cover.png","width":800,"height":600},"genre":"posts","keywords":"linux","wordcount":5318,"url":"https:\/\/shuzang.github.io\/2018\/migration-of-debian-system\/","datePublished":"2018-04-11T00:00:00\x2b00:00","dateModified":"2020-04-27T00:00:00\x2b00:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"shuzang","logo":{"@type":"ImageObject","url":"https:\/\/shuzang.github.io\/logo.png","width":127,"height":40}},"description":""}</script><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/lib/fontawesome-free/all.min.css></head><body><script>window.isDark=(window.localStorage&&window.localStorage.getItem('theme'))==='dark';window.isDark&&document.body.classList.add('dark-theme');</script><div class=wrapper><nav class=navbar><div class=top-scroll-bar></div><div class=navbar-container><div class="navbar-header animated bounceIn"><a href=https://shuzang.github.io>Shuzang's Blog</a></div><div class=navbar-menu><a class=menu-item href=https://shuzang.github.io/posts>Posts</a><a class=menu-item href=https://shuzang.github.io/tags>Tags</a><a class=menu-item href=https://shuzang.github.io/categories>Categories</a><a class=menu-item href=https://shuzang.github.io/about>About</a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><nav class=navbar-mobile><div class=top-scroll-bar></div><div class=navbar-container><div class=navbar-header><div class="navbar-header-title animated bounceIn"><a href=https://shuzang.github.io>Shuzang's Blog</a></div><div class=menu-toggle id=menu-toggle><span></span><span></span><span></span></div></div><div class=navbar-menu id=mobile-menu><a class=menu-item href=https://shuzang.github.io/posts>Posts</a><a class=menu-item href=https://shuzang.github.io/tags>Tags</a><a class=menu-item href=https://shuzang.github.io/categories>Categories</a><a class=menu-item href=https://shuzang.github.io/about>About</a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><main class=main><div class=container><article class=page><h1 class="post-title animated flipInX">系统移植2-Debian系统的移植</h1><div class=post-meta><i class="far fa-calendar-alt fa-fw"></i>published on&nbsp;<time datetime=2018-04-11>2018-04-11</time>&nbsp;
<i class="fas fa-pencil-alt fa-fw"></i>about 5318 words&nbsp;<span class=post-category><i class="far fa-folder fa-fw"></i>included in&nbsp;<a href=https://shuzang.github.io/categories/%E7%88%B1%E7%BC%96%E7%A8%8B%E7%88%B1%E6%8A%80%E6%9C%AF%E7%9A%84%E5%AD%A9%E5%AD%90/>爱编程爱技术的孩子</a>&nbsp;</span></div><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#1-u-boot的编译>1. u-boot的编译</a><ul><li><a href=#11-下载源码>1.1 下载源码</a></li><li><a href=#12-分支切换>1.2 分支切换</a></li><li><a href=#13-安装依赖>1.3 安装依赖</a></li><li><a href=#14-开始编译>1.4 开始编译</a></li></ul></li><li><a href=#2-linux内核编译>2. Linux内核编译</a><ul><li><a href=#21-源码下载>2.1 源码下载</a></li><li><a href=#22-安装压缩工具lzop>2.2 安装压缩工具lzop</a></li><li><a href=#23-编译>2.3 编译</a></li></ul></li><li><a href=#3-debian-根文件系统的制作与配置>3. Debian 根文件系统的制作与配置</a><ul><li><a href=#31-基本说明>3.1 基本说明</a></li><li><a href=#32-工具软件安装>3.2 工具软件安装</a></li><li><a href=#33-根文件系统制作>3.3 根文件系统制作</a></li><li><a href=#34-qemu-配置>3.4 QEMU 配置</a></li></ul></li><li><a href=#4-新系统配置>4. 新系统配置</a></li><li><a href=#5-烧录工作>5. 烧录工作</a><ul><li><a href=#51-设置sd卡>5.1 设置SD卡</a><ul><li><a href=#格式化>格式化</a></li><li><a href=#删除原有分区>删除原有分区</a></li><li><a href=#重新分区>重新分区</a></li></ul></li><li><a href=#52-烧录>5.2 烧录</a><ul><li><a href=#u-boot>u-boot</a></li><li><a href=#内核>内核</a></li><li><a href=#根文件系统>根文件系统</a></li></ul></li></ul></li><li><a href=#6-开发板设置>6. 开发板设置</a></li><li><a href=#7-使用界面>7. 使用界面</a></li><li><a href=#8-参考>8. 参考</a></li></ul></nav></div></div><div class=post-toc-mobile id=post-toc-mobile><details><summary><div class=post-toc-title><span>Contents</span>
<span><i class="details icon fas fa-angle-down"></i></span></div></summary><div class=post-toc-content><nav id=TableOfContentsMobile><ul><li><a href=#1-u-boot的编译>1. u-boot的编译</a><ul><li><a href=#11-下载源码>1.1 下载源码</a></li><li><a href=#12-分支切换>1.2 分支切换</a></li><li><a href=#13-安装依赖>1.3 安装依赖</a></li><li><a href=#14-开始编译>1.4 开始编译</a></li></ul></li><li><a href=#2-linux内核编译>2. Linux内核编译</a><ul><li><a href=#21-源码下载>2.1 源码下载</a></li><li><a href=#22-安装压缩工具lzop>2.2 安装压缩工具lzop</a></li><li><a href=#23-编译>2.3 编译</a></li></ul></li><li><a href=#3-debian-根文件系统的制作与配置>3. Debian 根文件系统的制作与配置</a><ul><li><a href=#31-基本说明>3.1 基本说明</a></li><li><a href=#32-工具软件安装>3.2 工具软件安装</a></li><li><a href=#33-根文件系统制作>3.3 根文件系统制作</a></li><li><a href=#34-qemu-配置>3.4 QEMU 配置</a></li></ul></li><li><a href=#4-新系统配置>4. 新系统配置</a></li><li><a href=#5-烧录工作>5. 烧录工作</a><ul><li><a href=#51-设置sd卡>5.1 设置SD卡</a><ul><li><a href=#格式化>格式化</a></li><li><a href=#删除原有分区>删除原有分区</a></li><li><a href=#重新分区>重新分区</a></li></ul></li><li><a href=#52-烧录>5.2 烧录</a><ul><li><a href=#u-boot>u-boot</a></li><li><a href=#内核>内核</a></li><li><a href=#根文件系统>根文件系统</a></li></ul></li></ul></li><li><a href=#6-开发板设置>6. 开发板设置</a></li><li><a href=#7-使用界面>7. 使用界面</a></li><li><a href=#8-参考>8. 参考</a></li></ul></nav></div></details></div><div class=post-content><p>Debian 系统的移植总分四部分：u-boot的编译与烧录，Linux内核的编译与烧录，Debian 基本根文件系统的制作、配置与烧录，开发板设置。</p><a class=post-dummy-target id=1-u-boot的编译></a><h2>1. u-boot的编译</h2><p>对应于EMSYM的blurr开发板的u-boot项目使用GitHub进行开源维护，<a href=https://github.com/EMSYM/U-boot target=_blank>下载地址</a>，我的编译环境为Ubuntu16.04 LTS系统</p><a class=post-dummy-target id=11-下载源码></a><h3>1.1 下载源码</h3><p>方法一：在链接打开后的项目界面依次选择clone or download—>Download ZIP，将源码下载到PC中相应的文件夹（记得解压&mldr;..）</p><p>方法二：采用git命令（须事先安装git）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ git clone https://github.com/EMSYM/U-boot.git
</code></pre></td></tr></table></div></div><p>注：该链接在选中clone or download后可看到</p><a class=post-dummy-target id=12-分支切换></a><h3>1.2 分支切换</h3><p>在下载好的u-boot项目目录下打开虚拟终端，创建并切换分支</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ git checkout -b v4.1 origin/blurr-4.1.15
</code></pre></td></tr></table></div></div><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_d1bb18bcb403.png alt=创建并切换分支 class=lazyload><figcaption class=image-caption>创建并切换分支</figcaption></figure></p><a class=post-dummy-target id=13-安装依赖></a><h3>1.3 安装依赖</h3><p>gcc-arm-linux-gnueabi是我们用到的交叉编译器</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo apt install gcc-arm-linux-gnueabi
$ sudo apt-get install build-essential gcc
</code></pre></td></tr></table></div></div><p>注：Ubuntu缺省情况下，并没有提供C/C++的编译环境，因此还需要手动安装。如果单独安装gcc以及g++比较麻烦，幸运的是，为了能够编译Ubuntu的内核，Ubuntu提供了一个build-essential软件包。因为依赖关系的问题，安装了该软件包，编译c/c++所需要的软件包也都会被安装。因此如果想在Ubuntu中编译c/c++程序，只需要安装该软件包就可以了。</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_8135c2d310f2.png alt=build-essential的依赖关系 class=lazyload><figcaption class=image-caption>build-essential的依赖关系</figcaption></figure></p><a class=post-dummy-target id=14-开始编译></a><h3>1.4 开始编译</h3><p>指定核心类型</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ <span class=nv>ARCH</span><span class=o>=</span>arm
</code></pre></td></tr></table></div></div><p>生成配置文件（用到Makefile，参阅<a href=https://hacker-yhj.github.io/resources/gun_make.pdf target=_blank>GNU make中文手册</a>）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ make mx6dl_blurr_defconfig
</code></pre></td></tr></table></div></div><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_c22b1be42612.png alt=生成配置文件 class=lazyload><figcaption class=image-caption>生成配置文件</figcaption></figure></p><p>指定交叉编译前缀，编译u-boot</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ make <span class=nv>CROSS_COMPILE</span><span class=o>=</span>arm-linux-gnueabi- 
</code></pre></td></tr></table></div></div><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_967c5a8d8bba.png alt=编译通过 class=lazyload><figcaption class=image-caption>编译通过</figcaption></figure></p><p>执行完上述步骤后，编译即可成功</p><a class=post-dummy-target id=2-linux内核编译></a><h2>2. Linux内核编译</h2><p>同样，对应于blurr开发板的Linux内核项目也在GitHub上开源维护，<a href=https://github.com/EMSYM/linux target=_blank>项目地址</a></p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_fd26ed77a3ab.png alt=github上的工程 class=lazyload><figcaption class=image-caption>github上的工程</figcaption></figure></p><a class=post-dummy-target id=21-源码下载></a><h3>2.1 源码下载</h3><p>下载源码的手段与u-boot类似。这里要提醒的是，最好直接Download ZIP，不要clone，因为下载ZIP只有100多M，clone会有一个多G。而这两种手段得到的源码对之后的编译没有影响。（记得解压zip文件）</p><a class=post-dummy-target id=22-安装压缩工具lzop></a><h3>2.2 安装压缩工具lzop</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo apt-get install lzop
</code></pre></td></tr></table></div></div><p>lzop是最后生成时要用到的一个压缩工具，当没有安装此工具就开始编译，过程中会出现一个lozp：not found的错误</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_5665b6610702.png alt="lozp：not fountd" class=lazyload><figcaption class=image-caption>lozp：not fountd</figcaption></figure></p><a class=post-dummy-target id=23-编译></a><h3>2.3 编译</h3><p>进入下载好的Linux项目主目录，逐步执行如下命令</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>export</span> <span class=nv>ARCH</span><span class=o>=</span>arm
$ <span class=nb>export</span> <span class=nv>CROSS_COMPILE</span><span class=o>=</span>arm-linux-gnueabi-
$ make blurr_defconfig
$ make
</code></pre></td></tr></table></div></div><p>前两句的意思是指定芯片的架构以及交叉编译器前缀，然后就开始编译了（之前编译u-boot时已装好交叉编译器），可参考 <a href=http://blog.csdn.net/wl_fln/article/details/7258294 target=_blank>export命令的介绍</a></p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_57171204afb8.png alt=四条指令 class=lazyload><figcaption class=image-caption>四条指令</figcaption></figure></p><p>会有一些warning，但不碍事</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/ad7eeaabb67f.png alt=warning class=lazyload><figcaption class=image-caption>warning</figcaption></figure></p><p>要等很久&mldr;..</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_cc3a1d8404d3.png alt=编译成功 class=lazyload><figcaption class=image-caption>编译成功</figcaption></figure></p><p>完成如上步骤后即可编译完成，我们需要编译得到的zImage文件和imx6dl-blurr.dtb文件位置如下：</p><ul><li><p>zImage：linux-blurr 4.1.15—>arch—>arm—>boot</p></li><li><p>imx6dl-blurr.dtb：linux-blurr 4.1.15—>arch—>arm—>boot—>dts</p></li></ul><p>zImage位置如下图</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_beb1c3962a3d.png alt=zImage class=lazyload><figcaption class=image-caption>zImage</figcaption></figure></p><p>imx6dl-blurr.dtb直接从上面目录里的dts点进去</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_6488bacf69de.png alt=imx6dl-blurr.dtb class=lazyload><figcaption class=image-caption>imx6dl-blurr.dtb</figcaption></figure></p><a class=post-dummy-target id=3-debian-根文件系统的制作与配置></a><h2>3. Debian 根文件系统的制作与配置</h2><p>该部分内容主要参考官方文档 <a href=https://wiki.debian.org/EmDebian/CrossDebootstrap target=_blank>EmDebian CrossDebootstrap</a>，方法为QEMU/debootstrap的方法。使用debootstrap工具完成根文件系统的制作，使用QEMU模拟器完成配置工作。</p><a class=post-dummy-target id=31-基本说明></a><h3>3.1 基本说明</h3><p>制作根文件系统的工具常用Debootstrap和Multistrap，制作流程大概分为四个步骤：</p><p>1、从源里下载需要的.deb软件包</p><p>2、解压它们到相应的目标目录</p><p>3、用chroot命令修改该目标目录为根目录</p><p>4、配置脚本，完成安装</p><p>通常，使用debootstrap、cdebootstrap或multistrap完成第一二阶段的工作，QEMU完成第三四阶段的工作。</p><a class=post-dummy-target id=32-工具软件安装></a><h3>3.2 工具软件安装</h3><p>使用如下的命令安装所需要工具软件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo apt-get install binfmt-support qemu qemu-user-static debootstrap
</code></pre></td></tr></table></div></div><p>debootstrap是根文件系统制作工具，qemu是模拟器，是为了在宿主机上模拟开发板的环境</p><p>接下来的步骤需要以root身份执行，因为debootstrap的工作以及chroot到建好的新系统的目录都需要root权限</p><a class=post-dummy-target id=33-根文件系统制作></a><h3>3.3 根文件系统制作</h3><p>首先选择要引导的目标架构和Debian版本（例如stable、testing或sid）,我们选择开发板对应的arm架构，版本选择Debian9.1,叫做stretch。</p><p>创建一个目录文件，制作好的根文件系统将放在这个目录下。需要提示以后所有对根文件系统的修改都局限在这个目录里，不会影响到宿主机，所以不用担心搞毁你的系统。为了介绍清楚，我们采用“debian_armhf_stretch”作为目录名，但它其实就是rootfs，如果你这样命名的话</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo mkdir debian_armhf_stretch
</code></pre></td></tr></table></div></div><p>制作根文件系统，需要运行debootstrap</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo debootstrap --foreign --arch armhf stretch debian_armhf_stretch http://ftp.debian.org/debian/
</code></pre></td></tr></table></div></div><p>其中<code>debian_armhf_stretch</code>是创建的目录，<code>armhf</code>是目标架构，<code>http://ftp.debian.org/debian</code>是Debian镜像，必需的.deb包将从这里下载。可以随意选择自己喜欢的镜像，只要它有我们要用于的目标架构。<a href=http://www.debian.org/mirror/list target=_blank>可用的Debian镜像列表</a>，<a href=https://linux.cn/man/man8/debootstrap.8.html target=_blank>debootstrap命令说明</a></p><p>会运行两次，第一次是从网上下载，第二次就是在debian_armhf_stretch目录下生成bin、sbin这些Linux文件系统目录了。</p><a class=post-dummy-target id=34-qemu-配置></a><h3>3.4 QEMU 配置</h3><p>根文件系统已经创建完成。默认情况下，debootstrap创建的是一个非常小的系统，所以可能需要扩展一下，这个放在后面的配置新系统。</p><p>先复制“qemu-arm-static” 到刚构建的根文件系统中。为了能chroot到目标文件系统，针对目标CPU的qemu模拟器需要从内部访问</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo cp /usr/bin/qemu-arm-static  debian_armhf_stretch/usr/bin
</code></pre></td></tr></table></div></div><p>接下来运行debootstrap的第二个阶段来解压步骤3中安装的所有软件包</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo <span class=nv>DEBIAN_FRONTEND</span><span class=o>=</span>noninteractive <span class=nv>DEBCONF_NONINTERACTIVE_SEEN</span><span class=o>=</span><span class=nb>true</span> <span class=nv>LC_ALL</span><span class=o>=</span>C <span class=nv>LANGUAGE</span><span class=o>=</span>C <span class=nv>LANG</span><span class=o>=</span>C chroot debian_armhf_stretch debootstrap/debootstrap --second-stage
</code></pre></td></tr></table></div></div><p>该命令意思是设置一些环境变量,然后切换根目录到debian_armhf_stretch（这个操作是chroot做的，这个命令很有意思），执行目录debian_armhf_stretch/debootstrap下的命令: debootstrap &ndash;second-stage。终端上最后会打印 <code>I: Base system installed successfully.</code>，就说明成功了。</p><p>切换到qemu</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nv>$sudo</span> chroot debian_armhf_stretch
</code></pre></td></tr></table></div></div><p>不过如果这样的话之后的提示都是英文的，想显示中文需要把上面的命令这样输入</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo <span class=nv>LANG</span><span class=o>=</span>C.UTF-8 chroot debian_armhf_stretch
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=4-新系统配置></a><h2>4. 新系统配置</h2><p>刚刚创建的新系统需要一些简单的调整以便于你运用它做一些特殊的工作。下面的步骤需要以root权限执行</p><ol><li><p>手动在/etc/apt/sources.list里面添加如下条目</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>deb http://ftp.debian.org/debian/ stretch main contrib non-free
deb-src http://ftp.debian.org/debian/ stretch main contrib non-free
</code></pre></td></tr></table></div></div><p>源的选择是随便的，只要它支持目标平台就行，不过国内<a href=https://lug.ustc.edu.cn/wiki/mirrors/help/debian target=_blank>中科大的源</a>好用一点，这时候就可以像往常一样使用apt-get install 命令安装其它软件包了。</p></li><li><p>安装xorg和KDE，KDE新版本叫plasma</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo apt-get install xorg
$ sudo apt-get install plasma-desktop
</code></pre></td></tr></table></div></div><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_ff04dfdcef82.png alt=plasma-desktop class=lazyload><figcaption class=image-caption>plasma-desktop</figcaption></figure></p><p>这句执行也是真的久，不要着急，中间可能会自动进入一些配置界面，根据选项自己选就行，如果乱码的话可以选第一个，其实上面设置成中文就没乱码了。</p></li><li><p>安装终端konsole，安装浏览器qupzilla（这是因为Debian9以下不支持chrome），安装文件管理器dolphin，网络管理器plasma-nm</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo apt-get install konsole
$ sudo apt-get install qupzilla
$ sudo apt-get install dolphin
$ sudo apt-get install plasma-nm
</code></pre></td></tr></table></div></div></li><li><p>打开etc文件夹中的fstab文件，在末尾添加</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>/dev/sda / ext4 defaults <span class=m>0</span> <span class=m>1</span>
</code></pre></td></tr></table></div></div></li><li><p>root用户下输入命令</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>chown root:root /usr/bin/sudo
chmod <span class=m>4755</span> /usr/bin
</code></pre></td></tr></table></div></div></li></ol><a class=post-dummy-target id=5-烧录工作></a><h2>5. 烧录工作</h2><p>u-boot，Linux内核和根文件系统都是需要烧录的，下面介绍如何进行这部分工作。首先将SD卡格式化，准备好要烧录的文件</p><ul><li>u-boot：u-boot.imx</li><li>内核：zImage和imx6dl-blurr.dtb</li><li>根文件系统：debian_armhf_stretch</li></ul><a class=post-dummy-target id=51-设置sd卡></a><h3>5.1 设置SD卡</h3><p>SD卡需要创建2个分区，并且在第一个分区之前预留一段空间用于保存u-boot.imx；然后第一个分区设置为fat格式，用于保存内核编译成的两个文件；第二个分区设置为ext4格式，用于保存根文件系统。</p><a class=post-dummy-target id=格式化></a><h4>格式化</h4><p>在分区之前，先将SD卡格式化（可能Windows下格式化方便一点），首先在Linux系统下插入SD卡，查看挂载位置，使用<a href=http://www.linuxidc.com/Linux/2012-06/61872.htm target=_blank>fdisk</a>命令</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo fdisk -l
</code></pre></td></tr></table></div></div><p>这个命令作用为查看磁盘使用情况的，最后那个即为我们新挂载的SD卡</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_e2b342bb2c91.png alt=查看挂载地址 class=lazyload><figcaption class=image-caption>查看挂载地址</figcaption></figure></p><p>从结果输出中可以看到SD卡，挂载位置是/dev/sdb，输入命令</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo fdisk /dev/sdb
</code></pre></td></tr></table></div></div><p>该命令含义为进入分割硬盘模式，这个命令执行结束就可以操作分区了。</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_0b65803507c5.png alt class=lazyload></figure></p><a class=post-dummy-target id=删除原有分区></a><h4>删除原有分区</h4><p>输入m可以获取帮助，显示所有可用命令。先用d 命令删除原来的分区，提示Selected partition，在后面输入要删除的分区号，回车，分区即可删除成功</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_image-20200427153230942.png alt=删除分区 class=lazyload><figcaption class=image-caption>删除分区</figcaption></figure></p><p>输入命令p查看此时的分区信息，已变成一整块的磁盘未分区，接下来开始分区</p><a class=post-dummy-target id=重新分区></a><h4>重新分区</h4><p>n命令新建分区，第一次输入p分割为主分区，分区号为1，分区的起始位置和结束位置自己算好填上去，注意分区必以sector为单位，一个sector 为512 bytes，所以不要输不是512整数倍的数。</p><p>n命令新建分区，第二次输入e分割分区，分区号为2，起始位置接着上一个分区的结束位置。</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_bd06ff3756c8.png alt=分区 class=lazyload><figcaption class=image-caption>分区</figcaption></figure></p><p>p命令查看分区信息，看是否符合预想。w命令保存退出。弹出重新插入SD卡或者重新启动Ubuntu系统，之后再次查看分区信息，这是为了更新分区表给内核，否则看不到分好的区。</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_b3f7856930ad.png alt=再次查看 class=lazyload><figcaption class=image-caption>再次查看</figcaption></figure></p><p>格式化新建的分区</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo mkfs.ext4 /dev/sdb2
</code></pre></td></tr></table></div></div><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_81816c5f55ca.png alt class=lazyload></figure></p><p>然后对两个分区格式化</p><p>输入t，选择分区1，将分区1格式化为fat，这里输入6为FAT16，c为FAT32</p><p>输入t，选择分区2，将分区2格式化为ext4格式，输入83即可</p><p>注：这里输入83格式化结束最后查看分区其实显示的是83 Linux，这就已经是ext4格式了，不要觉得自己错了，因为Linux的默认格式就是ext4</p><p>w命令保存</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_823a55d4bfef.png alt=格式化分区 class=lazyload><figcaption class=image-caption>格式化分区</figcaption></figure></p><a class=post-dummy-target id=52-烧录></a><h3>5.2 烧录</h3><a class=post-dummy-target id=u-boot></a><h4>u-boot</h4><p>执行如下命令，把u-boot弄到SD卡开头预留的那段空间</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo dd <span class=k>if</span><span class=o>=</span>u-boot.imx <span class=nv>of</span><span class=o>=</span>/dev/sdb  <span class=nv>bs</span><span class=o>=</span><span class=m>512</span> <span class=nv>seek</span><span class=o>=</span><span class=m>2</span> <span class=p>;</span>sync
</code></pre></td></tr></table></div></div><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_image-20200427154449772.png alt class=lazyload></figure></p><p><a href=http://blog.csdn.net/pugu12/article/details/47047341 target=_blank>dd命令的解释</a>，至于为什么要seek=2，跳过头两个块我现在也不懂</p><a class=post-dummy-target id=内核></a><h4>内核</h4><p>把编译好的内核的两个文件zImage和imx6dl-blurr.dtb复制到第一个分区，可以直接鼠标操作</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_image-20200427154551645.png alt class=lazyload></figure></p><a class=post-dummy-target id=根文件系统></a><h4>根文件系统</h4><p>先 fdisk -l 查看第二个分区的位置，是/dev/sdb2。把第二个分区挂载到/mnt下，这里执行成功后把文件放到/mnt下就相当于放到了U盘第二个分区</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo mount /dev/sdb2 /mnt
</code></pre></td></tr></table></div></div><p>然后就在rootfs的当前目录用cp命令复制，意思是将根文件系统的所有内容复制到挂载的目录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo cp -rf rootfs/.  /mnt
</code></pre></td></tr></table></div></div><p>执行完有必要的话取消挂载</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo umount /mnt
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=6-开发板设置></a><h2>6. 开发板设置</h2><p>确保zImage文件和imx6dl-blurr.dtb文件都已放入SD卡第一个分区，也就是FAT格式的分区中；文件系统解压到SD卡第二个分区，也就是ext4格式的分区中</p><p>注：若之前已经进行到屏幕上出现两只企鹅，此时只需要将解压好文件系统的SD卡插入开发板，上电即可进入命令行界面，若无法进入命令行界面则继续进行下列步骤，</p><ol><li><p>靠近 HDMI接口的地方有个开关，拨动开关到boot一端，设置八位红色开关为0100001</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_image-20200427155128647.png alt class=lazyload></figure></p></li><li><p>将SD卡插入SD3插槽</p></li><li><p>下好窗口调试软件putty（windows或Linux下都可），其它串口调试软件也行，用数据线连接开发板和PC（调试），开发板与屏幕，开发板与电源，开发板与键盘</p></li><li><p>打开设备管理器，找到这个设备，这时候还没有驱动，所以右键更新驱动程序，在网络上查找，第一次可能一直是寻找中，那就关掉重新打开。直到驱动装好，从设备管理器里就可以看到相应的COM口。</p></li><li><p>打开putty，选择serial，将COM1改成上面设备管理器里看到的COM号，speed改为115200，然后最下面点open</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_image-20200427155359810.png alt class=lazyload></figure></p></li><li><p>此时看到串口输出（若没有，请按开发板HDMI口旁边的RESET按钮），按回车进入调试模式，输入如下命令命令</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>setenv bootargs <span class=s1>&#39;console=ttymxc0,115200 root=/dev/mmcblk2p2 init=/sbin/init&#39;</span>
saveenv
<span class=c1>#加载镜像</span>
fatload mmc 1:1 <span class=m>12000000</span> zImage<span class=p>;</span> <span class=c1>#将SD卡分区一的镜像加载到内存地址0x12000000</span>
fatload mmc 1:1 <span class=m>11000000</span> imx6dl-blurr.dtb<span class=p>;</span>
<span class=c1>#加载Device Tree文件</span>
<span class=c1>#启动镜像</span>
bootz <span class=m>12000000</span> - <span class=m>11000000</span>
</code></pre></td></tr></table></div></div><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_image-20200427155557593.png alt class=lazyload></figure></p></li></ol><p>开发板上电，如果SD卡中此时只有u-boot和内核，屏幕上会有两只企鹅，</p><p><img src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_stickpicture.png alt=显示企鹅 style=zoom:33%></p><p>如果根文件系统也已经放进去了，那就会出现登录选项，连接键盘与开发板，输入root，这个是拿到的这个根文件系统就是这个名字，之后即可使用键盘输入各种命令与开发板交互。在命令行使用如下命令可以启动 GUI，然后就进入KDE桌面环境了，Debian系统哦</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_image-20200427160233842.png alt class=lazyload></figure></p><p>注：开发板获得读写权限的方法如下，如果模拟器中已完成此工作则不需要</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ mount rw -o remount /
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=7-使用界面></a><h2>7. 使用界面</h2><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_image-20200427160245617.png alt class=lazyload></figure></p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20180411_image-20200427160256212.png alt class=lazyload></figure></p><a class=post-dummy-target id=8-参考></a><h2>8. 参考</h2><ol><li><p><a href=http://www.cnblogs.com/qiaoqiao2003/p/3738552.html target=_blank>debian下为arm开发板创建基于debian或emdebian的根文件系统</a></p><p>这篇文章主要是提供一个思路，用工具来制作Debian的根文件系统。</p></li><li><p><a href=http://blog.csdn.net/luoqindong/article/details/42737879 target=_blank>创建基于arm的debian文件系统</a></p><p>主要是因为上面制作的根文件系统直接弄到板子上没网，所以就没法用板子的命令行安装软件，只好借助模拟器在PC上装好一些东西，比如GUI和其它一些软件。这篇文章提供一些模拟器QWMU使用的借鉴</p></li><li><p><a href=http://www.emdebian.org/emdebian/flavours.html target=_blank>Emdebian</a></p><p>这个就没什么了，主要是区别一下我们用到的嵌入式Debian的源码版本</p></li></ol></div><div class=post-copyright id=post-footer><p class=copyright-item><span>Author:&nbsp;</span>
<span>shuzang</span></p><p class=copyright-item><span>Updated on:&nbsp;</span>
<span>2020-04-27</span></p><p class=copyright-item><span>Share on:&nbsp;</span>
<span><a href="//twitter.com/share?url=https%3a%2f%2fshuzang.github.io%2f2018%2fmigration-of-debian-system%2f&text=%e7%b3%bb%e7%bb%9f%e7%a7%bb%e6%a4%8d2-Debian%e7%b3%bb%e7%bb%9f%e7%9a%84%e7%a7%bb%e6%a4%8d&via=" target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-fw"></i></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fshuzang.github.io%2f2018%2fmigration-of-debian-system%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook-square fa-fw"></i></a><a href="//reddit.com/submit?url=https%3a%2f%2fshuzang.github.io%2f2018%2fmigration-of-debian-system%2f&title=%e7%b3%bb%e7%bb%9f%e7%a7%bb%e6%a4%8d2-Debian%e7%b3%bb%e7%bb%9f%e7%9a%84%e7%a7%bb%e6%a4%8d" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-fw"></i></a></span></p><p class=copyright-item></p><p class=copyright-item></p></div><br><div class=post-info-more><section><span class=tag><a href=https://shuzang.github.io/tags/linux/><i class="fas fa-tag fa-fw"></i>&nbsp;linux</a>&nbsp;</span></section><section><span><a href=javascript:window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=https://shuzang.github.io>Home</a></span></section></div><div class=post-nav><a href=https://shuzang.github.io/2018/android-system-migration/ class=prev rel=prev title=系统移植3-Android系统移植><i class="fas fa-angle-left fa-fw"></i>系统移植3-Android系统移植</a>
<a href=https://shuzang.github.io/2018/migration-related-knowledge/ class=next rel=next title=系统移植1-移植相关知识>系统移植1-移植相关知识<i class="fas fa-angle-right fa-fw"></i></a></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright><div class=copyright-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://shuzang.github.io/about/ target=_blank>shuzang</a> | </span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a> & <a href=https://github.com/dillonzq/LoveIt target=_blank rel="external nofollow noopener noreffer">LoveIt</a></div></div></footer></div><a href=# class=dynamic-to-top id=dynamic-to-top data-scroll><span>&nbsp;</span></a>
<script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-209130979-1','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=/js/lib/jquery/jquery.slim.min.js></script><script src=/js/lib/lazysizes/lazysizes.min.js></script><script src=/js/lib/smooth-scroll/smooth-scroll.polyfills.min.js></script><script>window.scroll=new SmoothScroll('[data-scroll]',{speed:300,speedAsDuration:true});</script><link rel=stylesheet href=/css/lib/katex/katex.min.css><script src=/js/lib/katex/katex.min.js></script><script defer src=/js/lib/katex/auto-render.min.js></script><link rel=stylesheet href=/css/lib/katex/copy-tex.min.css><script defer src=/js/lib/katex/copy-tex.min.js></script><script defer src=/js/lib/katex/mhchem.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:true},{left:"\\(",right:"\\)",display:false},{left:"\\[",right:"\\]",display:true},{left:"$",right:"$",display:false},]});});</script><script src=/js/blog.min.js></script></body></html>