<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>研究记录11-新访问控制方案的实现与测试 - Shuzang's Blog</title><meta name=author content="Shuzang"><meta name=author-link content><meta name=description content="根据之前几篇文章的分析，我们对优化后的新方案进行了实现，本篇介绍新方案的一些测试与验证过程。代码可以参考 BBRAC 仓库的 truffle 分支，但是该分支包括后面添加的恶意行为检测的内容，是进行了二次完善后的代码。"><meta name=keywords content="科研记录"><meta itemprop=name content="研究记录11-新访问控制方案的实现与测试"><meta itemprop=description content="根据之前几篇文章的分析，我们对优化后的新方案进行了实现，本篇介绍新方案的一些测试与验证过程。代码可以参考 BBRAC 仓库的 truffle 分支，但是该分支包括后面添加的恶意行为检测的内容，是进行了二次完善后的代码。"><meta itemprop=datePublished content="2020-01-15T00:00:00+00:00"><meta itemprop=dateModified content="2020-11-24T00:00:00+00:00"><meta itemprop=wordCount content="6543"><meta itemprop=image content="https://shuzang.github.io/logo.png"><meta itemprop=keywords content="科研记录,"><meta property="og:title" content="研究记录11-新访问控制方案的实现与测试"><meta property="og:description" content="根据之前几篇文章的分析，我们对优化后的新方案进行了实现，本篇介绍新方案的一些测试与验证过程。代码可以参考 BBRAC 仓库的 truffle 分支，但是该分支包括后面添加的恶意行为检测的内容，是进行了二次完善后的代码。"><meta property="og:type" content="article"><meta property="og:url" content="https://shuzang.github.io/2020/optimize-the-implementation-and-testing-of-the-system/"><meta property="og:image" content="https://shuzang.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-01-15T00:00:00+00:00"><meta property="article:modified_time" content="2020-11-24T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://shuzang.github.io/logo.png"><meta name=twitter:title content="研究记录11-新访问控制方案的实现与测试"><meta name=twitter:description content="根据之前几篇文章的分析，我们对优化后的新方案进行了实现，本篇介绍新方案的一些测试与验证过程。代码可以参考 BBRAC 仓库的 truffle 分支，但是该分支包括后面添加的恶意行为检测的内容，是进行了二次完善后的代码。"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://shuzang.github.io/2020/optimize-the-implementation-and-testing-of-the-system/><link rel=prev href=https://shuzang.github.io/2020/life-weekly-2/><link rel=next href=https://shuzang.github.io/2020/life-weekly-3/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><meta name=google-site-verification content="UA-209130979-1"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"研究记录11-新访问控制方案的实现与测试","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/shuzang.github.io\/2020\/optimize-the-implementation-and-testing-of-the-system\/"},"genre":"posts","keywords":"科研记录","wordcount":6543,"url":"https:\/\/shuzang.github.io\/2020\/optimize-the-implementation-and-testing-of-the-system\/","datePublished":"2020-01-15T00:00:00+00:00","dateModified":"2020-11-24T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Shuzang"},"description":""}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=right><div class=header-title><a href=/ title="Shuzang's Blog"><img loading=lazy src=/images/avatar.png srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x" sizes=auto data-title="Shuzang's Blog" data-alt="Shuzang's Blog" class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>Shuzang's Blog</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Shuzang's Blog"><img loading=lazy src=/images/avatar.png srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x" sizes=auto data-title=/images/avatar.png data-alt=/images/avatar.png class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>Shuzang's Blog</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>研究记录11-新访问控制方案的实现与测试</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle" aria-hidden=true></i>
Shuzang</span></span>
<span class=post-category>收录于 <a href=/categories/%E7%A0%94%E7%A9%B6%E7%94%9F%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> 研究生的区块链学习之路</a></span></div><div class=post-meta-line><span title="发布于 2020-01-15 00:00:00"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden=true></i><time datetime=2020-01-15>2020-01-15</time></span>&nbsp;<span title="更新于 2020-11-24 00:00:00"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden=true></i><time datetime=2020-11-24>2020-11-24</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 6543 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 14 分钟</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-智能合约>1. 智能合约</a><ul><li><a href=#11-gas消耗统计>1.1 Gas消耗统计</a></li><li><a href=#12-合约功能说明>1.2 合约功能说明</a></li></ul></li><li><a href=#2-审计>2. 审计</a><ul><li><a href=#21-工具选取>2.1 工具选取</a></li><li><a href=#22-审计>2.2 审计</a></li><li><a href=#23-审计结果>2.3 审计结果</a></li></ul></li><li><a href=#3-系统测试>3. 系统测试</a><ul><li><a href=#31-账户设置>3.1 账户设置</a></li><li><a href=#32-安装truffle>3.2 安装Truffle</a></li><li><a href=#33-创建项目和基本配置>3.3 创建项目和基本配置</a></li><li><a href=#34-部署>3.4 部署</a></li><li><a href=#35-合约交互>3.5 合约交互</a><ul><li><a href=#truffle-contract>truffle-contract</a></li><li><a href=#web3js>web3.js</a></li><li><a href=#truffle-console>truffle console</a></li></ul></li><li><a href=#36-错误测试>3.6 错误测试</a></li><li><a href=#37-步骤总结>3.7 步骤总结</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>根据之前几篇文章的分析，我们对优化后的新方案进行了实现，本篇介绍新方案的一些测试与验证过程。代码可以参考 BBRAC 仓库的 <a href=https://github.com/shuzang/BBRAC/tree/truffle target=_blank rel="external nofollow noopener noreferrer">truffle</a> 分支，但是该分支包括后面添加的恶意行为检测的内容，是进行了二次完善后的代码。</p><h2 id=1-智能合约>1. 智能合约</h2><p>新的合约系统中依然包含Register Contract（注册合约，RC），Access Control Contract（访问控制合约，ACC）和 Judge Contract（判决合约，JC）三种合约。</p><h3 id=11-gas消耗统计>1.1 Gas消耗统计</h3><p>三个合约部署的Gas消耗统计如下</p><table><thead><tr><th>合约名</th><th>transaction cost</th><th>execution cost</th></tr></thead><tbody><tr><td>RC</td><td>3285811 gas</td><td>2457443 gas</td></tr><tr><td>ACC</td><td>5380922 gas</td><td>4047334 gas</td></tr><tr><td>JC</td><td>1375161 gas</td><td>1002445 gas</td></tr></tbody></table><p>消耗的代币数量 = gas × gasprice，gasprice的货币单位决定代币的货币单位。</p><p>在Quorum网络中，这些Gas消耗没有实际意义，因为gasprice = 0，合约部署前会判断用户是否拥有足够的gas，但不会真的扣除。</p><h3 id=12-合约功能说明>1.2 合约功能说明</h3><p>RC实现的功能大致分为两类，第一部分对合约进行管理，第二部分对属性进行管理</p><p>ACC实现的功能分为三类，第一部分对设备自身拥有的资源属性进行管理，第二部分对访问控制策略进行管理，第三部分是访问控制函数</p><p>JC实现两个函数，第一个是恶意行为判决，第二个用来查询恶意行为</p><h2 id=2-审计>2. 审计</h2><p>智能合约的安全性非常重要，行业内对智能合约进行安全性分析称之为「审计」</p><h3 id=21-工具选取>2.1 工具选取</h3><p>基本的思路是选取合适的自动审计工具来对编写完成的合约进行分析，参考了 <a href=https://learnblockchain.cn/2019/10/15/VaasMythril/ target=_blank rel="external nofollow noopener noreferrer">关于形式化验证两大工具 (Vass & Mythril) 测试对比</a> 这篇文章。</p><p>在经过大量查找后发现，商业化应用的审计工具以上文中提到的这两款（Vass 和 Mythril） 最为普及。我们首先使用成都链安的 Vass 工具进行分析，然而发现，在合约中存在内联汇编时，Vass 无法编译合约，更谈不上审计，然而内联汇编在我们的合约中是必要的，因此换用 Mythril。</p><p>工具是由以太坊开源社区所提供的安全分析工具，而建立在Mythril上的合约分析平台 <a href=https://github.com/b-mueller/awesome-mythx-smart-contract-security-tools target=_blank rel="external nofollow noopener noreferrer">MythX</a>具有更高的可用性并覆盖了更广泛的安全问题，因此最终使用MythX 完成统计分析。MythX 拥有 Remix、VScode 和 Truffle 的插件，因此无论以哪种方式编辑合约，都可以轻松的进行安全分析，但首先需要拥有 MythX 的账户。</p><p>首先在 <a href=https://dashboard.mythx.io/#/registration target=_blank rel="external nofollow noopener noreferrer">https://dashboard.mythx.io/#/registration</a> 页面使用邮箱进行注册，之后关联 MetaMask 以太坊账户，MythX 将提供一个密码供 Remix 等工具中的插件使用，也可以自己设定，但设定的密码要求长度为 6-64 位，至少一个小写字符，一个大写字符，一个数字和一个符号，该要求的原文如下：</p><div class=highlight id=id-1><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Password needs to contain: Length: 8 and 64 characters; One lowercase (a-z) and uppercase (A-Z) letter; One digit (0-9); One symbol (e.g. !&#34;#$%&amp;/()., )</span></span></code></pre></td></tr></table></div></div><h3 id=22-审计>2.2 审计</h3><p>打开 Remix 界面，在插件列表搜索 MythX，点击<code>Activate</code>将插件激活。</p><p>以 Remix 自带的示例合约 ballot.sol 为例，首先编译该合约，然后切换到 MythX 选项卡，输入之前关联到 MythX 的以太坊账户地址，MythX 提供的或自己更改后的密码，点击<code>Save</code>，然后点击<code>Analyze</code></p><p><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZdFe.png srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZdFe.png, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZdFe.png 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZdFe.png 2x" sizes=auto data-title=登录并进行分析 data-alt=登录并进行分析 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>经过一段时间的等待后，将可以在<code>Report</code>界面查看到安全分析结果</p><p><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZcef.png srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZcef.png, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZcef.png 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZcef.png 2x" sizes=auto data-title=查看分析结果 data-alt=查看分析结果 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>也可以点击上图 Log 记录中的链接进入 MythX Dashboard 查看详细结果</p><p><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZfYQ.png srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZfYQ.png, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZfYQ.png 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZfYQ.png 2x" sizes=auto data-title=详细分析结果 data-alt=详细分析结果 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>点击<code>Analysed Files</code>查看错误的详细位置与说明，然后更改源代码，重新测试，直到合约安全性达到自己想要的结果。</p><p><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZoyq.png srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZoyq.png, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZoyq.png 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZoyq.png 2x" sizes=auto data-title=迭代修改 data-alt=迭代修改 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>检测到的合约弱点(漏洞)以SWC-XXX编号的形式出现，由 <a href=https://swcregistry.io/ target=_blank rel="external nofollow noopener noreferrer">https://swcregistry.io/</a> 可查看完整的安全问题列表和解释。但是，免费的 MythX 只能检测10种安全问题，Pro版和企业版可以检测26种安全问题，具体对每种安全问题的支持程度见该页面： <a href=https://mythx.io/swc-coverage/ target=_blank rel="external nofollow noopener noreferrer">https://mythx.io/swc-coverage/</a></p><p>当前调试过程种，遇到的典型安全问题是 SWC-101:Integer Overflow and Underflow 问题，问题的具体分析可参考 <a href=https://github.com/ethereum/solidity/issues/796 target=_blank rel="external nofollow noopener noreferrer">solidity-issue #796</a></p><h3 id=23-审计结果>2.3 审计结果</h3><p>我们所编写的 RC，ACC 和 JC 三个合约在经过多次修改后，将出现的安全问题降低到了可接受的程度，如下图所示</p><p><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8leP0K.png srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8leP0K.png, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8leP0K.png 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8leP0K.png 2x" sizes=auto data-title=访问控制合约检测结果 data-alt=访问控制合约检测结果 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>三个合约出现的低级安全问题均为SWC-103: Floating Pragma ，即编译器的版本指定为一个范围，但这样具有更好的适用性，因此不进行修改</p><div class=highlight id=id-2><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl> <span class=nx>pragma</span> <span class=nx>solidity</span> <span class=o>&gt;=</span><span class=mf>0.4</span><span class=p>.</span><span class=mi>22</span> <span class=o>&lt;</span><span class=mf>0.6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><p>ACC出现的15个中级安全问题在详情列表中无法查看</p><p><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8leZpd.png srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8leZpd.png, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8leZpd.png 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8leZpd.png 2x" sizes=auto data-title=ACC的安全问题 data-alt=ACC的安全问题 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>邮件询问后官方的回复如下，字节码级别的错误如果不依靠安全工具很难检出并修正，因此我们只能忽略掉这些安全问题。</p><blockquote><p><strong>Josh Reid</strong> (MythX)</p><p>Dec 5, 11:11 AST</p><p>Hello,</p><p>Thanks for reaching out to MythX support! We are currently investigating any potential issues that may be causing these vulnerabilities to not be displayed fully, however this may also be due to the vulnerabilities being detected only on the bytecode.</p><p>Unfortunately, at this time we do no have the ability to display bytecode vulnerabilities as we cannot specify where they are. However, this is something we are looking to evaluate and differentiate on more as we go forward. I apologize for any confusion this may have caused and will be sure to update you if we find any issues as we continue to look into this. In the meantime, thanks so much for your patience and cooperation! Is there anything else I can help you with at this time?</p><p>Best,</p><p>Josh</p></blockquote><h2 id=3-系统测试>3. 系统测试</h2><p>本节介绍合约在 Quorum 区块链网络中的部署过程和访问控制的测试实现。由于论文复现的时候发现手动配置的复杂性太高，极易出错，而一旦出错就必须重来，因此这次的优化实验决定使用 truffle 进行部署测试。</p><h3 id=31-账户设置>3.1 账户设置</h3><p>按设计，Raspberry Pi 3B+ 是 lightnode1，Raspberry Pi 3B 是 linghtnode2。区块链网络启动后，四个 validator 各有 10<sup>50</sup> wei(10<sup>18</sup>是 1 ether)，但是后面加入区块链网络的两台树莓派是普通节点，余额为 0，所以首先由 node0 向两个账户分别转账 1 ether。</p><div class=highlight id=id-3><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># lightnode1账户地址为：&#34;0x77c22157a3b8840d34b8ed5975b5f2597bd6a7a2&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># lightnode2账户地址为：&#34;0xa31d40508da63fb00d7e2f4db57c3774384aa299&#34;</span></span></span></code></pre></td></tr></table></div></div><p>在 node0 的 geth console 中解锁账户，并分别向 lightnode1 和 lightnode2 转账 1 ether</p><div class=highlight id=id-4><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s2>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>eth</span><span class=p>.</span><span class=nx>getBalance</span><span class=p>(</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=mf>1e+50</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>personal</span><span class=p>.</span><span class=nx>unlockAccount</span><span class=p>(</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=nx>Unlock</span> <span class=nx>account</span> <span class=mh>0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0</span>
</span></span><span class=line><span class=cl><span class=nx>Passphrase</span><span class=o>:</span> 
</span></span><span class=line><span class=cl><span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> 
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>eth</span><span class=p>.</span><span class=nx>sendTransaction</span><span class=p>({</span><span class=nx>from</span><span class=o>:</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>to</span><span class=o>:</span><span class=s2>&#34;0x77c22157a3b8840d34b8ed5975b5f2597bd6a7a2&#34;</span><span class=p>,</span> <span class=nx>value</span><span class=o>:</span><span class=mi>1</span><span class=o>*</span><span class=mf>1e18</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;0x3ed3cbc568a64dff3c3fe4a00b87d259d2299953c47e284b19253299eb8c4725&#34;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>eth</span><span class=p>.</span><span class=nx>sendTransaction</span><span class=p>({</span><span class=nx>from</span><span class=o>:</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>to</span><span class=o>:</span><span class=s2>&#34;0xa31d40508da63fb00d7e2f4db57c3774384aa299&#34;</span><span class=p>,</span> <span class=nx>value</span><span class=o>:</span><span class=mi>1</span><span class=o>*</span><span class=mf>1e18</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;0xc9e4193164d38d94502960fcc0d1d7c2e22a9f04307145945c4ae525c6d99aee&#34;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>eth</span><span class=p>.</span><span class=nx>getBalance</span><span class=p>(</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=mf>9.9999999999999999999999999999998</span><span class=nx>e</span><span class=o>+</span><span class=mi>49</span></span></span></code></pre></td></tr></table></div></div><p>在 lightnode1 和 lightnode2 的 geth console 执行下列命令查询余额，由结果可知转账成功。</p><div class=highlight id=id-5><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>web3</span><span class=p>.</span><span class=nx>fromWei</span><span class=p>(</span><span class=nx>eth</span><span class=p>.</span><span class=nx>getBalance</span><span class=p>(</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span> <span class=s2>&#34;ether&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>1</span></span></span></code></pre></td></tr></table></div></div><p>两台树莓派担任的角色是网关，用于管理 IoT 设备，因此分别在 lightnode1 和 lightnode2 中建立新账户，用来代表 IoT 设备，由网关向各自管理的设备转账 10<sup>7</sup> wei，以供使用。</p><div class=highlight id=id-6><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=err>#</span> <span class=nx>lightnode1</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>personal</span><span class=p>.</span><span class=nx>newAccount</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>Passphrase</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=nx>Repeat</span> <span class=nx>passphrase</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;0x9a4aa696f85c6bf96733cc5385ccaf2b7ee13f17&#34;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>personal</span><span class=p>.</span><span class=nx>listAccounts</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s2>&#34;0x77c22157a3b8840d34b8ed5975b5f2597bd6a7a2&#34;</span><span class=p>,</span> <span class=s2>&#34;0x9a4aa696f85c6bf96733cc5385ccaf2b7ee13f17&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>personal</span><span class=p>.</span><span class=nx>unlockAccount</span><span class=p>(</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=nx>Unlock</span> <span class=nx>account</span> <span class=mh>0x77c22157a3b8840d34b8ed5975b5f2597bd6a7a2</span>
</span></span><span class=line><span class=cl><span class=nx>Passphrase</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>eth</span><span class=p>.</span><span class=nx>sendTransaction</span><span class=p>({</span><span class=nx>from</span><span class=o>:</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=nx>to</span><span class=o>:</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=nx>value</span><span class=o>:</span><span class=mi>1</span><span class=o>*</span><span class=mf>1e7</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;0x35bda063bc28ff3ef68b78962f427e930824390c4d1a8857c98e2dcf70485e17&#34;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>eth</span><span class=p>.</span><span class=nx>getBalance</span><span class=p>(</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=mi>10000000</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>#</span> <span class=nx>lightnode2</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>personal</span><span class=p>.</span><span class=nx>newAccount</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>Passphrase</span><span class=o>:</span> 
</span></span><span class=line><span class=cl><span class=nx>Repeat</span> <span class=nx>passphrase</span><span class=o>:</span> 
</span></span><span class=line><span class=cl><span class=s2>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>personal</span><span class=p>.</span><span class=nx>listAccounts</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s2>&#34;0xa31d40508da63fb00d7e2f4db57c3774384aa299&#34;</span><span class=p>,</span> <span class=s2>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>personal</span><span class=p>.</span><span class=nx>unlockAccount</span><span class=p>(</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=nx>Unlock</span> <span class=nx>account</span> <span class=mh>0xa31d40508da63fb00d7e2f4db57c3774384aa299</span>
</span></span><span class=line><span class=cl><span class=nx>Passphrase</span><span class=o>:</span> 
</span></span><span class=line><span class=cl><span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>eth</span><span class=p>.</span><span class=nx>sendTransaction</span><span class=p>({</span><span class=nx>from</span><span class=o>:</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=nx>to</span><span class=o>:</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=nx>value</span><span class=o>:</span><span class=mi>1</span><span class=o>*</span><span class=mf>1e7</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;0x96bc2b359219c72ff4f2ce910c27d4c76649685a8f9cfd1b879938317c9a1fe1&#34;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>eth</span><span class=p>.</span><span class=nx>getBalance</span><span class=p>(</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=mi>10000000</span></span></span></code></pre></td></tr></table></div></div><p>至此账户设置完成，接下来将 truffle 连接到 quorum 网络，部署合约</p><h3 id=32-安装truffle>3.2 安装Truffle</h3><p>在 Ubuntu18.04 下安装运行，要求 Node.js 版本高于 v8.9.4，这里全都升级到了最新</p><div class=highlight id=id-7><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo apt-get install npm
</span></span><span class=line><span class=cl>$ sudo npm install npm@latest -g
</span></span><span class=line><span class=cl>$ sudo npm install n -g
</span></span><span class=line><span class=cl>$ sudo n lts</span></span></code></pre></td></tr></table></div></div><p>安装 Truffle</p><div class=highlight id=id-8><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo npm install -g truffle
</span></span><span class=line><span class=cl>$ truffle version
</span></span><span class=line><span class=cl>Truffle v5.1.5 <span class=o>(</span>core: 5.1.5<span class=o>)</span>
</span></span><span class=line><span class=cl>Solidity v0.5.12 <span class=o>(</span>solc-js<span class=o>)</span>
</span></span><span class=line><span class=cl>Node v12.14.0
</span></span><span class=line><span class=cl>Web3.js v1.2.1</span></span></code></pre></td></tr></table></div></div><h3 id=33-创建项目和基本配置>3.3 创建项目和基本配置</h3><p>建立空项目</p><div class=highlight id=id-9><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ mkdir AC
</span></span><span class=line><span class=cl>$ <span class=nb>cd</span> AC</span></span></code></pre></td></tr></table></div></div><p>初始化项目</p><div class=highlight id=id-10><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ truffle init
</span></span><span class=line><span class=cl>✔ Preparing to download box
</span></span><span class=line><span class=cl>✔ Downloading
</span></span><span class=line><span class=cl>✔ cleaning up temporary files
</span></span><span class=line><span class=cl>✔ Setting up box</span></span></code></pre></td></tr></table></div></div><p>项目文件夹中出现相关文件说明成功，此时没有任何合约和测试代码</p><div class=highlight id=id-11><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ls
</span></span><span class=line><span class=cl>contracts  migrations  <span class=nb>test</span>  truffle-config.js</span></span></code></pre></td></tr></table></div></div><p>修改<code>truffle-config.js</code>文件进行配置，使其关联到已建立的 quorum 网络</p><div class=highlight id=id-12><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// truffle-config.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>networks</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nx>development</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>host</span><span class=o>:</span> <span class=s2>&#34;192.168.191.2&#34;</span><span class=p>,</span>  <span class=c1>// Localhost (default: none)
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=nx>port</span><span class=o>:</span> <span class=mi>22000</span><span class=p>,</span>            
</span></span><span class=line><span class=cl>       <span class=nx>network_id</span><span class=o>:</span> <span class=s2>&#34;10&#34;</span><span class=p>,</span>       
</span></span><span class=line><span class=cl>       <span class=nx>gasPrice</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nx>gas</span><span class=o>:</span> <span class=mi>100000000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;quorum&#34;</span>    
</span></span><span class=line><span class=cl>     <span class=p>},</span>
</span></span><span class=line><span class=cl>     <span class=nx>lightnode1</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>host</span><span class=o>:</span> <span class=s2>&#34;192.168.191.3&#34;</span><span class=p>,</span>   
</span></span><span class=line><span class=cl>       <span class=nx>port</span><span class=o>:</span> <span class=mi>22000</span><span class=p>,</span>            <span class=c1>// Standard Ethereum port (default: none)
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=nx>network_id</span><span class=o>:</span> <span class=s2>&#34;10&#34;</span><span class=p>,</span>       
</span></span><span class=line><span class=cl>       <span class=nx>gasPrice</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nx>gas</span><span class=o>:</span> <span class=mi>10000000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;quorum&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nx>from</span><span class=o>:</span> <span class=s2>&#34;0x9a4aa696f85c6bf96733cc5385ccaf2b7ee13f17&#34;</span><span class=p>,</span>    
</span></span><span class=line><span class=cl>       <span class=nx>provider</span><span class=o>:</span> <span class=k>new</span> <span class=nx>Web3</span><span class=p>.</span><span class=nx>providers</span><span class=p>.</span><span class=nx>WebsocketProvider</span><span class=p>(</span><span class=s2>&#34;ws://192.168.191.3:8545&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>     <span class=p>},</span>
</span></span><span class=line><span class=cl>     <span class=nx>lightnode2</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>host</span><span class=o>:</span> <span class=s2>&#34;192.168.191.4&#34;</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>       <span class=nx>port</span><span class=o>:</span> <span class=mi>22000</span><span class=p>,</span>            <span class=c1>// Standard Ethereum port (default: none)
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=nx>network_id</span><span class=o>:</span> <span class=s2>&#34;10&#34;</span><span class=p>,</span>       
</span></span><span class=line><span class=cl>       <span class=nx>gasPrice</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nx>gas</span><span class=o>:</span> <span class=mi>10000000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;quorum&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nx>from</span><span class=o>:</span> <span class=s2>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nx>provider</span><span class=o>:</span> <span class=k>new</span> <span class=nx>Web3</span><span class=p>.</span><span class=nx>providers</span><span class=p>.</span><span class=nx>WebsocketProvider</span><span class=p>(</span><span class=s2>&#34;ws://192.168.191.4:8545&#34;</span><span class=p>)</span>    
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></td></tr></table></div></div><p>建立了三个网络<code>development</code>、<code>lightnode1</code>和<code>lightnode2</code>。第一个网络<code>development</code>是 node0，用来部署 RC 和 JC，第二个网络是 lightnode1，用来部署ACC，第三个网络是 lightnode2，用来发起访问控制做演示。</p><p>因为在最后设置了<code>provider</code>，使用 websocket 进行访问，所以实际上定义的<code>host</code>和<code>port</code>两个参数是被屏蔽的，主要是因为基于 http 的远程连接好像已经被启用了，只能使用 websocket。</p><p>参数的设置主要参考了以下两篇文档</p><ul><li><a href=https://www.trufflesuite.com/docs/truffle/reference/configuration target=_blank rel="external nofollow noopener noreferrer">Truffle Configuration</a></li><li><a href=https://www.trufflesuite.com/tutorials/building-dapps-for-quorum-private-enterprise-blockchains target=_blank rel="external nofollow noopener noreferrer">Building Dapps for Quorum:Private Enterprise Blockchains</a></li></ul><h3 id=34-部署>3.4 部署</h3><p>将 RC，ACC 和 JC 三个合约放入<code>contracts</code>文件夹，然后在项目根目录执行<code>truffle compile</code>编译命令，编译所有合约，不过编译命令可以不执行，因为下面的<code>truffle migrate</code>无论是否执行过编译都会再检查一遍，如果编译过，就忽略，如果没有编译，会自动执行编译命令。</p><p>在<code>migrations</code>文件夹新建文件<code>2_deploy_contracts.js</code>，用于部署合约，编写内容如下</p><div class=highlight id=id-13><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>Register</span> <span class=o>=</span> <span class=nx>artifacts</span><span class=p>.</span><span class=nx>require</span><span class=p>(</span><span class=s2>&#34;Register&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>Judge</span> <span class=o>=</span> <span class=nx>artifacts</span><span class=p>.</span><span class=nx>require</span><span class=p>(</span><span class=s2>&#34;Judge&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>AccessControl</span> <span class=o>=</span> <span class=nx>artifacts</span><span class=p>.</span><span class=nx>require</span><span class=p>(</span><span class=s2>&#34;AccessControl&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>deployer</span><span class=p>,</span> <span class=nx>network</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>network</span> <span class=o>==</span> <span class=s2>&#34;lightnode1&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>deployer</span><span class=p>.</span><span class=nx>deploy</span><span class=p>(</span><span class=nx>AccessControl</span><span class=p>,</span> <span class=nx>Register</span><span class=p>.</span><span class=nx>address</span><span class=p>,</span> <span class=nx>Judge</span><span class=p>.</span><span class=nx>address</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>deployer</span><span class=p>.</span><span class=nx>deploy</span><span class=p>(</span><span class=nx>Register</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>deployer</span><span class=p>.</span><span class=nx>deploy</span><span class=p>(</span><span class=nx>Judge</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></td></tr></table></div></div><p>首先从 node0 部署 RC 和 JC 两个合约，<code>truffle migrate</code>命令默认连接<code>truffle-config.js</code>配置中的<code>development</code>网络，我们之前已将该网络设置为 node0 的 ip 和端口。</p><p>注：所有<code>truffle migrate</code>和<code>truffle exec</code>命令执行前都要先对相应的账户解锁，否则无法成功</p><div class=highlight id=id-14><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ truffle migrate
</span></span><span class=line><span class=cl>Compiling your contracts...
</span></span><span class=line><span class=cl><span class=o>===========================</span>
</span></span><span class=line><span class=cl>&gt; Compiling ./contracts/ACC.sol
</span></span><span class=line><span class=cl>&gt; Compiling ./contracts/JC.sol
</span></span><span class=line><span class=cl>&gt; Compiling ./contracts/Migrations.sol
</span></span><span class=line><span class=cl>&gt; Compiling ./contracts/RC.sol
</span></span><span class=line><span class=cl>&gt; Artifacts written to /home/shuzang/AC/build/contracts
</span></span><span class=line><span class=cl>&gt; Compiled successfully using:
</span></span><span class=line><span class=cl>   - solc: 0.5.12+commit.7709ece9.Emscripten.clang
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Starting migrations...
</span></span><span class=line><span class=cl><span class=o>======================</span>
</span></span><span class=line><span class=cl>&gt; Network name:    <span class=s1>&#39;development&#39;</span>
</span></span><span class=line><span class=cl>&gt; Network id:      <span class=m>10</span>
</span></span><span class=line><span class=cl>&gt; Block gas limit: 0x6dcd11a0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>1_initial_migration.js
</span></span><span class=line><span class=cl><span class=o>======================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   Deploying <span class=s1>&#39;Migrations&#39;</span>
</span></span><span class=line><span class=cl>   ----------------------
</span></span><span class=line><span class=cl>   &gt; transaction hash:    0xefb249903f558ccd7b6326f73a886356b55377a4262b34b81f5f9f2940b4347e
</span></span><span class=line><span class=cl>   &gt; Blocks: <span class=m>0</span>            Seconds: <span class=m>4</span>
</span></span><span class=line><span class=cl>   &gt; contract address:    0x4EC4F8BA5aEcA93955f67CFA58dbe4C57b21b37c
</span></span><span class=line><span class=cl>   &gt; block number:        <span class=m>2922</span>
</span></span><span class=line><span class=cl>   &gt; block timestamp:     0x5e02bcb5
</span></span><span class=line><span class=cl>   &gt; account:             0xbfFe4ff0cBd0A7590Fb71966D1E6bb1a4c2359e0
</span></span><span class=line><span class=cl>   &gt; balance:             <span class=m>99999999999999999999999999999998</span>
</span></span><span class=line><span class=cl>   &gt; gas used:            <span class=m>263741</span>
</span></span><span class=line><span class=cl>   &gt; gas price:           <span class=m>0</span> gwei
</span></span><span class=line><span class=cl>   &gt; value sent:          <span class=m>0</span> ETH
</span></span><span class=line><span class=cl>   &gt; total cost:          <span class=m>0</span> ETH
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   &gt; Saving migration to chain.
</span></span><span class=line><span class=cl>   &gt; Saving artifacts
</span></span><span class=line><span class=cl>   -------------------------------------
</span></span><span class=line><span class=cl>   &gt; Total cost:                   <span class=m>0</span> ETH
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2_deploy_contracts.js
</span></span><span class=line><span class=cl><span class=o>=====================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   Deploying <span class=s1>&#39;Register&#39;</span>
</span></span><span class=line><span class=cl>   --------------------
</span></span><span class=line><span class=cl>   &gt; transaction hash:    0xa49e8d423980248e9c03eb52ecd3b46c15209e867285d2bc718a20620f3addd2
</span></span><span class=line><span class=cl>   &gt; Blocks: <span class=m>0</span>            Seconds: <span class=m>4</span>
</span></span><span class=line><span class=cl>   &gt; contract address:    0x8980FC2bBD25958d0c72F5ba5fa3e5faF1A48c05
</span></span><span class=line><span class=cl>   &gt; block number:        <span class=m>2924</span>
</span></span><span class=line><span class=cl>   &gt; block timestamp:     0x5e02bcbf
</span></span><span class=line><span class=cl>   &gt; account:             0xbfFe4ff0cBd0A7590Fb71966D1E6bb1a4c2359e0
</span></span><span class=line><span class=cl>   &gt; balance:             <span class=m>99999999999999999999999999999998</span>
</span></span><span class=line><span class=cl>   &gt; gas used:            <span class=m>3227866</span>
</span></span><span class=line><span class=cl>   &gt; gas price:           <span class=m>0</span> gwei
</span></span><span class=line><span class=cl>   &gt; value sent:          <span class=m>0</span> ETH
</span></span><span class=line><span class=cl>   &gt; total cost:          <span class=m>0</span> ETH
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   Deploying <span class=s1>&#39;Judge&#39;</span>
</span></span><span class=line><span class=cl>   -----------------
</span></span><span class=line><span class=cl>   &gt; transaction hash:    0xaf538d559ecc72949d40bbc4d1dde67dfa535c7d5a78267c4de414b51fef4bf9
</span></span><span class=line><span class=cl>   &gt; Blocks: <span class=m>0</span>            Seconds: <span class=m>4</span>
</span></span><span class=line><span class=cl>   &gt; contract address:    0x2C2Fb0DD2440e72318Fb018f923F78Ff86541D08
</span></span><span class=line><span class=cl>   &gt; block number:        <span class=m>2925</span>
</span></span><span class=line><span class=cl>   &gt; block timestamp:     0x5e02bcc4
</span></span><span class=line><span class=cl>   &gt; account:             0xbfFe4ff0cBd0A7590Fb71966D1E6bb1a4c2359e0
</span></span><span class=line><span class=cl>   &gt; balance:             <span class=m>99999999999999999999999999999998</span>
</span></span><span class=line><span class=cl>   &gt; gas used:            <span class=m>1349320</span>
</span></span><span class=line><span class=cl>   &gt; gas price:           <span class=m>0</span> gwei
</span></span><span class=line><span class=cl>   &gt; value sent:          <span class=m>0</span> ETH
</span></span><span class=line><span class=cl>   &gt; total cost:          <span class=m>0</span> ETH
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   &gt; Saving migration to chain.
</span></span><span class=line><span class=cl>   &gt; Saving artifacts
</span></span><span class=line><span class=cl>   -------------------------------------
</span></span><span class=line><span class=cl>   &gt; Total cost:                   <span class=m>0</span> ETH
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>Summary</span>
</span></span><span class=line><span class=cl><span class=o>=======</span>
</span></span><span class=line><span class=cl>&gt; Total deployments:   <span class=m>3</span>
</span></span><span class=line><span class=cl>&gt; Final cost:          <span class=m>0</span> ETH</span></span></code></pre></td></tr></table></div></div><p>然后部署 ACC，<code>truffle migrate</code>命令指定连接网络<code>lightnode1</code>，<code>--f</code>指定部署脚本，否则因为之前该脚本已成功执行会略过，而又因为没有新的脚本而没有任何操作。<code>truffle-config.js</code>配置中的<code>lightnode1</code>网络已设置为 raspberry pi 3B+ 的 ip 和端口，默认账户设置为第二个账户，也就是新建的用于表示 IoT 设备的账户。</p><div class=highlight id=id-15><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ truffle migrate --network linghtnode1 --f <span class=m>2</span>
</span></span><span class=line><span class=cl>Compiling your contracts...
</span></span><span class=line><span class=cl><span class=o>===========================</span>
</span></span><span class=line><span class=cl>&gt; Everything is up to date, there is nothing to compile.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Starting migrations...
</span></span><span class=line><span class=cl><span class=o>======================</span>
</span></span><span class=line><span class=cl>&gt; Network name:    <span class=s1>&#39;lightnode1&#39;</span>
</span></span><span class=line><span class=cl>&gt; Network id:      <span class=m>10</span>
</span></span><span class=line><span class=cl>&gt; Block gas limit: 0x67a09e29
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2_deploy_contracts.js
</span></span><span class=line><span class=cl><span class=o>=====================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   Deploying <span class=s1>&#39;AccessControl&#39;</span>
</span></span><span class=line><span class=cl>   -------------------------
</span></span><span class=line><span class=cl>   &gt; transaction hash:    0xf49cca809ad273812de75225dcfe50b624bfe2a93fd2b44653491e8ee0edeb04
</span></span><span class=line><span class=cl>   &gt; Blocks: <span class=m>1</span>            Seconds: <span class=m>4</span>
</span></span><span class=line><span class=cl>   &gt; contract address:    0x05455fa63e5a7cb6575D75c99855cF3A1Adc72b1
</span></span><span class=line><span class=cl>   &gt; block number:        <span class=m>3160</span>
</span></span><span class=line><span class=cl>   &gt; block timestamp:     0x5e02c15b
</span></span><span class=line><span class=cl>   &gt; account:             0x9A4aa696F85C6bF96733Cc5385cCaf2b7ee13f17
</span></span><span class=line><span class=cl>   &gt; balance:             0.00000000001
</span></span><span class=line><span class=cl>   &gt; gas used:            <span class=m>5263918</span>
</span></span><span class=line><span class=cl>   &gt; gas price:           <span class=m>0</span> gwei
</span></span><span class=line><span class=cl>   &gt; value sent:          <span class=m>0</span> ETH
</span></span><span class=line><span class=cl>   &gt; total cost:          <span class=m>0</span> ETH
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   &gt; Saving migration to chain.
</span></span><span class=line><span class=cl>   &gt; Saving artifacts
</span></span><span class=line><span class=cl>   -------------------------------------
</span></span><span class=line><span class=cl>   &gt; Total cost:                   <span class=m>0</span> ETH
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>Summary</span>
</span></span><span class=line><span class=cl><span class=o>=======</span>
</span></span><span class=line><span class=cl>&gt; Total deployments:   <span class=m>1</span>
</span></span><span class=line><span class=cl>&gt; Final cost:          <span class=m>0</span> ETH</span></span></code></pre></td></tr></table></div></div><h3 id=35-合约交互>3.5 合约交互</h3><p>尝试了三种方式，在这里最后只有 truffle console 这种方式真正完成了，但理论上三种都可行，而且事实证明利用 web3.js 完成交互最方便，truffle console 还是有点繁琐。</p><h4 id=truffle-contract><del>truffle-contract</del></h4><p>truffle使用 <a href=https://github.com/trufflesuite/truffle/tree/master/packages/contract target=_blank rel="external nofollow noopener noreferrer">truffle-contract</a> 接口(原文是contract abstraction，合约抽象)来交互，truffle develop的控制台、migrate写的部署脚本和基于 JS 的单元测试等都用的是这个抽象接口。</p><p>主要方式是编写JavaScript代码，使用提供的抽象接口可以调用已部署合约的函数，无论是发起交易改变合约状态还是仅仅调用获得返回结果。</p><p>在项目根目录(和<code>trufffle-config.js</code>同文件夹)创建文件<code>JCRegister.js</code>，用于注册判决合约，文件内容如下</p><div class=highlight id=id-16><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>Register</span> <span class=o>=</span> <span class=nx>artifacts</span><span class=p>.</span><span class=nx>require</span><span class=p>(</span><span class=s2>&#34;Register&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>Judge</span> <span class=o>=</span> <span class=nx>artifacts</span><span class=p>.</span><span class=nx>require</span><span class=p>(</span><span class=s2>&#34;Judge&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=kr>export</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Getting deployed Register contract...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>Register</span><span class=p>.</span><span class=nx>deployed</span><span class=p>().</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Register Judge contract...&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>contractRegister</span><span class=p>(</span><span class=s2>&#34;Judger&#34;</span><span class=p>,</span> <span class=s2>&#34;JC&#34;</span><span class=p>,</span> <span class=s2>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span><span class=p>,</span> <span class=nx>Judge</span><span class=p>.</span><span class=nx>address</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}).</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>result</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Transaction:&#34;</span><span class=p>,</span> <span class=nx>result</span><span class=p>.</span><span class=nx>tx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Finished!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}).</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></td></tr></table></div></div><p>解锁node0账户，然后执行下列命令</p><div class=highlight id=id-17><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ truffle <span class=nb>exec</span> JCRegister.js</span></span></code></pre></td></tr></table></div></div><p><code>truffle exec</code>执行错误，错误信息如下</p><div class=highlight id=id-18><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ truffle <span class=nb>exec</span> JCRegister.js
</span></span><span class=line><span class=cl>Using network <span class=s1>&#39;development&#39;</span>.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TypeError: fn is not a <span class=k>function</span>
</span></span><span class=line><span class=cl>    at Object.exec <span class=o>(</span>/usr/local/lib/node_modules/truffle/build/webpack:/packages/require/require.js:124:1<span class=o>)</span>
</span></span><span class=line><span class=cl>    at /usr/local/lib/node_modules/truffle/build/webpack:/packages/core/lib/commands/exec.js:89:1
</span></span><span class=line><span class=cl>    at processTicksAndRejections <span class=o>(</span>internal/process/task_queues.js:93:5<span class=o>)</span>
</span></span><span class=line><span class=cl>Truffle v5.1.5 <span class=o>(</span>core: 5.1.5<span class=o>)</span>
</span></span><span class=line><span class=cl>Node v12.14.0</span></span></code></pre></td></tr></table></div></div><h4 id=web3js><del>web3.js</del></h4><p>使用 web3.js，在用户根目录建立 web3 文件夹，本地安装 web3.js 模块</p><div class=highlight id=id-19><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>cd</span> ..
</span></span><span class=line><span class=cl>$ <span class=nb>pwd</span>
</span></span><span class=line><span class=cl>/home/shuzang
</span></span><span class=line><span class=cl>$ mkdir web3 <span class=o>&amp;&amp;</span> <span class=nb>cd</span> web3
</span></span><span class=line><span class=cl>$ npm install web3
</span></span><span class=line><span class=cl>$ npm list --depth <span class=m>0</span>
</span></span><span class=line><span class=cl>/home/shuzang/web3
</span></span><span class=line><span class=cl>└── web3@1.2.4</span></span></code></pre></td></tr></table></div></div><p>创建文件<code>1_Register_JC.js</code>用于注册判决合约，命名方式参考了 truffle 的命名方式文件内容如下，ABI 过长，本文以省略号代替。</p><div class=highlight id=id-20><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>Web3</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;web3&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=k>typeof</span> <span class=nx>web3</span> <span class=o>!==</span><span class=s1>&#39;undefined&#39;</span><span class=p>){</span> <span class=c1>//检查是否已有web3实例
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>web3</span><span class=o>=</span><span class=k>new</span> <span class=nx>Web3</span><span class=p>(</span><span class=nx>web3</span><span class=p>.</span><span class=nx>currentProvider</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//否则就连接到给出节点
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>web3</span><span class=o>=</span><span class=k>new</span> <span class=nx>Web3</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>web3</span><span class=p>.</span><span class=nx>setProvider</span><span class=p>(</span><span class=k>new</span> <span class=nx>Web3</span><span class=p>.</span><span class=nx>providers</span><span class=p>.</span><span class=nx>WebsocketProvider</span><span class=p>(</span><span class=s2>&#34;ws://localhost:8545&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>rcAbi</span> <span class=o>=</span> <span class=p>[...]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>web3</span><span class=p>.</span><span class=nx>eth</span><span class=p>.</span><span class=nx>getBlock</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>result</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;connection succeed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span>
</span></span><span class=line><span class=cl>		<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;something wrong, connection failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>rcAddress</span> <span class=o>=</span> <span class=s2>&#34;0x8980FC2bBD25958d0c72F5ba5fa3e5faF1A48c05&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>jcAddress</span><span class=o>=</span> <span class=s2>&#34;0x2C2Fb0DD2440e72318Fb018f923F78Ff86541D08&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>register</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>web3</span><span class=p>.</span><span class=nx>eth</span><span class=p>.</span><span class=nx>Contract</span><span class=p>(</span><span class=nx>rcAbi</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>register</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>address</span><span class=o>=</span><span class=nx>rcAddress</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>register</span><span class=p>.</span><span class=nx>methods</span><span class=p>.</span><span class=nx>contractRegister</span><span class=p>(</span><span class=s2>&#34;Judger&#34;</span><span class=p>,</span> <span class=s2>&#34;JC&#34;</span><span class=p>,</span> <span class=s2>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span><span class=p>,</span> <span class=nx>jcAddress</span><span class=p>).</span><span class=nx>send</span><span class=p>({</span>
</span></span><span class=line><span class=cl>	<span class=nx>from</span><span class=o>:</span> <span class=s2>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>gas</span><span class=o>:</span> <span class=mi>10000000</span>
</span></span><span class=line><span class=cl><span class=p>},</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>result</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>error</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Transaction: &#39;</span> <span class=o>+</span> <span class=nx>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Finished!&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span>
</span></span><span class=line><span class=cl>		<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl> <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>register</span><span class=p>.</span><span class=nx>methods</span><span class=p>.</span><span class=nx>getContractAddr</span><span class=p>(</span><span class=s2>&#34;Judger&#34;</span><span class=p>).</span><span class=nx>call</span><span class=p>({</span>
</span></span><span class=line><span class=cl>	<span class=nx>from</span><span class=o>:</span> <span class=s2>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>gas</span><span class=o>:</span> <span class=mi>10000000</span>
</span></span><span class=line><span class=cl><span class=p>},</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>result</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>error</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Judge contract address:&#39;</span> <span class=o>+</span> <span class=nx>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span>
</span></span><span class=line><span class=cl>		<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl> <span class=p>})</span></span></span></code></pre></td></tr></table></div></div><p>web3.js执行合约交易不成功，全部陷在交易池了</p><div class=highlight id=id-21><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>txpool</span><span class=p>.</span><span class=nx>status</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>pending</span><span class=o>:</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>queued</span><span class=o>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>日志记录里提示</p><div class=highlight id=id-22><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>VM returned with error                   <span class=nv>err</span><span class=o>=</span><span class=s2>&#34;evm: execution reverted&#34;</span></span></span></code></pre></td></tr></table></div></div><h4 id=truffle-console>truffle console</h4><p>truffle的文档里提到与已部署的合约交互可以使用truffle console，故尝试</p><p>首先注册判决合约，需要在node0中进行，进入<code>development</code>网络</p><div class=highlight id=id-23><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ truffle console</span></span></code></pre></td></tr></table></div></div><p>命令执行完毕后进入<code>truffle console</code>控制台，注册合约并查询合约地址进行验证</p><div class=highlight id=id-24><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>truffle</span><span class=p>(</span><span class=nx>development</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>Register</span><span class=p>.</span><span class=nx>deployed</span><span class=p>().</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=p>{</span><span class=nx>instance</span><span class=p>.</span><span class=nx>contractRegister</span><span class=p>(</span><span class=s2>&#34;Judger&#34;</span><span class=p>,</span> <span class=s2>&#34;JC&#34;</span><span class=p>,</span> <span class=s2>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span><span class=p>,</span> <span class=nx>Judge</span><span class=p>.</span><span class=nx>address</span><span class=p>);})</span>
</span></span><span class=line><span class=cl><span class=kc>undefined</span>
</span></span><span class=line><span class=cl><span class=nx>truffle</span><span class=p>(</span><span class=nx>development</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>Register</span><span class=p>.</span><span class=nx>deployed</span><span class=p>().</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=p>{</span><span class=k>return</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>getContractAddr</span><span class=p>(</span><span class=s2>&#34;Judger&#34;</span><span class=p>);})</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;0x2C2Fb0DD2440e72318Fb018f923F78Ff86541D08&#39;</span></span></span></code></pre></td></tr></table></div></div><p>退出重新执行<code>truffle console</code>命令，进入<code>lightnode2</code>网络</p><div class=highlight id=id-25><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>truffle<span class=o>(</span>development<span class=o>)</span>&gt; .exit
</span></span><span class=line><span class=cl>$ truffle console --network lightnode2</span></span></code></pre></td></tr></table></div></div><p>进入<code>lightnode2</code>的<code>truffle console</code>控制台，注册设备相关属性，然后查询属性进行验证</p><div class=highlight id=id-26><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode2</span><span class=p>)</span><span class=o>&gt;</span> <span class=kd>let</span> <span class=nx>instance</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>Register</span><span class=p>.</span><span class=nx>deployed</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kc>undefined</span>
</span></span><span class=line><span class=cl><span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode2</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>subjectRegister</span><span class=p>(</span><span class=s2>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span><span class=p>,</span> <span class=s2>&#34;0xa31d40508da63fb00d7e2f4db57c3774384aa299&#34;</span><span class=p>,</span> <span class=s2>&#34;thermostat&#34;</span><span class=p>,</span> <span class=s2>&#34;subject&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode2</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>getAttribute</span><span class=p>(</span><span class=s2>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span><span class=p>,</span> <span class=s2>&#34;deviceType&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;thermostat&#39;</span>
</span></span><span class=line><span class=cl><span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode2</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>getAttribute</span><span class=p>(</span><span class=s2>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span><span class=p>,</span> <span class=s2>&#34;deviceRole&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;subject&#39;</span></span></span></code></pre></td></tr></table></div></div><p>退出<code>lightnode2</code>的控制台，进入<code>lightnode1</code>的控制台</p><div class=highlight id=id-27><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>truffle<span class=o>(</span>lightnode2<span class=o>)</span>&gt; .exit
</span></span><span class=line><span class=cl>$ truffle console --network lightnode1</span></span></code></pre></td></tr></table></div></div><p>首先在RC中注册ACC</p><div class=highlight id=id-28><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode1</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>Register</span><span class=p>.</span><span class=nx>deployed</span><span class=p>().</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=p>{</span><span class=nx>instance</span><span class=p>.</span><span class=nx>contractRegister</span><span class=p>(</span><span class=s2>&#34;Temperature_Sensor1&#34;</span><span class=p>,</span> <span class=s2>&#34;ACC&#34;</span><span class=p>,</span> <span class=s2>&#34;0x9a4aa696f85c6bf96733cc5385ccaf2b7ee13f17&#34;</span><span class=p>,</span> <span class=nx>AccessControl</span><span class=p>.</span><span class=nx>address</span><span class=p>);})</span>
</span></span><span class=line><span class=cl><span class=kc>undefined</span>
</span></span><span class=line><span class=cl><span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode1</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>Register</span><span class=p>.</span><span class=nx>deployed</span><span class=p>().</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=p>{</span><span class=k>return</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>getContractAddr</span><span class=p>(</span><span class=s2>&#34;Temperature_Sensor1&#34;</span><span class=p>);})</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;0x05455fa63e5a7cb6575D75c99855cF3A1Adc72b1&#39;</span></span></span></code></pre></td></tr></table></div></div><p>然后在ACC中注册资源属性，并查询属性进行验证</p><div class=highlight id=id-29><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode1</span><span class=p>)</span><span class=o>&gt;</span> <span class=kd>let</span> <span class=nx>instance</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>AccessControl</span><span class=p>.</span><span class=nx>deployed</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kc>undefined</span>
</span></span><span class=line><span class=cl><span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode1</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>resourceAttrAdd</span><span class=p>(</span><span class=s2>&#34;data&#34;</span><span class=p>,</span> <span class=s2>&#34;currentTemperature&#34;</span><span class=p>,</span> <span class=s2>&#34;23&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode1</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>getResourceAttr</span><span class=p>(</span><span class=s2>&#34;data&#34;</span><span class=p>,</span> <span class=s2>&#34;currentTemperature&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;23&#39;</span></span></span></code></pre></td></tr></table></div></div><p>接下来针对已注册的属性，在ACC中设置访问控制策略，并查询策略进行验证</p><div class=highlight id=id-30><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode1</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>policyAdd</span><span class=p>(</span><span class=s2>&#34;data&#34;</span><span class=p>,</span> <span class=s2>&#34;read&#34;</span><span class=p>,</span> <span class=s2>&#34;subject&#34;</span><span class=p>,</span> <span class=s2>&#34;deviceType&#34;</span><span class=p>,</span> <span class=s2>&#34;=&#34;</span><span class=p>,</span> <span class=s2>&#34;thermostat&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode1</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>getPolicy</span><span class=p>(</span><span class=s2>&#34;data&#34;</span><span class=p>,</span> <span class=s2>&#34;read&#34;</span><span class=p>,</span> <span class=s2>&#34;deviceType&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>Result</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s1>&#39;0&#39;</span><span class=o>:</span> <span class=s1>&#39;subject&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s1>&#39;1&#39;</span><span class=o>:</span> <span class=s1>&#39;deviceType&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s1>&#39;2&#39;</span><span class=o>:</span> <span class=s1>&#39;=&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s1>&#39;3&#39;</span><span class=o>:</span> <span class=s1>&#39;thermostat&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>_attrOwner</span><span class=o>:</span> <span class=s1>&#39;subject&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>_attrName_</span><span class=o>:</span> <span class=s1>&#39;deviceType&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>_operator</span><span class=o>:</span> <span class=s1>&#39;=&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>_attrValue</span><span class=o>:</span> <span class=s1>&#39;thermostat&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>最后发起访问控制请求和监听依然使用web3.js完成，切换到web3目录下，首先新建<code>test.js</code>测试是否可使用，测试脚本内容如下</p><div class=highlight id=id-31><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>Web3</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;web3&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=k>typeof</span> <span class=nx>web3</span> <span class=o>!==</span><span class=s1>&#39;undefined&#39;</span><span class=p>){</span> <span class=c1>//检查是否已有web3实例
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>web3</span><span class=o>=</span><span class=k>new</span> <span class=nx>Web3</span><span class=p>(</span><span class=nx>web3</span><span class=p>.</span><span class=nx>currentProvider</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//否则就连接到给出节点
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>web3</span><span class=o>=</span><span class=k>new</span> <span class=nx>Web3</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>web3</span><span class=p>.</span><span class=nx>setProvider</span><span class=p>(</span><span class=k>new</span> <span class=nx>Web3</span><span class=p>.</span><span class=nx>providers</span><span class=p>.</span><span class=nx>WebsocketProvider</span><span class=p>(</span><span class=s2>&#34;ws://localhost:8545&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>connect</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>web3</span><span class=p>.</span><span class=nx>eth</span><span class=p>.</span><span class=nx>getBlock</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>result</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;connection succeed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;something wrong, connection failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>getAccount</span> <span class=o>=</span> <span class=kr>async</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>connect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>account0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>web3</span><span class=p>.</span><span class=nx>eth</span><span class=p>.</span><span class=nx>getAccounts</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>result</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>error</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=nx>account0</span><span class=o>=</span><span class=nx>result</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=c1>//console.log(account0);
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;accounts:&#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;failed to get Accoutns&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>getAccount</span><span class=p>().</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>web3</span><span class=p>.</span><span class=nx>eth</span><span class=p>.</span><span class=nx>getBalance</span><span class=p>(</span><span class=s2>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span><span class=p>).</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>balance</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;balance:&#39;</span><span class=p>,</span><span class=nx>balance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;test passed!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></td></tr></table></div></div><p>测试结果如下，说明没有问题</p><div class=highlight id=id-32><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ node test.js
</span></span><span class=line><span class=cl>connection succeed
</span></span><span class=line><span class=cl>accounts:0xbfFe4ff0cBd0A7590Fb71966D1E6bb1a4c2359e0
</span></span><span class=line><span class=cl>balance: <span class=m>99999999999999999999999999999998000000000000000000</span>
</span></span><span class=line><span class=cl><span class=nb>test</span> passed！</span></span></code></pre></td></tr></table></div></div><p>在 web3 目录下新建<code>requester.js</code>文件和<code>monitor.js</code>文件，前者用来发起访问控制请求，后者用来监听访问控制触发的事件</p><p><code>requester.js</code>的内容如下，通过 websocket 连接 lightnode2，发起访问控制请求</p><div class=highlight id=id-33><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>Web3</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;web3&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>readline</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;readline&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>web3</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Web3</span><span class=p>(</span><span class=nx>Web3</span><span class=p>.</span><span class=nx>givenProvider</span> <span class=o>||</span> <span class=s2>&#34;ws://192.168.191.4:8545&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>accAbi</span> <span class=o>=</span> <span class=p>[...];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>accAddr</span> <span class=o>=</span> <span class=s2>&#34;0xb29094a4DE9c2E22b598b39fE38860b9117340A6&#34;</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>myACC</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>web3</span><span class=p>.</span><span class=nx>eth</span><span class=p>.</span><span class=nx>Contract</span><span class=p>(</span><span class=nx>accAbi</span><span class=p>,</span> <span class=nx>accAddr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>previousTxHash</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>currentTxHash</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>rl</span> <span class=o>=</span> <span class=nx>readline</span><span class=p>.</span><span class=nx>createInterface</span><span class=p>({</span>
</span></span><span class=line><span class=cl>	<span class=nx>input</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>stdin</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>output</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>stdout</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>prompt</span><span class=o>:</span> <span class=s1>&#39;Send access request?(y/n)&#39;</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>rl</span><span class=p>.</span><span class=nx>prompt</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>rl</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;line&#39;</span><span class=p>,(</span><span class=nx>answer</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=s1>&#39;y&#39;</span> <span class=o>==</span> <span class=nx>answer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>myACC</span><span class=p>.</span><span class=nx>methods</span><span class=p>.</span><span class=nx>accessControl</span><span class=p>(</span><span class=s2>&#34;data&#34;</span><span class=p>,</span> <span class=s2>&#34;read&#34;</span><span class=p>).</span><span class=nx>send</span><span class=p>({</span>
</span></span><span class=line><span class=cl>			<span class=nx>from</span><span class=o>:</span> <span class=s2>&#34;0xbd93271c5d2ccacdc307d1825614d5557ad6e0fd&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>gas</span><span class=o>:</span> <span class=mi>10000000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>gasPrice</span><span class=o>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span><span class=kd>function</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span><span class=nx>result</span><span class=p>){</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>error</span><span class=p>){</span>
</span></span><span class=line><span class=cl>				<span class=nx>currentTxHash</span> <span class=o>=</span> <span class=nx>result</span>
</span></span><span class=line><span class=cl>				<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;currentTxHash: &#34;</span><span class=p>,</span> <span class=nx>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>myACC</span><span class=p>.</span><span class=nx>events</span><span class=p>.</span><span class=nx>ReturnAccessResult</span><span class=p>({</span>
</span></span><span class=line><span class=cl>			<span class=nx>fromBlock</span><span class=o>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span> <span class=kd>function</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>result</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span><span class=p>(</span><span class=nx>previousTxHash</span> <span class=o>!=</span> <span class=nx>result</span><span class=p>.</span><span class=nx>transactionHash</span> <span class=o>&amp;&amp;</span> <span class=nx>currentTxHash</span> <span class=o>==</span> <span class=nx>result</span><span class=p>.</span><span class=nx>transactionHash</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Contract: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>address</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Block Number: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>blockNumber</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Tx Hash: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>transactionHash</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Block Hash: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>blockHash</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Time: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>returnValues</span><span class=p>.</span><span class=nx>_time</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Message: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>returnValues</span><span class=p>.</span><span class=nx>_errmsg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Result: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>returnValues</span><span class=p>.</span><span class=nx>_result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>returnValues</span><span class=p>.</span><span class=nx>_penalty</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Requests are blocked for &#34;</span> <span class=o>+</span> <span class=nx>result</span><span class=p>.</span><span class=nx>returnValues</span><span class=p>.</span><span class=nx>_penalty</span> <span class=o>+</span><span class=s2>&#34;seconds!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;\n&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=nx>previousTxHash</span> <span class=o>=</span> <span class=nx>result</span><span class=p>.</span><span class=nx>transactionHash</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=nx>rl</span><span class=p>.</span><span class=nx>prompt</span><span class=p>();</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;access request doesn&#39;t send!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>rl</span><span class=p>.</span><span class=nx>prompt</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}).</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;close&#39;</span><span class=p>,()</span> <span class=p>=&gt;{</span>
</span></span><span class=line><span class=cl>	<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;All actions had executed!&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nx>process</span><span class=p>.</span><span class=nx>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></td></tr></table></div></div><p><code>monitor.js</code>的内容如下，由 lightnode1 发起，用于监听返回的事件</p><div class=highlight id=id-34><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>Web3</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;web3&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>web3</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Web3</span><span class=p>(</span><span class=nx>Web3</span><span class=p>.</span><span class=nx>givenProvider</span> <span class=o>||</span> <span class=s2>&#34;ws://192.168.191.3:8545&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>accAbi</span> <span class=o>=</span> <span class=p>[...];</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>accAddr</span> <span class=o>=</span> <span class=s2>&#34;0xb29094a4DE9c2E22b598b39fE38860b9117340A6&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>myACC</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>web3</span><span class=p>.</span><span class=nx>eth</span><span class=p>.</span><span class=nx>Contract</span><span class=p>(</span><span class=nx>accAbi</span><span class=p>,</span> <span class=nx>accAddr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>myACC</span><span class=p>.</span><span class=nx>events</span><span class=p>.</span><span class=nx>ReturnAccessResult</span><span class=p>({</span>
</span></span><span class=line><span class=cl>	<span class=nx>fromBlock</span><span class=o>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=p>},</span> <span class=kd>function</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>result</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Contract: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>address</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Block Number: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>blockNumber</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Tx Hash: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>transactionHash</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Block Hash: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>blockHash</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Time: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>returnValues</span><span class=p>.</span><span class=nx>_time</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Message: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>returnValues</span><span class=p>.</span><span class=nx>_errmsg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Result: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>returnValues</span><span class=p>.</span><span class=nx>_result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>returnValues</span><span class=p>.</span><span class=nx>_penalty</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Requests are blocked for &#34;</span> <span class=o>+</span> <span class=nx>result</span><span class=p>.</span><span class=nx>returnValues</span><span class=p>.</span><span class=nx>_penalty</span> <span class=o>+</span><span class=s2>&#34;seconds!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;\n&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></td></tr></table></div></div><p>实验结果如下</p><p><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81cdmj.png srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81cdmj.png, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81cdmj.png 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81cdmj.png 2x" sizes=auto data-title="request access authorized" data-alt="request access authorized" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81c6pT.png srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81c6pT.png, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81c6pT.png 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81c6pT.png 2x" sizes=auto data-title="monitor access authorized" data-alt="monitor access authorized" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81gC38.png srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81gC38.png, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81gC38.png 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81gC38.png 2x" sizes=auto data-title="request blocked" data-alt="request blocked" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81g8b9.png srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81g8b9.png, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81g8b9.png 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81g8b9.png 2x" sizes=auto data-title="monitor request blocked" data-alt="monitor request blocked" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><h3 id=36-错误测试>3.6 错误测试</h3><p>之前的实验验证的是访问权限被授予的情况，现在测试被拒绝的情况</p><p>在 lightnode2 建立新的IoT设备账户，这次代表摄像头(Camera)，</p><div class=highlight id=id-35><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt; personal.newAccount<span class=o>()</span>
</span></span><span class=line><span class=cl>Passphrase: 
</span></span><span class=line><span class=cl>Repeat passphrase: 
</span></span><span class=line><span class=cl><span class=s2>&#34;0x42b97b26ed5f53693bcc9b58ad8c724718ea0a15&#34;</span>
</span></span><span class=line><span class=cl>&gt; personal.listAccounts
</span></span><span class=line><span class=cl><span class=o>[</span><span class=s2>&#34;0xa31d40508da63fb00d7e2f4db57c3774384aa299&#34;</span>, <span class=s2>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span>, <span class=s2>&#34;0x42b97b26ed5f53693bcc9b58ad8c724718ea0a15&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>&gt; personal.unlockAccount<span class=o>(</span>eth.accounts<span class=o>[</span>0<span class=o>])</span>
</span></span><span class=line><span class=cl>Unlock account 0xa31d40508da63fb00d7e2f4db57c3774384aa299
</span></span><span class=line><span class=cl>Passphrase: 
</span></span><span class=line><span class=cl><span class=nb>true</span>
</span></span><span class=line><span class=cl>&gt; eth.sendTransaction<span class=o>({</span>from:eth.accounts<span class=o>[</span>0<span class=o>]</span>,to:eth.accounts<span class=o>[</span>2<span class=o>]</span>,value:1*1e7<span class=o>})</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;0x9f36de89d44db23e63e4fa0d3135d1c17e800cca73f0661ae276f20c0e3d1902&#34;</span>
</span></span><span class=line><span class=cl>&gt; eth.getBalance<span class=o>(</span>eth.accounts<span class=o>[</span>2<span class=o>])</span>
</span></span><span class=line><span class=cl><span class=m>10000000</span></span></span></code></pre></td></tr></table></div></div><p>修改<code>truffle-config.js</code>文件中 lightnode2 网络的执行账户为新建立的账户</p><div class=highlight id=id-36><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=nx>lightnode2</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>host</span><span class=o>:</span> <span class=s2>&#34;192.168.191.4&#34;</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>  <span class=nx>port</span><span class=o>:</span> <span class=mi>22000</span><span class=p>,</span>            <span class=c1>// Standard Ethereum port (default: none)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>network_id</span><span class=o>:</span> <span class=s2>&#34;10&#34;</span><span class=p>,</span>       
</span></span><span class=line><span class=cl>  <span class=nx>gasPrice</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>gas</span><span class=o>:</span> <span class=mi>10000000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;quorum&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>from</span><span class=o>:</span> <span class=s2>&#34;0x42b97b26ed5f53693bcc9b58ad8c724718ea0a15&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=p>...</span></span></span></code></pre></td></tr></table></div></div><p>进入<code>lightnode2</code>的 truffle console</p><div class=highlight id=id-37><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>cd</span> AC
</span></span><span class=line><span class=cl>$ truffle console --network lightnode2</span></span></code></pre></td></tr></table></div></div><p>注册新设备的属性</p><div class=highlight id=id-38><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode2</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>Register</span><span class=p>.</span><span class=nx>deployed</span><span class=p>().</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=p>{</span><span class=nx>instance</span><span class=p>.</span><span class=nx>subjectRegister</span><span class=p>(</span><span class=s2>&#34;0x42b97b26ed5f53693bcc9b58ad8c724718ea0a15&#34;</span><span class=p>,</span><span class=s2>&#34;0xa31d40508da63fb00d7e2f4db57c3774384aa299&#34;</span><span class=p>,</span> <span class=s2>&#34;camera&#34;</span><span class=p>,</span> <span class=s2>&#34;subject&#34;</span><span class=p>);})</span>
</span></span><span class=line><span class=cl><span class=kc>undefined</span>
</span></span><span class=line><span class=cl><span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode2</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>Register</span><span class=p>.</span><span class=nx>deployed</span><span class=p>().</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=p>{</span><span class=nx>instance</span><span class=p>.</span><span class=nx>getAttribute</span><span class=p>(</span><span class=s2>&#34;0x42b97b26ed5f53693bcc9b58ad8c724718ea0a15&#34;</span><span class=p>,</span><span class=s2>&#34;deviceType&#34;</span><span class=p>);})</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;camera&#39;</span>
</span></span><span class=line><span class=cl><span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode2</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>Register</span><span class=p>.</span><span class=nx>deployed</span><span class=p>().</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=p>{</span><span class=nx>instance</span><span class=p>.</span><span class=nx>getAttribute</span><span class=p>(</span><span class=s2>&#34;0x42b97b26ed5f53693bcc9b58ad8c724718ea0a15&#34;</span><span class=p>,</span><span class=s2>&#34;deviceRole&#34;</span><span class=p>);})</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;subject&#39;</span></span></span></code></pre></td></tr></table></div></div><p>建立<code>requester2.js</code>，内容和<code>requester.js</code>相似，只是发起访问控制的是<code>lightnode2</code>新建立的<code>camera</code>设备账户，也就是说与requester.js的不同仅在于发起访问控制的账户</p><p>错误测试的结果如下</p><p><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81gQvF.png srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81gQvF.png, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81gQvF.png 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81gQvF.png 2x" sizes=auto data-title="request static check failed" data-alt="request static check failed" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81gK3T.png srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81gK3T.png, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81gK3T.png 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81gK3T.png 2x" sizes=auto data-title="monitor static check failed" data-alt="monitor static check failed" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><h3 id=37-步骤总结>3.7 步骤总结</h3><p>总结一下本篇中需要做的事情</p><ol><li>node0 部署RC，获取RC合约地址</li><li>node0 部署JC，传入参数base=2、interval=3，获取JC的合约地址</li><li>JC 合约在RC中注册</li><li>node0 分别转给lightnode1和lightnode2 1 ether</li><li>lightnode1 新建IoT设备账户，从第一个账户向该账户转入1000 0000wei</li><li>lightnode2 新建两个IoT设备账户，从第一个账户分别向这两个账户转入1000 0000wei</li><li>lightnode2 的两个IoT设备账户在RC中注册设备属性(事实上所有节点都应注册设备属性，这里是因为实验只需要它们两个发起访问控制)</li><li>lightnode1 的IoT设备账户部署ACC，传入RC和JC的合约地址，获取ACC的合约地址</li><li>lightnode1 在RC中注册ACC</li><li>lightnode1 在ACC中注册资源属性，设置访问控制策略</li><li>lingtnode2 的两个IoT设备通过调用ACC向lightnode1的IoT设备发起访问控制</li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2020-11-24 00:00:00">更新于 2020-11-24&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/2020/optimize-the-implementation-and-testing-of-the-system/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://shuzang.github.io/2020/optimize-the-implementation-and-testing-of-the-system/ data-title=研究记录11-新访问控制方案的实现与测试 data-hashtags=科研记录><i class="fa-brands fa-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://shuzang.github.io/2020/optimize-the-implementation-and-testing-of-the-system/ data-hashtag=科研记录><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://shuzang.github.io/2020/optimize-the-implementation-and-testing-of-the-system/ data-title=研究记录11-新访问控制方案的实现与测试><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/%E7%A7%91%E7%A0%94%E8%AE%B0%E5%BD%95/ class=post-tag>科研记录</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/2020/life-weekly-2/ class=post-nav-item rel=prev title="书藏的生活周刊第 2 期 (20200110)"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>书藏的生活周刊第 2 期 (20200110)</a>
<a href=/2020/life-weekly-3/ class=post-nav-item rel=next title="书藏的生活周刊第 3 期 (20200117)">书藏的生活周刊第 3 期 (20200117)<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.117.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.2.18"><img class=fixit-icon src=/fixit.min.svg alt="FixIt logo">&nbsp;FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=/>Shuzang</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div><div class="footer-line visitor"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class="variant-numeric d-none">0%</span></div></div><a href=https://github.com/shuzang title="View source on GitHub" target=_blank rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;top:0></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><link rel=stylesheet href=/lib/pace/themes/blue/pace-theme-minimal.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/twemoji/twemoji.min.js defer></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script src=/lib/pace/pace.min.js async defer></script><script>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{enable:!1},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:30,threshold:.3,type:"fuse",useExtendedSearch:!1},twemoji:!0}</script><script src=/js/theme.min.js defer></script></body></html>