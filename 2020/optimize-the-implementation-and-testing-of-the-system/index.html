<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>研究记录11-新访问控制方案的实现与测试 | Shuzang's Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=Description content="书藏的个人博客，包括Golang、数据结构、算法的学习记录，各类生活技能的学习，每周五发布一期自己的生活周刊"><link rel=prev href=https://shuzang.github.io/2020/life-weekly-2/><link rel=next href=https://shuzang.github.io/2020/life-weekly-3/><link rel=canonical href=https://shuzang.github.io/2020/optimize-the-implementation-and-testing-of-the-system/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta name=twitter:card content="summary"><meta name=twitter:title content="研究记录11-新访问控制方案的实现与测试"><meta name=twitter:description content="根据之前几篇文章的分析，我们对优化后的新方案进行了实现，本篇介绍新方案的一些测试与验证过程。代码可以参考 BBRAC 仓库的 truffle 分支，但是该分支包括后面添加的恶意行为检测的内容，是进行了二次完善后的代码。"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"研究记录11-新访问控制方案的实现与测试","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/shuzang.github.io\/2020\/optimize-the-implementation-and-testing-of-the-system\/"},"image":{"@type":"ImageObject","url":"https:\/\/shuzang.github.io\/cover.png","width":800,"height":600},"genre":"posts","keywords":"科研记录","wordcount":6605,"url":"https:\/\/shuzang.github.io\/2020\/optimize-the-implementation-and-testing-of-the-system\/","datePublished":"2020-01-15T00:00:00\x2b00:00","dateModified":"2020-11-24T00:00:00\x2b00:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"shuzang","logo":{"@type":"ImageObject","url":"https:\/\/shuzang.github.io\/logo.png","width":127,"height":40}},"description":""}</script><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/lib/fontawesome-free/all.min.css></head><body><script>window.isDark=(window.localStorage&&window.localStorage.getItem('theme'))==='dark';window.isDark&&document.body.classList.add('dark-theme');</script><div class=wrapper><nav class=navbar><div class=top-scroll-bar></div><div class=navbar-container><div class="navbar-header animated bounceIn"><a href=https://shuzang.github.io>Shuzang's Blog</a></div><div class=navbar-menu><a class=menu-item href=https://shuzang.github.io/posts>Posts</a><a class=menu-item href=https://shuzang.github.io/tags>Tags</a><a class=menu-item href=https://shuzang.github.io/categories>Categories</a><a class=menu-item href=https://shuzang.github.io/about>About</a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><nav class=navbar-mobile><div class=top-scroll-bar></div><div class=navbar-container><div class=navbar-header><div class="navbar-header-title animated bounceIn"><a href=https://shuzang.github.io>Shuzang's Blog</a></div><div class=menu-toggle id=menu-toggle><span></span><span></span><span></span></div></div><div class=navbar-menu id=mobile-menu><a class=menu-item href=https://shuzang.github.io/posts>Posts</a><a class=menu-item href=https://shuzang.github.io/tags>Tags</a><a class=menu-item href=https://shuzang.github.io/categories>Categories</a><a class=menu-item href=https://shuzang.github.io/about>About</a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><main class=main><div class=container><article class=page><h1 class="post-title animated flipInX">研究记录11-新访问控制方案的实现与测试</h1><div class=post-meta><i class="far fa-calendar-alt fa-fw"></i>published on&nbsp;<time datetime=2020-01-15>2020-01-15</time>&nbsp;
<i class="fas fa-pencil-alt fa-fw"></i>about 6605 words&nbsp;<span class=post-category><i class="far fa-folder fa-fw"></i>included in&nbsp;<a href=https://shuzang.github.io/categories/%E7%A0%94%E7%A9%B6%E7%94%9F%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF/>研究生的区块链学习之路</a>&nbsp;</span></div><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#1-智能合约>1. 智能合约</a><ul><li><a href=#11-gas消耗统计>1.1 Gas消耗统计</a></li><li><a href=#12-合约功能说明>1.2 合约功能说明</a></li></ul></li><li><a href=#2-审计>2. 审计</a><ul><li><a href=#21-工具选取>2.1 工具选取</a></li><li><a href=#22-审计>2.2 审计</a></li><li><a href=#23-审计结果>2.3 审计结果</a></li></ul></li><li><a href=#3-系统测试>3. 系统测试</a><ul><li><a href=#31-账户设置>3.1 账户设置</a></li><li><a href=#32-安装truffle>3.2 安装Truffle</a></li><li><a href=#33-创建项目和基本配置>3.3 创建项目和基本配置</a></li><li><a href=#34-部署>3.4 部署</a></li><li><a href=#35-合约交互>3.5 合约交互</a><ul><li><a href=#truffle-contract>truffle-contract</a></li><li><a href=#web3js>web3.js</a></li><li><a href=#truffle-console>truffle console</a></li></ul></li><li><a href=#36-错误测试>3.6 错误测试</a></li><li><a href=#37-步骤总结>3.7 步骤总结</a></li></ul></li></ul></nav></div></div><div class=post-toc-mobile id=post-toc-mobile><details><summary><div class=post-toc-title><span>Contents</span>
<span><i class="details icon fas fa-angle-down"></i></span></div></summary><div class=post-toc-content><nav id=TableOfContentsMobile><ul><li><a href=#1-智能合约>1. 智能合约</a><ul><li><a href=#11-gas消耗统计>1.1 Gas消耗统计</a></li><li><a href=#12-合约功能说明>1.2 合约功能说明</a></li></ul></li><li><a href=#2-审计>2. 审计</a><ul><li><a href=#21-工具选取>2.1 工具选取</a></li><li><a href=#22-审计>2.2 审计</a></li><li><a href=#23-审计结果>2.3 审计结果</a></li></ul></li><li><a href=#3-系统测试>3. 系统测试</a><ul><li><a href=#31-账户设置>3.1 账户设置</a></li><li><a href=#32-安装truffle>3.2 安装Truffle</a></li><li><a href=#33-创建项目和基本配置>3.3 创建项目和基本配置</a></li><li><a href=#34-部署>3.4 部署</a></li><li><a href=#35-合约交互>3.5 合约交互</a><ul><li><a href=#truffle-contract>truffle-contract</a></li><li><a href=#web3js>web3.js</a></li><li><a href=#truffle-console>truffle console</a></li></ul></li><li><a href=#36-错误测试>3.6 错误测试</a></li><li><a href=#37-步骤总结>3.7 步骤总结</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>根据之前几篇文章的分析，我们对优化后的新方案进行了实现，本篇介绍新方案的一些测试与验证过程。代码可以参考 BBRAC 仓库的 <a href=https://github.com/shuzang/BBRAC/tree/truffle target=_blank>truffle</a> 分支，但是该分支包括后面添加的恶意行为检测的内容，是进行了二次完善后的代码。</p><a class=post-dummy-target id=1-智能合约></a><h2>1. 智能合约</h2><p>新的合约系统中依然包含Register Contract（注册合约，RC），Access Control Contract（访问控制合约，ACC）和 Judge Contract（判决合约，JC）三种合约。</p><a class=post-dummy-target id=11-gas消耗统计></a><h3>1.1 Gas消耗统计</h3><p>三个合约部署的Gas消耗统计如下</p><table><thead><tr><th>合约名</th><th>transaction cost</th><th>execution cost</th></tr></thead><tbody><tr><td>RC</td><td>3285811 gas</td><td>2457443 gas</td></tr><tr><td>ACC</td><td>5380922 gas</td><td>4047334 gas</td></tr><tr><td>JC</td><td>1375161 gas</td><td>1002445 gas</td></tr></tbody></table><p>消耗的代币数量 = gas × gasprice，gasprice的货币单位决定代币的货币单位。</p><p>在Quorum网络中，这些Gas消耗没有实际意义，因为gasprice = 0，合约部署前会判断用户是否拥有足够的gas，但不会真的扣除。</p><a class=post-dummy-target id=12-合约功能说明></a><h3>1.2 合约功能说明</h3><p>RC实现的功能大致分为两类，第一部分对合约进行管理，第二部分对属性进行管理</p><p>ACC实现的功能分为三类，第一部分对设备自身拥有的资源属性进行管理，第二部分对访问控制策略进行管理，第三部分是访问控制函数</p><p>JC实现两个函数，第一个是恶意行为判决，第二个用来查询恶意行为</p><a class=post-dummy-target id=2-审计></a><h2>2. 审计</h2><p>智能合约的安全性非常重要，行业内对智能合约进行安全性分析称之为「审计」</p><a class=post-dummy-target id=21-工具选取></a><h3>2.1 工具选取</h3><p>基本的思路是选取合适的自动审计工具来对编写完成的合约进行分析，参考了 <a href=https://learnblockchain.cn/2019/10/15/VaasMythril/ target=_blank>关于形式化验证两大工具 (Vass & Mythril) 测试对比</a> 这篇文章。</p><p>在经过大量查找后发现，商业化应用的审计工具以上文中提到的这两款（Vass 和 Mythril） 最为普及。我们首先使用成都链安的 Vass 工具进行分析，然而发现，在合约中存在内联汇编时，Vass 无法编译合约，更谈不上审计，然而内联汇编在我们的合约中是必要的，因此换用 Mythril。</p><p>工具是由以太坊开源社区所提供的安全分析工具，而建立在Mythril上的合约分析平台 <a href=https://github.com/b-mueller/awesome-mythx-smart-contract-security-tools target=_blank>MythX</a>具有更高的可用性并覆盖了更广泛的安全问题，因此最终使用MythX 完成统计分析。MythX 拥有 Remix、VScode 和 Truffle 的插件，因此无论以哪种方式编辑合约，都可以轻松的进行安全分析，但首先需要拥有 MythX 的账户。</p><p>首先在 <a href=https://dashboard.mythx.io/#/registration>https://dashboard.mythx.io/#/registration</a> 页面使用邮箱进行注册，之后关联 MetaMask 以太坊账户，MythX 将提供一个密码供 Remix 等工具中的插件使用，也可以自己设定，但设定的密码要求长度为 6-64 位，至少一个小写字符，一个大写字符，一个数字和一个符号，该要求的原文如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>Password needs to contain: Length: 8 and 64 characters; One lowercase (a-z) and uppercase (A-Z) letter; One digit (0-9); One symbol (e.g. !&#34;#$%&amp;/()., )
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=22-审计></a><h3>2.2 审计</h3><p>打开 Remix 界面，在插件列表搜索 MythX，点击<code>Activate</code>将插件激活。</p><p>以 Remix 自带的示例合约 ballot.sol 为例，首先编译该合约，然后切换到 MythX 选项卡，输入之前关联到 MythX 的以太坊账户地址，MythX 提供的或自己更改后的密码，点击<code>Save</code>，然后点击<code>Analyze</code></p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZdFe.png alt=登录并进行分析 class=lazyload><figcaption class=image-caption>登录并进行分析</figcaption></figure></p><p>经过一段时间的等待后，将可以在<code>Report</code>界面查看到安全分析结果</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZcef.png alt=查看分析结果 class=lazyload><figcaption class=image-caption>查看分析结果</figcaption></figure></p><p>也可以点击上图 Log 记录中的链接进入 MythX Dashboard 查看详细结果</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZfYQ.png alt=详细分析结果 class=lazyload><figcaption class=image-caption>详细分析结果</figcaption></figure></p><p>点击<code>Analysed Files</code>查看错误的详细位置与说明，然后更改源代码，重新测试，直到合约安全性达到自己想要的结果。</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8lZoyq.png alt=迭代修改 class=lazyload><figcaption class=image-caption>迭代修改</figcaption></figure></p><p>检测到的合约弱点(漏洞)以SWC-XXX编号的形式出现，由 <a href=https://swcregistry.io/>https://swcregistry.io/</a> 可查看完整的安全问题列表和解释。但是，免费的 MythX 只能检测10种安全问题，Pro版和企业版可以检测26种安全问题，具体对每种安全问题的支持程度见该页面： <a href=https://mythx.io/swc-coverage/>https://mythx.io/swc-coverage/</a></p><p>当前调试过程种，遇到的典型安全问题是 SWC-101:Integer Overflow and Underflow 问题，问题的具体分析可参考 <a href=https://github.com/ethereum/solidity/issues/796 target=_blank>solidity-issue #796</a></p><a class=post-dummy-target id=23-审计结果></a><h3>2.3 审计结果</h3><p>我们所编写的 RC，ACC 和 JC 三个合约在经过多次修改后，将出现的安全问题降低到了可接受的程度，如下图所示</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8leP0K.png alt=访问控制合约检测结果 class=lazyload><figcaption class=image-caption>访问控制合约检测结果</figcaption></figure></p><p>三个合约出现的低级安全问题均为SWC-103: Floating Pragma ，即编译器的版本指定为一个范围，但这样具有更好的适用性，因此不进行修改</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js> <span class=nx>pragma</span> <span class=nx>solidity</span> <span class=o>&gt;=</span><span class=mf>0.4</span><span class=mf>.22</span> <span class=o>&lt;</span><span class=mf>0.6</span><span class=mf>.0</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><p>ACC出现的15个中级安全问题在详情列表中无法查看</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_8leZpd.png alt=ACC的安全问题 class=lazyload><figcaption class=image-caption>ACC的安全问题</figcaption></figure></p><p>邮件询问后官方的回复如下，字节码级别的错误如果不依靠安全工具很难检出并修正，因此我们只能忽略掉这些安全问题。</p><blockquote><p><strong>Josh Reid</strong> (MythX)</p><p>Dec 5, 11:11 AST</p><p>Hello,</p><p>Thanks for reaching out to MythX support! We are currently investigating any potential issues that may be causing these vulnerabilities to not be displayed fully, however this may also be due to the vulnerabilities being detected only on the bytecode.</p><p>Unfortunately, at this time we do no have the ability to display bytecode vulnerabilities as we cannot specify where they are. However, this is something we are looking to evaluate and differentiate on more as we go forward. I apologize for any confusion this may have caused and will be sure to update you if we find any issues as we continue to look into this. In the meantime, thanks so much for your patience and cooperation! Is there anything else I can help you with at this time?</p><p>Best,</p><p>Josh</p></blockquote><a class=post-dummy-target id=3-系统测试></a><h2>3. 系统测试</h2><p>本节介绍合约在 Quorum 区块链网络中的部署过程和访问控制的测试实现。由于论文复现的时候发现手动配置的复杂性太高，极易出错，而一旦出错就必须重来，因此这次的优化实验决定使用 truffle 进行部署测试。</p><a class=post-dummy-target id=31-账户设置></a><h3>3.1 账户设置</h3><p>按设计，Raspberry Pi 3B+ 是 lightnode1，Raspberry Pi 3B 是 linghtnode2。区块链网络启动后，四个 validator 各有 10<sup>50</sup> wei(10<sup>18</sup>是 1 ether)，但是后面加入区块链网络的两台树莓派是普通节点，余额为 0，所以首先由 node0 向两个账户分别转账 1 ether。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># lightnode1账户地址为：&#34;0x77c22157a3b8840d34b8ed5975b5f2597bd6a7a2&#34;</span>
<span class=c1># lightnode2账户地址为：&#34;0xa31d40508da63fb00d7e2f4db57c3774384aa299&#34;</span>
</code></pre></td></tr></table></div></div><p>在 node0 的 geth console 中解锁账户，并分别向 lightnode1 和 lightnode2 转账 1 ether</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=o>&gt;</span> <span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span>
<span class=p>[</span><span class=s2>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span><span class=p>]</span>
<span class=o>&gt;</span> <span class=nx>eth</span><span class=p>.</span><span class=nx>getBalance</span><span class=p>(</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=p>)</span>
<span class=mi>1</span><span class=nx>e</span><span class=o>+</span><span class=mi>50</span>
<span class=o>&gt;</span> <span class=nx>personal</span><span class=p>.</span><span class=nx>unlockAccount</span><span class=p>(</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=p>)</span>
<span class=nx>Unlock</span> <span class=nx>account</span> <span class=mh>0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0</span>
<span class=nx>Passphrase</span><span class=o>:</span> 
<span class=kc>true</span>
<span class=o>&gt;</span> 
<span class=o>&gt;</span> <span class=nx>eth</span><span class=p>.</span><span class=nx>sendTransaction</span><span class=p>(</span><span class=p>{</span><span class=nx>from</span><span class=o>:</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=p>,</span> <span class=nx>to</span><span class=o>:</span><span class=s2>&#34;0x77c22157a3b8840d34b8ed5975b5f2597bd6a7a2&#34;</span><span class=p>,</span> <span class=nx>value</span><span class=o>:</span><span class=mi>1</span><span class=o>*</span><span class=mi>1</span><span class=nx>e18</span><span class=p>}</span><span class=p>)</span>
<span class=s2>&#34;0x3ed3cbc568a64dff3c3fe4a00b87d259d2299953c47e284b19253299eb8c4725&#34;</span>
<span class=o>&gt;</span> <span class=nx>eth</span><span class=p>.</span><span class=nx>sendTransaction</span><span class=p>(</span><span class=p>{</span><span class=nx>from</span><span class=o>:</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=p>,</span> <span class=nx>to</span><span class=o>:</span><span class=s2>&#34;0xa31d40508da63fb00d7e2f4db57c3774384aa299&#34;</span><span class=p>,</span> <span class=nx>value</span><span class=o>:</span><span class=mi>1</span><span class=o>*</span><span class=mi>1</span><span class=nx>e18</span><span class=p>}</span><span class=p>)</span>
<span class=s2>&#34;0xc9e4193164d38d94502960fcc0d1d7c2e22a9f04307145945c4ae525c6d99aee&#34;</span>
<span class=o>&gt;</span> <span class=nx>eth</span><span class=p>.</span><span class=nx>getBalance</span><span class=p>(</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=p>)</span>
<span class=mf>9.9999999999999999999999999999998e+49</span>
</code></pre></td></tr></table></div></div><p>在 lightnode1 和 lightnode2 的 geth console 执行下列命令查询余额，由结果可知转账成功。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=o>&gt;</span> <span class=nx>web3</span><span class=p>.</span><span class=nx>fromWei</span><span class=p>(</span><span class=nx>eth</span><span class=p>.</span><span class=nx>getBalance</span><span class=p>(</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=p>)</span><span class=p>,</span> <span class=s2>&#34;ether&#34;</span><span class=p>)</span>
<span class=mi>1</span>
</code></pre></td></tr></table></div></div><p>两台树莓派担任的角色是网关，用于管理 IoT 设备，因此分别在 lightnode1 和 lightnode2 中建立新账户，用来代表 IoT 设备，由网关向各自管理的设备转账 10<sup>7</sup> wei，以供使用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=err>#</span> <span class=nx>lightnode1</span>
<span class=o>&gt;</span> <span class=nx>personal</span><span class=p>.</span><span class=nx>newAccount</span><span class=p>(</span><span class=p>)</span>
<span class=nx>Passphrase</span><span class=o>:</span>
<span class=nx>Repeat</span> <span class=nx>passphrase</span><span class=o>:</span>
<span class=s2>&#34;0x9a4aa696f85c6bf96733cc5385ccaf2b7ee13f17&#34;</span>
<span class=o>&gt;</span> <span class=nx>personal</span><span class=p>.</span><span class=nx>listAccounts</span>
<span class=p>[</span><span class=s2>&#34;0x77c22157a3b8840d34b8ed5975b5f2597bd6a7a2&#34;</span><span class=p>,</span> <span class=s2>&#34;0x9a4aa696f85c6bf96733cc5385ccaf2b7ee13f17&#34;</span><span class=p>]</span>
<span class=o>&gt;</span> <span class=nx>personal</span><span class=p>.</span><span class=nx>unlockAccount</span><span class=p>(</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=p>)</span>
<span class=nx>Unlock</span> <span class=nx>account</span> <span class=mh>0x77c22157a3b8840d34b8ed5975b5f2597bd6a7a2</span>
<span class=nx>Passphrase</span><span class=o>:</span>
<span class=kc>true</span>
<span class=o>&gt;</span> <span class=nx>eth</span><span class=p>.</span><span class=nx>sendTransaction</span><span class=p>(</span><span class=p>{</span><span class=nx>from</span><span class=o>:</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=p>,</span><span class=nx>to</span><span class=o>:</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=p>,</span><span class=nx>value</span><span class=o>:</span><span class=mi>1</span><span class=o>*</span><span class=mi>1</span><span class=nx>e7</span><span class=p>}</span><span class=p>)</span>
<span class=s2>&#34;0x35bda063bc28ff3ef68b78962f427e930824390c4d1a8857c98e2dcf70485e17&#34;</span>
<span class=o>&gt;</span> <span class=nx>eth</span><span class=p>.</span><span class=nx>getBalance</span><span class=p>(</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=p>)</span>
<span class=mi>10000000</span> 

<span class=err>#</span> <span class=nx>lightnode2</span>
<span class=o>&gt;</span> <span class=nx>personal</span><span class=p>.</span><span class=nx>newAccount</span><span class=p>(</span><span class=p>)</span>
<span class=nx>Passphrase</span><span class=o>:</span> 
<span class=nx>Repeat</span> <span class=nx>passphrase</span><span class=o>:</span> 
<span class=s2>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span>
<span class=o>&gt;</span> <span class=nx>personal</span><span class=p>.</span><span class=nx>listAccounts</span>
<span class=p>[</span><span class=s2>&#34;0xa31d40508da63fb00d7e2f4db57c3774384aa299&#34;</span><span class=p>,</span> <span class=s2>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span><span class=p>]</span>
<span class=o>&gt;</span> <span class=nx>personal</span><span class=p>.</span><span class=nx>unlockAccount</span><span class=p>(</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=p>)</span>
<span class=nx>Unlock</span> <span class=nx>account</span> <span class=mh>0xa31d40508da63fb00d7e2f4db57c3774384aa299</span>
<span class=nx>Passphrase</span><span class=o>:</span> 
<span class=kc>true</span>
<span class=o>&gt;</span> <span class=nx>eth</span><span class=p>.</span><span class=nx>sendTransaction</span><span class=p>(</span><span class=p>{</span><span class=nx>from</span><span class=o>:</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=p>,</span><span class=nx>to</span><span class=o>:</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=p>,</span><span class=nx>value</span><span class=o>:</span><span class=mi>1</span><span class=o>*</span><span class=mi>1</span><span class=nx>e7</span><span class=p>}</span><span class=p>)</span>
<span class=s2>&#34;0x96bc2b359219c72ff4f2ce910c27d4c76649685a8f9cfd1b879938317c9a1fe1&#34;</span>
<span class=o>&gt;</span> <span class=nx>eth</span><span class=p>.</span><span class=nx>getBalance</span><span class=p>(</span><span class=nx>eth</span><span class=p>.</span><span class=nx>accounts</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=p>)</span>
<span class=mi>10000000</span>
</code></pre></td></tr></table></div></div><p>至此账户设置完成，接下来将 truffle 连接到 quorum 网络，部署合约</p><a class=post-dummy-target id=32-安装truffle></a><h3>3.2 安装Truffle</h3><p>在 Ubuntu18.04 下安装运行，要求 Node.js 版本高于 v8.9.4，这里全都升级到了最新</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo apt-get install npm
$ sudo npm install npm@latest -g
$ sudo npm install n -g
$ sudo n lts
</code></pre></td></tr></table></div></div><p>安装 Truffle</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo npm install -g truffle
$ truffle version
Truffle v5.1.5 <span class=o>(</span>core: 5.1.5<span class=o>)</span>
Solidity v0.5.12 <span class=o>(</span>solc-js<span class=o>)</span>
Node v12.14.0
Web3.js v1.2.1
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=33-创建项目和基本配置></a><h3>3.3 创建项目和基本配置</h3><p>建立空项目</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ mkdir AC
$ <span class=nb>cd</span> AC
</code></pre></td></tr></table></div></div><p>初始化项目</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ truffle init
✔ Preparing to download box
✔ Downloading
✔ cleaning up temporary files
✔ Setting up box
</code></pre></td></tr></table></div></div><p>项目文件夹中出现相关文件说明成功，此时没有任何合约和测试代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ ls
contracts  migrations  <span class=nb>test</span>  truffle-config.js
</code></pre></td></tr></table></div></div><p>修改<code>truffle-config.js</code>文件进行配置，使其关联到已建立的 quorum 网络</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=c1>// truffle-config.js
</span><span class=c1></span><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nx>networks</span><span class=o>:</span> <span class=p>{</span>
     <span class=nx>development</span><span class=o>:</span> <span class=p>{</span>
       <span class=nx>host</span><span class=o>:</span> <span class=s2>&#34;192.168.191.2&#34;</span><span class=p>,</span>  <span class=c1>// Localhost (default: none)
</span><span class=c1></span>       <span class=nx>port</span><span class=o>:</span> <span class=mi>22000</span><span class=p>,</span>            
       <span class=nx>network_id</span><span class=o>:</span> <span class=s2>&#34;10&#34;</span><span class=p>,</span>       
       <span class=nx>gasPrice</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
       <span class=nx>gas</span><span class=o>:</span> <span class=mi>100000000</span><span class=p>,</span>
       <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;quorum&#34;</span>    
     <span class=p>}</span><span class=p>,</span>
     <span class=nx>lightnode1</span><span class=o>:</span> <span class=p>{</span>
       <span class=nx>host</span><span class=o>:</span> <span class=s2>&#34;192.168.191.3&#34;</span><span class=p>,</span>   
       <span class=nx>port</span><span class=o>:</span> <span class=mi>22000</span><span class=p>,</span>            <span class=c1>// Standard Ethereum port (default: none)
</span><span class=c1></span>       <span class=nx>network_id</span><span class=o>:</span> <span class=s2>&#34;10&#34;</span><span class=p>,</span>       
       <span class=nx>gasPrice</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
       <span class=nx>gas</span><span class=o>:</span> <span class=mi>10000000</span><span class=p>,</span>
       <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;quorum&#34;</span><span class=p>,</span>
       <span class=nx>from</span><span class=o>:</span> <span class=s2>&#34;0x9a4aa696f85c6bf96733cc5385ccaf2b7ee13f17&#34;</span><span class=p>,</span>    
       <span class=nx>provider</span><span class=o>:</span> <span class=k>new</span> <span class=nx>Web3</span><span class=p>.</span><span class=nx>providers</span><span class=p>.</span><span class=nx>WebsocketProvider</span><span class=p>(</span><span class=s2>&#34;ws://192.168.191.3:8545&#34;</span><span class=p>)</span>
     <span class=p>}</span><span class=p>,</span>
     <span class=nx>lightnode2</span><span class=o>:</span> <span class=p>{</span>
       <span class=nx>host</span><span class=o>:</span> <span class=s2>&#34;192.168.191.4&#34;</span><span class=p>,</span>  
       <span class=nx>port</span><span class=o>:</span> <span class=mi>22000</span><span class=p>,</span>            <span class=c1>// Standard Ethereum port (default: none)
</span><span class=c1></span>       <span class=nx>network_id</span><span class=o>:</span> <span class=s2>&#34;10&#34;</span><span class=p>,</span>       
       <span class=nx>gasPrice</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
       <span class=nx>gas</span><span class=o>:</span> <span class=mi>10000000</span><span class=p>,</span>
       <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;quorum&#34;</span><span class=p>,</span>
       <span class=nx>from</span><span class=o>:</span> <span class=s2>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span><span class=p>,</span>
       <span class=nx>provider</span><span class=o>:</span> <span class=k>new</span> <span class=nx>Web3</span><span class=p>.</span><span class=nx>providers</span><span class=p>.</span><span class=nx>WebsocketProvider</span><span class=p>(</span><span class=s2>&#34;ws://192.168.191.4:8545&#34;</span><span class=p>)</span>    
     <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><p>建立了三个网络<code>development</code>、<code>lightnode1</code>和<code>lightnode2</code>。第一个网络<code>development</code>是 node0，用来部署 RC 和 JC，第二个网络是 lightnode1，用来部署ACC，第三个网络是 lightnode2，用来发起访问控制做演示。</p><p>因为在最后设置了<code>provider</code>，使用 websocket 进行访问，所以实际上定义的<code>host</code>和<code>port</code>两个参数是被屏蔽的，主要是因为基于 http 的远程连接好像已经被启用了，只能使用 websocket。</p><p>参数的设置主要参考了以下两篇文档</p><ul><li><a href=https://www.trufflesuite.com/docs/truffle/reference/configuration target=_blank>Truffle Configuration</a></li><li><a href=https://www.trufflesuite.com/tutorials/building-dapps-for-quorum-private-enterprise-blockchains target=_blank>Building Dapps for Quorum:Private Enterprise Blockchains</a></li></ul><a class=post-dummy-target id=34-部署></a><h3>3.4 部署</h3><p>将 RC，ACC 和 JC 三个合约放入<code>contracts</code>文件夹，然后在项目根目录执行<code>truffle compile</code>编译命令，编译所有合约，不过编译命令可以不执行，因为下面的<code>truffle migrate</code>无论是否执行过编译都会再检查一遍，如果编译过，就忽略，如果没有编译，会自动执行编译命令。</p><p>在<code>migrations</code>文件夹新建文件<code>2_deploy_contracts.js</code>，用于部署合约，编写内容如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=kd>var</span> <span class=nx>Register</span> <span class=o>=</span> <span class=nx>artifacts</span><span class=p>.</span><span class=nx>require</span><span class=p>(</span><span class=s2>&#34;Register&#34;</span><span class=p>)</span><span class=p>;</span>
<span class=kd>var</span> <span class=nx>Judge</span> <span class=o>=</span> <span class=nx>artifacts</span><span class=p>.</span><span class=nx>require</span><span class=p>(</span><span class=s2>&#34;Judge&#34;</span><span class=p>)</span><span class=p>;</span>
<span class=kd>var</span> <span class=nx>AccessControl</span> <span class=o>=</span> <span class=nx>artifacts</span><span class=p>.</span><span class=nx>require</span><span class=p>(</span><span class=s2>&#34;AccessControl&#34;</span><span class=p>)</span><span class=p>;</span>

<span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>deployer</span><span class=p>,</span> <span class=nx>network</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=nx>network</span> <span class=o>==</span> <span class=s2>&#34;lightnode1&#34;</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>deployer</span><span class=p>.</span><span class=nx>deploy</span><span class=p>(</span><span class=nx>AccessControl</span><span class=p>,</span> <span class=nx>Register</span><span class=p>.</span><span class=nx>address</span><span class=p>,</span> <span class=nx>Judge</span><span class=p>.</span><span class=nx>address</span><span class=p>)</span><span class=p>;</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=nx>deployer</span><span class=p>.</span><span class=nx>deploy</span><span class=p>(</span><span class=nx>Register</span><span class=p>)</span><span class=p>;</span>
    <span class=nx>deployer</span><span class=p>.</span><span class=nx>deploy</span><span class=p>(</span><span class=nx>Judge</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><p>首先从 node0 部署 RC 和 JC 两个合约，<code>truffle migrate</code>命令默认连接<code>truffle-config.js</code>配置中的<code>development</code>网络，我们之前已将该网络设置为 node0 的 ip 和端口。</p><p>注：所有<code>truffle migrate</code>和<code>truffle exec</code>命令执行前都要先对相应的账户解锁，否则无法成功</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ truffle migrate
Compiling your contracts...
<span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span>
&gt; Compiling ./contracts/ACC.sol
&gt; Compiling ./contracts/JC.sol
&gt; Compiling ./contracts/Migrations.sol
&gt; Compiling ./contracts/RC.sol
&gt; Artifacts written to /home/shuzang/AC/build/contracts
&gt; Compiled successfully using:
   - solc: 0.5.12+commit.7709ece9.Emscripten.clang

Starting migrations...
<span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span>
&gt; Network name:    <span class=s1>&#39;development&#39;</span>
&gt; Network id:      <span class=m>10</span>
&gt; Block gas limit: 0x6dcd11a0


1_initial_migration.js
<span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span>

   Deploying <span class=s1>&#39;Migrations&#39;</span>
   ----------------------
   &gt; transaction hash:    0xefb249903f558ccd7b6326f73a886356b55377a4262b34b81f5f9f2940b4347e
   &gt; Blocks: <span class=m>0</span>            Seconds: <span class=m>4</span>
   &gt; contract address:    0x4EC4F8BA5aEcA93955f67CFA58dbe4C57b21b37c
   &gt; block number:        <span class=m>2922</span>
   &gt; block timestamp:     0x5e02bcb5
   &gt; account:             0xbfFe4ff0cBd0A7590Fb71966D1E6bb1a4c2359e0
   &gt; balance:             <span class=m>99999999999999999999999999999998</span>
   &gt; gas used:            <span class=m>263741</span>
   &gt; gas price:           <span class=m>0</span> gwei
   &gt; value sent:          <span class=m>0</span> ETH
   &gt; total cost:          <span class=m>0</span> ETH


   &gt; Saving migration to chain.
   &gt; Saving artifacts
   -------------------------------------
   &gt; Total cost:                   <span class=m>0</span> ETH


2_deploy_contracts.js
<span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span>

   Deploying <span class=s1>&#39;Register&#39;</span>
   --------------------
   &gt; transaction hash:    0xa49e8d423980248e9c03eb52ecd3b46c15209e867285d2bc718a20620f3addd2
   &gt; Blocks: <span class=m>0</span>            Seconds: <span class=m>4</span>
   &gt; contract address:    0x8980FC2bBD25958d0c72F5ba5fa3e5faF1A48c05
   &gt; block number:        <span class=m>2924</span>
   &gt; block timestamp:     0x5e02bcbf
   &gt; account:             0xbfFe4ff0cBd0A7590Fb71966D1E6bb1a4c2359e0
   &gt; balance:             <span class=m>99999999999999999999999999999998</span>
   &gt; gas used:            <span class=m>3227866</span>
   &gt; gas price:           <span class=m>0</span> gwei
   &gt; value sent:          <span class=m>0</span> ETH
   &gt; total cost:          <span class=m>0</span> ETH


   Deploying <span class=s1>&#39;Judge&#39;</span>
   -----------------
   &gt; transaction hash:    0xaf538d559ecc72949d40bbc4d1dde67dfa535c7d5a78267c4de414b51fef4bf9
   &gt; Blocks: <span class=m>0</span>            Seconds: <span class=m>4</span>
   &gt; contract address:    0x2C2Fb0DD2440e72318Fb018f923F78Ff86541D08
   &gt; block number:        <span class=m>2925</span>
   &gt; block timestamp:     0x5e02bcc4
   &gt; account:             0xbfFe4ff0cBd0A7590Fb71966D1E6bb1a4c2359e0
   &gt; balance:             <span class=m>99999999999999999999999999999998</span>
   &gt; gas used:            <span class=m>1349320</span>
   &gt; gas price:           <span class=m>0</span> gwei
   &gt; value sent:          <span class=m>0</span> ETH
   &gt; total cost:          <span class=m>0</span> ETH


   &gt; Saving migration to chain.
   &gt; Saving artifacts
   -------------------------------------
   &gt; Total cost:                   <span class=m>0</span> ETH


<span class=nv>Summary</span>
<span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span>
&gt; Total deployments:   <span class=m>3</span>
&gt; Final cost:          <span class=m>0</span> ETH
</code></pre></td></tr></table></div></div><p>然后部署 ACC，<code>truffle migrate</code>命令指定连接网络<code>lightnode1</code>，<code>--f</code>指定部署脚本，否则因为之前该脚本已成功执行会略过，而又因为没有新的脚本而没有任何操作。<code>truffle-config.js</code>配置中的<code>lightnode1</code>网络已设置为 raspberry pi 3B+ 的 ip 和端口，默认账户设置为第二个账户，也就是新建的用于表示 IoT 设备的账户。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ truffle migrate --network linghtnode1 --f <span class=m>2</span>
Compiling your contracts...
<span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span>
&gt; Everything is up to date, there is nothing to compile.



Starting migrations...
<span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span>
&gt; Network name:    <span class=s1>&#39;lightnode1&#39;</span>
&gt; Network id:      <span class=m>10</span>
&gt; Block gas limit: 0x67a09e29


2_deploy_contracts.js
<span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span>

   Deploying <span class=s1>&#39;AccessControl&#39;</span>
   -------------------------
   &gt; transaction hash:    0xf49cca809ad273812de75225dcfe50b624bfe2a93fd2b44653491e8ee0edeb04
   &gt; Blocks: <span class=m>1</span>            Seconds: <span class=m>4</span>
   &gt; contract address:    0x05455fa63e5a7cb6575D75c99855cF3A1Adc72b1
   &gt; block number:        <span class=m>3160</span>
   &gt; block timestamp:     0x5e02c15b
   &gt; account:             0x9A4aa696F85C6bF96733Cc5385cCaf2b7ee13f17
   &gt; balance:             0.00000000001
   &gt; gas used:            <span class=m>5263918</span>
   &gt; gas price:           <span class=m>0</span> gwei
   &gt; value sent:          <span class=m>0</span> ETH
   &gt; total cost:          <span class=m>0</span> ETH


   &gt; Saving migration to chain.
   &gt; Saving artifacts
   -------------------------------------
   &gt; Total cost:                   <span class=m>0</span> ETH


<span class=nv>Summary</span>
<span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span>
&gt; Total deployments:   <span class=m>1</span>
&gt; Final cost:          <span class=m>0</span> ETH

</code></pre></td></tr></table></div></div><a class=post-dummy-target id=35-合约交互></a><h3>3.5 合约交互</h3><p>尝试了三种方式，在这里最后只有 truffle console 这种方式真正完成了，但理论上三种都可行，而且事实证明利用 web3.js 完成交互最方便，truffle console 还是有点繁琐。</p><a class=post-dummy-target id=truffle-contract></a><h4><del>truffle-contract</del></h4><p>truffle使用 <a href=https://github.com/trufflesuite/truffle/tree/master/packages/contract target=_blank>truffle-contract</a> 接口(原文是contract abstraction，合约抽象)来交互，truffle develop的控制台、migrate写的部署脚本和基于 JS 的单元测试等都用的是这个抽象接口。</p><p>主要方式是编写JavaScript代码，使用提供的抽象接口可以调用已部署合约的函数，无论是发起交易改变合约状态还是仅仅调用获得返回结果。</p><p>在项目根目录(和<code>trufffle-config.js</code>同文件夹)创建文件<code>JCRegister.js</code>，用于注册判决合约，文件内容如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=kd>var</span> <span class=nx>Register</span> <span class=o>=</span> <span class=nx>artifacts</span><span class=p>.</span><span class=nx>require</span><span class=p>(</span><span class=s2>&#34;Register&#34;</span><span class=p>)</span><span class=p>;</span>
<span class=kd>var</span> <span class=nx>Judge</span> <span class=o>=</span> <span class=nx>artifacts</span><span class=p>.</span><span class=nx>require</span><span class=p>(</span><span class=s2>&#34;Judge&#34;</span><span class=p>)</span><span class=p>;</span>

<span class=nx>module</span><span class=p>.</span><span class=kr>export</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Getting deployed Register contract...&#34;</span><span class=p>)</span>
    <span class=nx>Register</span><span class=p>.</span><span class=nx>deployed</span><span class=p>(</span><span class=p>)</span><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Register Judge contract...&#34;</span><span class=p>)</span><span class=p>;</span>
        <span class=k>return</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>contractRegister</span><span class=p>(</span><span class=s2>&#34;Judger&#34;</span><span class=p>,</span> <span class=s2>&#34;JC&#34;</span><span class=p>,</span> <span class=s2>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span><span class=p>,</span> <span class=nx>Judge</span><span class=p>.</span><span class=nx>address</span><span class=p>)</span><span class=p>;</span>
    <span class=p>}</span><span class=p>)</span><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>result</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Transaction:&#34;</span><span class=p>,</span> <span class=nx>result</span><span class=p>.</span><span class=nx>tx</span><span class=p>)</span><span class=p>;</span>
            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Finished!&#34;</span><span class=p>)</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>else</span>
            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span><span class=p>;</span>
    <span class=p>}</span><span class=p>)</span><span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span><span class=p>;</span>
        <span class=nx>done</span><span class=p>(</span><span class=p>)</span><span class=p>;</span>
    <span class=p>}</span><span class=p>)</span><span class=p>;</span>
<span class=p>}</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><p>解锁node0账户，然后执行下列命令</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ truffle <span class=nb>exec</span> JCRegister.js
</code></pre></td></tr></table></div></div><p><code>truffle exec</code>执行错误，错误信息如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ truffle <span class=nb>exec</span> JCRegister.js
Using network <span class=s1>&#39;development&#39;</span>.

TypeError: fn is not a <span class=k>function</span>
    at Object.exec <span class=o>(</span>/usr/local/lib/node_modules/truffle/build/webpack:/packages/require/require.js:124:1<span class=o>)</span>
    at /usr/local/lib/node_modules/truffle/build/webpack:/packages/core/lib/commands/exec.js:89:1
    at processTicksAndRejections <span class=o>(</span>internal/process/task_queues.js:93:5<span class=o>)</span>
Truffle v5.1.5 <span class=o>(</span>core: 5.1.5<span class=o>)</span>
Node v12.14.0

</code></pre></td></tr></table></div></div><a class=post-dummy-target id=web3js></a><h4><del>web3.js</del></h4><p>使用 web3.js，在用户根目录建立 web3 文件夹，本地安装 web3.js 模块</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>cd</span> ..
$ <span class=nb>pwd</span>
/home/shuzang
$ mkdir web3 <span class=o>&amp;&amp;</span> <span class=nb>cd</span> web3
$ npm install web3
$ npm list --depth <span class=m>0</span>
/home/shuzang/web3
└── web3@1.2.4
</code></pre></td></tr></table></div></div><p>创建文件<code>1_Register_JC.js</code>用于注册判决合约，命名方式参考了 truffle 的命名方式文件内容如下，ABI 过长，本文以省略号代替。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=kd>var</span> <span class=nx>Web3</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;web3&#39;</span><span class=p>)</span><span class=p>;</span>
<span class=k>if</span><span class=p>(</span><span class=k>typeof</span> <span class=nx>web3</span> <span class=o>!==</span><span class=s1>&#39;undefined&#39;</span><span class=p>)</span><span class=p>{</span> <span class=c1>//检查是否已有web3实例
</span><span class=c1></span>    <span class=nx>web3</span><span class=o>=</span><span class=k>new</span> <span class=nx>Web3</span><span class=p>(</span><span class=nx>web3</span><span class=p>.</span><span class=nx>currentProvider</span><span class=p>)</span><span class=p>;</span>
<span class=p>}</span><span class=k>else</span><span class=p>{</span>
    <span class=c1>//否则就连接到给出节点
</span><span class=c1></span>    <span class=nx>web3</span><span class=o>=</span><span class=k>new</span> <span class=nx>Web3</span><span class=p>(</span><span class=p>)</span><span class=p>;</span>
    <span class=nx>web3</span><span class=p>.</span><span class=nx>setProvider</span><span class=p>(</span><span class=k>new</span> <span class=nx>Web3</span><span class=p>.</span><span class=nx>providers</span><span class=p>.</span><span class=nx>WebsocketProvider</span><span class=p>(</span><span class=s2>&#34;ws://localhost:8545&#34;</span><span class=p>)</span><span class=p>)</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>var</span> <span class=nx>rcAbi</span> <span class=o>=</span> <span class=p>[</span><span class=p>...</span><span class=p>]</span>

<span class=nx>web3</span><span class=p>.</span><span class=nx>eth</span><span class=p>.</span><span class=nx>getBlock</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>result</span><span class=p>)</span><span class=p>{</span>
	<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>error</span><span class=p>)</span>
		<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;connection succeed&#34;</span><span class=p>)</span><span class=p>;</span>
	<span class=k>else</span>
		<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;something wrong, connection failed&#34;</span><span class=p>)</span><span class=p>;</span>
<span class=p>}</span><span class=p>)</span><span class=p>;</span>


<span class=kd>var</span> <span class=nx>rcAddress</span> <span class=o>=</span> <span class=s2>&#34;0x8980FC2bBD25958d0c72F5ba5fa3e5faF1A48c05&#34;</span><span class=p>;</span>
<span class=kd>var</span> <span class=nx>jcAddress</span><span class=o>=</span> <span class=s2>&#34;0x2C2Fb0DD2440e72318Fb018f923F78Ff86541D08&#34;</span><span class=p>;</span>

<span class=kd>var</span> <span class=nx>register</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>web3</span><span class=p>.</span><span class=nx>eth</span><span class=p>.</span><span class=nx>Contract</span><span class=p>(</span><span class=nx>rcAbi</span><span class=p>)</span><span class=p>;</span>
<span class=nx>register</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>address</span><span class=o>=</span><span class=nx>rcAddress</span><span class=p>;</span>

<span class=nx>register</span><span class=p>.</span><span class=nx>methods</span><span class=p>.</span><span class=nx>contractRegister</span><span class=p>(</span><span class=s2>&#34;Judger&#34;</span><span class=p>,</span> <span class=s2>&#34;JC&#34;</span><span class=p>,</span> <span class=s2>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span><span class=p>,</span> <span class=nx>jcAddress</span><span class=p>)</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=p>{</span>
	<span class=nx>from</span><span class=o>:</span> <span class=s2>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span><span class=p>,</span>
	<span class=nx>gas</span><span class=o>:</span> <span class=mi>10000000</span>
<span class=p>}</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>result</span><span class=p>)</span><span class=p>{</span>
	<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>error</span><span class=p>)</span><span class=p>{</span>
		<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Transaction: &#39;</span> <span class=o>+</span> <span class=nx>result</span><span class=p>)</span><span class=p>;</span>
		<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Finished!&#39;</span><span class=p>)</span><span class=p>;</span>
	<span class=p>}</span>
	<span class=k>else</span>
		<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span><span class=p>;</span>
 <span class=p>}</span><span class=p>)</span>

 <span class=nx>register</span><span class=p>.</span><span class=nx>methods</span><span class=p>.</span><span class=nx>getContractAddr</span><span class=p>(</span><span class=s2>&#34;Judger&#34;</span><span class=p>)</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=p>{</span>
	<span class=nx>from</span><span class=o>:</span> <span class=s2>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span><span class=p>,</span>
	<span class=nx>gas</span><span class=o>:</span> <span class=mi>10000000</span>
<span class=p>}</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>result</span><span class=p>)</span><span class=p>{</span>
	<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>error</span><span class=p>)</span><span class=p>{</span>
        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Judge contract address:&#39;</span> <span class=o>+</span> <span class=nx>result</span><span class=p>)</span><span class=p>;</span>
	<span class=p>}</span>
	<span class=k>else</span>
		<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span><span class=p>;</span>
 <span class=p>}</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>web3.js执行合约交易不成功，全部陷在交易池了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=o>&gt;</span> <span class=nx>txpool</span><span class=p>.</span><span class=nx>status</span>
<span class=p>{</span>
  <span class=nx>pending</span><span class=o>:</span> <span class=mi>5</span><span class=p>,</span>
  <span class=nx>queued</span><span class=o>:</span> <span class=mi>0</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>日志记录里提示</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>VM returned with error                   <span class=nv>err</span><span class=o>=</span><span class=s2>&#34;evm: execution reverted&#34;</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=truffle-console></a><h4>truffle console</h4><p>truffle的文档里提到与已部署的合约交互可以使用truffle console，故尝试</p><p>首先注册判决合约，需要在node0中进行，进入<code>development</code>网络</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ truffle console
</code></pre></td></tr></table></div></div><p>命令执行完毕后进入<code>truffle console</code>控制台，注册合约并查询合约地址进行验证</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=nx>truffle</span><span class=p>(</span><span class=nx>development</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>Register</span><span class=p>.</span><span class=nx>deployed</span><span class=p>(</span><span class=p>)</span><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=p>{</span><span class=nx>instance</span><span class=p>.</span><span class=nx>contractRegister</span><span class=p>(</span><span class=s2>&#34;Judger&#34;</span><span class=p>,</span> <span class=s2>&#34;JC&#34;</span><span class=p>,</span> <span class=s2>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span><span class=p>,</span> <span class=nx>Judge</span><span class=p>.</span><span class=nx>address</span><span class=p>)</span><span class=p>;</span><span class=p>}</span><span class=p>)</span>
<span class=kc>undefined</span>
<span class=nx>truffle</span><span class=p>(</span><span class=nx>development</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>Register</span><span class=p>.</span><span class=nx>deployed</span><span class=p>(</span><span class=p>)</span><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=p>{</span><span class=k>return</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>getContractAddr</span><span class=p>(</span><span class=s2>&#34;Judger&#34;</span><span class=p>)</span><span class=p>;</span><span class=p>}</span><span class=p>)</span>
<span class=s1>&#39;0x2C2Fb0DD2440e72318Fb018f923F78Ff86541D08&#39;</span>
</code></pre></td></tr></table></div></div><p>退出重新执行<code>truffle console</code>命令，进入<code>lightnode2</code>网络</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>truffle<span class=o>(</span>development<span class=o>)</span>&gt; .exit
$ truffle console --network lightnode2
</code></pre></td></tr></table></div></div><p>进入<code>lightnode2</code>的<code>truffle console</code>控制台，注册设备相关属性，然后查询属性进行验证</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode2</span><span class=p>)</span><span class=o>&gt;</span> <span class=kd>let</span> <span class=nx>instance</span> <span class=o>=</span> <span class=nx>await</span> <span class=nx>Register</span><span class=p>.</span><span class=nx>deployed</span><span class=p>(</span><span class=p>)</span>
<span class=kc>undefined</span>
<span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode2</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>subjectRegister</span><span class=p>(</span><span class=s2>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span><span class=p>,</span> <span class=s2>&#34;0xa31d40508da63fb00d7e2f4db57c3774384aa299&#34;</span><span class=p>,</span> <span class=s2>&#34;thermostat&#34;</span><span class=p>,</span> <span class=s2>&#34;subject&#34;</span><span class=p>)</span>
<span class=p>...</span>
<span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode2</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>getAttribute</span><span class=p>(</span><span class=s2>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span><span class=p>,</span> <span class=s2>&#34;deviceType&#34;</span><span class=p>)</span>
<span class=s1>&#39;thermostat&#39;</span>
<span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode2</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>getAttribute</span><span class=p>(</span><span class=s2>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span><span class=p>,</span> <span class=s2>&#34;deviceRole&#34;</span><span class=p>)</span>
<span class=s1>&#39;subject&#39;</span>
</code></pre></td></tr></table></div></div><p>退出<code>lightnode2</code>的控制台，进入<code>lightnode1</code>的控制台</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>truffle<span class=o>(</span>lightnode2<span class=o>)</span>&gt; .exit
$ truffle console --network lightnode1
</code></pre></td></tr></table></div></div><p>首先在RC中注册ACC</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode1</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>Register</span><span class=p>.</span><span class=nx>deployed</span><span class=p>(</span><span class=p>)</span><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=p>{</span><span class=nx>instance</span><span class=p>.</span><span class=nx>contractRegister</span><span class=p>(</span><span class=s2>&#34;Temperature_Sensor1&#34;</span><span class=p>,</span> <span class=s2>&#34;ACC&#34;</span><span class=p>,</span> <span class=s2>&#34;0x9a4aa696f85c6bf96733cc5385ccaf2b7ee13f17&#34;</span><span class=p>,</span> <span class=nx>AccessControl</span><span class=p>.</span><span class=nx>address</span><span class=p>)</span><span class=p>;</span><span class=p>}</span><span class=p>)</span>
<span class=kc>undefined</span>
<span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode1</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>Register</span><span class=p>.</span><span class=nx>deployed</span><span class=p>(</span><span class=p>)</span><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=p>{</span><span class=k>return</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>getContractAddr</span><span class=p>(</span><span class=s2>&#34;Temperature_Sensor1&#34;</span><span class=p>)</span><span class=p>;</span><span class=p>}</span><span class=p>)</span>
<span class=s1>&#39;0x05455fa63e5a7cb6575D75c99855cF3A1Adc72b1&#39;</span>
</code></pre></td></tr></table></div></div><p>然后在ACC中注册资源属性，并查询属性进行验证</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode1</span><span class=p>)</span><span class=o>&gt;</span> <span class=kd>let</span> <span class=nx>instance</span> <span class=o>=</span> <span class=nx>await</span> <span class=nx>AccessControl</span><span class=p>.</span><span class=nx>deployed</span><span class=p>(</span><span class=p>)</span>
<span class=kc>undefined</span>
<span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode1</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>resourceAttrAdd</span><span class=p>(</span><span class=s2>&#34;data&#34;</span><span class=p>,</span> <span class=s2>&#34;currentTemperature&#34;</span><span class=p>,</span> <span class=s2>&#34;23&#34;</span><span class=p>)</span>
<span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode1</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>getResourceAttr</span><span class=p>(</span><span class=s2>&#34;data&#34;</span><span class=p>,</span> <span class=s2>&#34;currentTemperature&#34;</span><span class=p>)</span>
<span class=s1>&#39;23&#39;</span>
</code></pre></td></tr></table></div></div><p>接下来针对已注册的属性，在ACC中设置访问控制策略，并查询策略进行验证</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode1</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>policyAdd</span><span class=p>(</span><span class=s2>&#34;data&#34;</span><span class=p>,</span> <span class=s2>&#34;read&#34;</span><span class=p>,</span> <span class=s2>&#34;subject&#34;</span><span class=p>,</span> <span class=s2>&#34;deviceType&#34;</span><span class=p>,</span> <span class=s2>&#34;=&#34;</span><span class=p>,</span> <span class=s2>&#34;thermostat&#34;</span><span class=p>)</span>
<span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode1</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>getPolicy</span><span class=p>(</span><span class=s2>&#34;data&#34;</span><span class=p>,</span> <span class=s2>&#34;read&#34;</span><span class=p>,</span> <span class=s2>&#34;deviceType&#34;</span><span class=p>)</span>
<span class=nx>Result</span> <span class=p>{</span>
  <span class=s1>&#39;0&#39;</span><span class=o>:</span> <span class=s1>&#39;subject&#39;</span><span class=p>,</span>
  <span class=s1>&#39;1&#39;</span><span class=o>:</span> <span class=s1>&#39;deviceType&#39;</span><span class=p>,</span>
  <span class=s1>&#39;2&#39;</span><span class=o>:</span> <span class=s1>&#39;=&#39;</span><span class=p>,</span>
  <span class=s1>&#39;3&#39;</span><span class=o>:</span> <span class=s1>&#39;thermostat&#39;</span><span class=p>,</span>
  <span class=nx>_attrOwner</span><span class=o>:</span> <span class=s1>&#39;subject&#39;</span><span class=p>,</span>
  <span class=nx>_attrName_</span><span class=o>:</span> <span class=s1>&#39;deviceType&#39;</span><span class=p>,</span>
  <span class=nx>_operator</span><span class=o>:</span> <span class=s1>&#39;=&#39;</span><span class=p>,</span>
  <span class=nx>_attrValue</span><span class=o>:</span> <span class=s1>&#39;thermostat&#39;</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>最后发起访问控制请求和监听依然使用web3.js完成，切换到web3目录下，首先新建<code>test.js</code>测试是否可使用，测试脚本内容如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=kd>var</span> <span class=nx>Web3</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;web3&#39;</span><span class=p>)</span><span class=p>;</span>

<span class=k>if</span><span class=p>(</span><span class=k>typeof</span> <span class=nx>web3</span> <span class=o>!==</span><span class=s1>&#39;undefined&#39;</span><span class=p>)</span><span class=p>{</span> <span class=c1>//检查是否已有web3实例
</span><span class=c1></span>    <span class=nx>web3</span><span class=o>=</span><span class=k>new</span> <span class=nx>Web3</span><span class=p>(</span><span class=nx>web3</span><span class=p>.</span><span class=nx>currentProvider</span><span class=p>)</span><span class=p>;</span>
<span class=p>}</span><span class=k>else</span><span class=p>{</span>
    <span class=c1>//否则就连接到给出节点
</span><span class=c1></span>    <span class=nx>web3</span><span class=o>=</span><span class=k>new</span> <span class=nx>Web3</span><span class=p>(</span><span class=p>)</span><span class=p>;</span>
    <span class=nx>web3</span><span class=p>.</span><span class=nx>setProvider</span><span class=p>(</span><span class=k>new</span> <span class=nx>Web3</span><span class=p>.</span><span class=nx>providers</span><span class=p>.</span><span class=nx>WebsocketProvider</span><span class=p>(</span><span class=s2>&#34;ws://localhost:8545&#34;</span><span class=p>)</span><span class=p>)</span><span class=p>;</span>
<span class=p>}</span><span class=p>;</span>

<span class=kd>var</span> <span class=nx>connect</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>web3</span><span class=p>.</span><span class=nx>eth</span><span class=p>.</span><span class=nx>getBlock</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>result</span><span class=p>)</span><span class=p>{</span>
        <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>error</span><span class=p>)</span>
            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;connection succeed&#34;</span><span class=p>)</span><span class=p>;</span>
        <span class=k>else</span>
            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;something wrong, connection failed&#34;</span><span class=p>)</span><span class=p>;</span>
    <span class=p>}</span><span class=p>)</span><span class=p>;</span>
<span class=p>}</span>


<span class=kd>var</span> <span class=nx>getAccount</span> <span class=o>=</span> <span class=nx>async</span> <span class=kd>function</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>await</span> <span class=nx>connect</span><span class=p>(</span><span class=p>)</span><span class=p>;</span>
    <span class=kd>var</span> <span class=nx>account0</span><span class=p>;</span>
    <span class=nx>web3</span><span class=p>.</span><span class=nx>eth</span><span class=p>.</span><span class=nx>getAccounts</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>result</span><span class=p>)</span><span class=p>{</span>
        <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>error</span><span class=p>)</span><span class=p>{</span>
            <span class=nx>account0</span><span class=o>=</span><span class=nx>result</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=p>;</span>
            <span class=c1>//console.log(account0);
</span><span class=c1></span>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;accounts:&#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>)</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>else</span><span class=p>{</span>
            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;failed to get Accoutns&#34;</span><span class=p>)</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span><span class=p>)</span><span class=p>;</span>
<span class=p>}</span>


<span class=nx>getAccount</span><span class=p>(</span><span class=p>)</span><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>web3</span><span class=p>.</span><span class=nx>eth</span><span class=p>.</span><span class=nx>getBalance</span><span class=p>(</span><span class=s2>&#34;0xbffe4ff0cbd0a7590fb71966d1e6bb1a4c2359e0&#34;</span><span class=p>)</span><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>balance</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;balance:&#39;</span><span class=p>,</span><span class=nx>balance</span><span class=p>)</span><span class=p>;</span>
        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;test passed!&#34;</span><span class=p>)</span><span class=p>;</span>
    <span class=p>}</span><span class=p>)</span>
<span class=p>}</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>测试结果如下，说明没有问题</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ node test.js
connection succeed
accounts:0xbfFe4ff0cBd0A7590Fb71966D1E6bb1a4c2359e0
balance: <span class=m>99999999999999999999999999999998000000000000000000</span>
<span class=nb>test</span> passed！
</code></pre></td></tr></table></div></div><p>在 web3 目录下新建<code>requester.js</code>文件和<code>monitor.js</code>文件，前者用来发起访问控制请求，后者用来监听访问控制触发的事件</p><p><code>requester.js</code>的内容如下，通过 websocket 连接 lightnode2，发起访问控制请求</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=kd>var</span> <span class=nx>Web3</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;web3&#39;</span><span class=p>)</span><span class=p>;</span>
<span class=kd>var</span> <span class=nx>readline</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;readline&#39;</span><span class=p>)</span><span class=p>;</span>
<span class=kd>var</span> <span class=nx>web3</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Web3</span><span class=p>(</span><span class=nx>Web3</span><span class=p>.</span><span class=nx>givenProvider</span> <span class=o>||</span> <span class=s2>&#34;ws://192.168.191.4:8545&#34;</span><span class=p>)</span><span class=p>;</span>

<span class=kd>var</span> <span class=nx>accAbi</span> <span class=o>=</span> <span class=p>[</span><span class=p>...</span><span class=p>]</span><span class=p>;</span>

<span class=kd>var</span> <span class=nx>accAddr</span> <span class=o>=</span> <span class=s2>&#34;0xb29094a4DE9c2E22b598b39fE38860b9117340A6&#34;</span>
<span class=kd>var</span> <span class=nx>myACC</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>web3</span><span class=p>.</span><span class=nx>eth</span><span class=p>.</span><span class=nx>Contract</span><span class=p>(</span><span class=nx>accAbi</span><span class=p>,</span> <span class=nx>accAddr</span><span class=p>)</span><span class=p>;</span>


<span class=kd>var</span> <span class=nx>previousTxHash</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<span class=kd>var</span> <span class=nx>currentTxHash</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

<span class=kd>var</span> <span class=nx>rl</span> <span class=o>=</span> <span class=nx>readline</span><span class=p>.</span><span class=nx>createInterface</span><span class=p>(</span><span class=p>{</span>
	<span class=nx>input</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>stdin</span><span class=p>,</span>
	<span class=nx>output</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>stdout</span><span class=p>,</span>
	<span class=nx>prompt</span><span class=o>:</span> <span class=s1>&#39;Send access request?(y/n)&#39;</span>
<span class=p>}</span><span class=p>)</span><span class=p>;</span>

<span class=nx>rl</span><span class=p>.</span><span class=nx>prompt</span><span class=p>(</span><span class=p>)</span><span class=p>;</span>
<span class=nx>rl</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;line&#39;</span><span class=p>,</span><span class=p>(</span><span class=nx>answer</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
	<span class=k>if</span><span class=p>(</span><span class=s1>&#39;y&#39;</span> <span class=o>==</span> <span class=nx>answer</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>myACC</span><span class=p>.</span><span class=nx>methods</span><span class=p>.</span><span class=nx>accessControl</span><span class=p>(</span><span class=s2>&#34;data&#34;</span><span class=p>,</span> <span class=s2>&#34;read&#34;</span><span class=p>)</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=p>{</span>
			<span class=nx>from</span><span class=o>:</span> <span class=s2>&#34;0xbd93271c5d2ccacdc307d1825614d5557ad6e0fd&#34;</span><span class=p>,</span>
			<span class=nx>gas</span><span class=o>:</span> <span class=mi>10000000</span><span class=p>,</span>
			<span class=nx>gasPrice</span><span class=o>:</span> <span class=mi>0</span>
		<span class=p>}</span><span class=p>,</span><span class=kd>function</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span><span class=nx>result</span><span class=p>)</span><span class=p>{</span>
			<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>error</span><span class=p>)</span><span class=p>{</span>
				<span class=nx>currentTxHash</span> <span class=o>=</span> <span class=nx>result</span>
				<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;currentTxHash: &#34;</span><span class=p>,</span> <span class=nx>result</span><span class=p>)</span>
			<span class=p>}</span>
		<span class=p>}</span><span class=p>)</span>

	<span class=nx>myACC</span><span class=p>.</span><span class=nx>events</span><span class=p>.</span><span class=nx>ReturnAccessResult</span><span class=p>(</span><span class=p>{</span>
			<span class=nx>fromBlock</span><span class=o>:</span> <span class=mi>0</span>
		<span class=p>}</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>result</span><span class=p>)</span><span class=p>{</span>
		<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
			<span class=k>if</span><span class=p>(</span><span class=nx>previousTxHash</span> <span class=o>!=</span> <span class=nx>result</span><span class=p>.</span><span class=nx>transactionHash</span> <span class=o>&amp;&amp;</span> <span class=nx>currentTxHash</span> <span class=o>==</span> <span class=nx>result</span><span class=p>.</span><span class=nx>transactionHash</span><span class=p>)</span> <span class=p>{</span>
				<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Contract: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>address</span><span class=p>)</span><span class=p>;</span>
				<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Block Number: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>blockNumber</span><span class=p>)</span><span class=p>;</span>
				<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Tx Hash: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>transactionHash</span><span class=p>)</span><span class=p>;</span>
				<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Block Hash: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>blockHash</span><span class=p>)</span><span class=p>;</span>
				<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Time: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>returnValues</span><span class=p>.</span><span class=nx>_time</span><span class=p>)</span><span class=p>;</span>
				<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Message: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>returnValues</span><span class=p>.</span><span class=nx>_errmsg</span><span class=p>)</span><span class=p>;</span>
				<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Result: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>returnValues</span><span class=p>.</span><span class=nx>_result</span><span class=p>)</span><span class=p>;</span>
				<span class=k>if</span> <span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>returnValues</span><span class=p>.</span><span class=nx>_penalty</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
					<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Requests are blocked for &#34;</span> <span class=o>+</span> <span class=nx>result</span><span class=p>.</span><span class=nx>returnValues</span><span class=p>.</span><span class=nx>_penalty</span> <span class=o>+</span><span class=s2>&#34;seconds!&#34;</span><span class=p>)</span>
				<span class=p>}</span>
				<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;\n&#39;</span><span class=p>)</span><span class=p>;</span>
				<span class=nx>previousTxHash</span> <span class=o>=</span> <span class=nx>result</span><span class=p>.</span><span class=nx>transactionHash</span><span class=p>;</span>
				<span class=nx>rl</span><span class=p>.</span><span class=nx>prompt</span><span class=p>(</span><span class=p>)</span><span class=p>;</span>
			<span class=p>}</span>
		<span class=p>}</span>
	<span class=p>}</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=k>else</span><span class=p>{</span>
	<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;access request doesn&#39;t send!&#34;</span><span class=p>)</span>
	<span class=nx>rl</span><span class=p>.</span><span class=nx>prompt</span><span class=p>(</span><span class=p>)</span><span class=p>;</span>
	<span class=p>}</span>
<span class=p>}</span><span class=p>)</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;close&#39;</span><span class=p>,</span><span class=p>(</span><span class=p>)</span> <span class=p>=&gt;</span><span class=p>{</span>
	<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;All actions had executed!&#39;</span><span class=p>)</span><span class=p>;</span>
	<span class=nx>process</span><span class=p>.</span><span class=nx>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=p>;</span>
<span class=p>}</span><span class=p>)</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><p><code>monitor.js</code>的内容如下，由 lightnode1 发起，用于监听返回的事件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=kd>var</span> <span class=nx>Web3</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;web3&#39;</span><span class=p>)</span><span class=p>;</span>
<span class=kd>var</span> <span class=nx>web3</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Web3</span><span class=p>(</span><span class=nx>Web3</span><span class=p>.</span><span class=nx>givenProvider</span> <span class=o>||</span> <span class=s2>&#34;ws://192.168.191.3:8545&#34;</span><span class=p>)</span><span class=p>;</span>

<span class=kd>var</span> <span class=nx>accAbi</span> <span class=o>=</span> <span class=p>[</span><span class=p>...</span><span class=p>]</span><span class=p>;</span>
<span class=kd>var</span> <span class=nx>accAddr</span> <span class=o>=</span> <span class=s2>&#34;0xb29094a4DE9c2E22b598b39fE38860b9117340A6&#34;</span><span class=p>;</span>
<span class=kd>var</span> <span class=nx>myACC</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>web3</span><span class=p>.</span><span class=nx>eth</span><span class=p>.</span><span class=nx>Contract</span><span class=p>(</span><span class=nx>accAbi</span><span class=p>,</span> <span class=nx>accAddr</span><span class=p>)</span><span class=p>;</span>

<span class=nx>myACC</span><span class=p>.</span><span class=nx>events</span><span class=p>.</span><span class=nx>ReturnAccessResult</span><span class=p>(</span><span class=p>{</span>
	<span class=nx>fromBlock</span><span class=o>:</span> <span class=mi>0</span>
<span class=p>}</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>result</span><span class=p>)</span><span class=p>{</span>
		<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
			<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Contract: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>address</span><span class=p>)</span><span class=p>;</span>
			<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Block Number: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>blockNumber</span><span class=p>)</span><span class=p>;</span>
			<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Tx Hash: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>transactionHash</span><span class=p>)</span><span class=p>;</span>
			<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Block Hash: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>blockHash</span><span class=p>)</span><span class=p>;</span>
			<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Time: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>returnValues</span><span class=p>.</span><span class=nx>_time</span><span class=p>)</span><span class=p>;</span>
			<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Message: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>returnValues</span><span class=p>.</span><span class=nx>_errmsg</span><span class=p>)</span><span class=p>;</span>
			<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Result: &#34;</span><span class=o>+</span><span class=nx>result</span><span class=p>.</span><span class=nx>returnValues</span><span class=p>.</span><span class=nx>_result</span><span class=p>)</span><span class=p>;</span>
			<span class=k>if</span> <span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>returnValues</span><span class=p>.</span><span class=nx>_penalty</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
				<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Requests are blocked for &#34;</span> <span class=o>+</span> <span class=nx>result</span><span class=p>.</span><span class=nx>returnValues</span><span class=p>.</span><span class=nx>_penalty</span> <span class=o>+</span><span class=s2>&#34;seconds!&#34;</span><span class=p>)</span>
			<span class=p>}</span>
			<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;\n&#39;</span><span class=p>)</span><span class=p>;</span>
		<span class=p>}</span>
<span class=p>}</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>实验结果如下</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81cdmj.png alt="request access authorized" class=lazyload><figcaption class=image-caption>request access authorized</figcaption></figure></p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81c6pT.png alt="monitor access authorized" class=lazyload><figcaption class=image-caption>monitor access authorized</figcaption></figure></p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81gC38.png alt="request blocked" class=lazyload><figcaption class=image-caption>request blocked</figcaption></figure></p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81g8b9.png alt="monitor request blocked" class=lazyload><figcaption class=image-caption>monitor request blocked</figcaption></figure></p><a class=post-dummy-target id=36-错误测试></a><h3>3.6 错误测试</h3><p>之前的实验验证的是访问权限被授予的情况，现在测试被拒绝的情况</p><p>在 lightnode2 建立新的IoT设备账户，这次代表摄像头(Camera)，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>&gt; personal.newAccount<span class=o>(</span><span class=o>)</span>
Passphrase: 
Repeat passphrase: 
<span class=s2>&#34;0x42b97b26ed5f53693bcc9b58ad8c724718ea0a15&#34;</span>
&gt; personal.listAccounts
<span class=o>[</span><span class=s2>&#34;0xa31d40508da63fb00d7e2f4db57c3774384aa299&#34;</span>, <span class=s2>&#34;0x016b71d115f1da36de58d2b78369fd3228bef3dd&#34;</span>, <span class=s2>&#34;0x42b97b26ed5f53693bcc9b58ad8c724718ea0a15&#34;</span><span class=o>]</span>
&gt; personal.unlockAccount<span class=o>(</span>eth.accounts<span class=o>[</span>0<span class=o>]</span><span class=o>)</span>
Unlock account 0xa31d40508da63fb00d7e2f4db57c3774384aa299
Passphrase: 
<span class=nb>true</span>
&gt; eth.sendTransaction<span class=o>(</span><span class=o>{</span>from:eth.accounts<span class=o>[</span>0<span class=o>]</span>,to:eth.accounts<span class=o>[</span>2<span class=o>]</span>,value:1*1e7<span class=o>}</span><span class=o>)</span>
<span class=s2>&#34;0x9f36de89d44db23e63e4fa0d3135d1c17e800cca73f0661ae276f20c0e3d1902&#34;</span>
&gt; eth.getBalance<span class=o>(</span>eth.accounts<span class=o>[</span>2<span class=o>]</span><span class=o>)</span>
<span class=m>10000000</span>
</code></pre></td></tr></table></div></div><p>修改<code>truffle-config.js</code>文件中 lightnode2 网络的执行账户为新建立的账户</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>...</span>
<span class=nx>lightnode2</span><span class=o>:</span> <span class=p>{</span>
  <span class=nx>host</span><span class=o>:</span> <span class=s2>&#34;192.168.191.4&#34;</span><span class=p>,</span>  
  <span class=nx>port</span><span class=o>:</span> <span class=mi>22000</span><span class=p>,</span>            <span class=c1>// Standard Ethereum port (default: none)
</span><span class=c1></span>  <span class=nx>network_id</span><span class=o>:</span> <span class=s2>&#34;10&#34;</span><span class=p>,</span>       
  <span class=nx>gasPrice</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
  <span class=nx>gas</span><span class=o>:</span> <span class=mi>10000000</span><span class=p>,</span>
  <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;quorum&#34;</span><span class=p>,</span>
  <span class=nx>from</span><span class=o>:</span> <span class=s2>&#34;0x42b97b26ed5f53693bcc9b58ad8c724718ea0a15&#34;</span><span class=p>,</span>
 <span class=p>...</span>
</code></pre></td></tr></table></div></div><p>进入<code>lightnode2</code>的 truffle console</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>cd</span> AC
$ truffle console --network lightnode2
</code></pre></td></tr></table></div></div><p>注册新设备的属性</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode2</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>Register</span><span class=p>.</span><span class=nx>deployed</span><span class=p>(</span><span class=p>)</span><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=p>{</span><span class=nx>instance</span><span class=p>.</span><span class=nx>subjectRegister</span><span class=p>(</span><span class=s2>&#34;0x42b97b26ed5f53693bcc9b58ad8c724718ea0a15&#34;</span><span class=p>,</span><span class=s2>&#34;0xa31d40508da63fb00d7e2f4db57c3774384aa299&#34;</span><span class=p>,</span> <span class=s2>&#34;camera&#34;</span><span class=p>,</span> <span class=s2>&#34;subject&#34;</span><span class=p>)</span><span class=p>;</span><span class=p>}</span><span class=p>)</span>
<span class=kc>undefined</span>
<span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode2</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>Register</span><span class=p>.</span><span class=nx>deployed</span><span class=p>(</span><span class=p>)</span><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=p>{</span><span class=nx>instance</span><span class=p>.</span><span class=nx>getAttribute</span><span class=p>(</span><span class=s2>&#34;0x42b97b26ed5f53693bcc9b58ad8c724718ea0a15&#34;</span><span class=p>,</span><span class=s2>&#34;deviceType&#34;</span><span class=p>)</span><span class=p>;</span><span class=p>}</span><span class=p>)</span>
<span class=s1>&#39;camera&#39;</span>
<span class=nx>truffle</span><span class=p>(</span><span class=nx>lightnode2</span><span class=p>)</span><span class=o>&gt;</span> <span class=nx>Register</span><span class=p>.</span><span class=nx>deployed</span><span class=p>(</span><span class=p>)</span><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=p>{</span><span class=nx>instance</span><span class=p>.</span><span class=nx>getAttribute</span><span class=p>(</span><span class=s2>&#34;0x42b97b26ed5f53693bcc9b58ad8c724718ea0a15&#34;</span><span class=p>,</span><span class=s2>&#34;deviceRole&#34;</span><span class=p>)</span><span class=p>;</span><span class=p>}</span><span class=p>)</span>
<span class=s1>&#39;subject&#39;</span>
</code></pre></td></tr></table></div></div><p>建立<code>requester2.js</code>，内容和<code>requester.js</code>相似，只是发起访问控制的是<code>lightnode2</code>新建立的<code>camera</code>设备账户，也就是说与requester.js的不同仅在于发起访问控制的账户</p><p>错误测试的结果如下</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81gQvF.png alt="request static check failed" class=lazyload><figcaption class=image-caption>request static check failed</figcaption></figure></p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20200115_81gK3T.png alt="monitor static check failed" class=lazyload><figcaption class=image-caption>monitor static check failed</figcaption></figure></p><a class=post-dummy-target id=37-步骤总结></a><h3>3.7 步骤总结</h3><p>总结一下本篇中需要做的事情</p><ol><li>node0 部署RC，获取RC合约地址</li><li>node0 部署JC，传入参数base=2、interval=3，获取JC的合约地址</li><li>JC 合约在RC中注册</li><li>node0 分别转给lightnode1和lightnode2 1 ether</li><li>lightnode1 新建IoT设备账户，从第一个账户向该账户转入1000 0000wei</li><li>lightnode2 新建两个IoT设备账户，从第一个账户分别向这两个账户转入1000 0000wei</li><li>lightnode2 的两个IoT设备账户在RC中注册设备属性(事实上所有节点都应注册设备属性，这里是因为实验只需要它们两个发起访问控制)</li><li>lightnode1 的IoT设备账户部署ACC，传入RC和JC的合约地址，获取ACC的合约地址</li><li>lightnode1 在RC中注册ACC</li><li>lightnode1 在ACC中注册资源属性，设置访问控制策略</li><li>lingtnode2 的两个IoT设备通过调用ACC向lightnode1的IoT设备发起访问控制</li></ol></div><div class=post-copyright id=post-footer><p class=copyright-item><span>Author:&nbsp;</span>
<span>shuzang</span></p><p class=copyright-item><span>Updated on:&nbsp;</span>
<span>2020-11-24</span></p><p class=copyright-item><span>Share on:&nbsp;</span>
<span><a href="//twitter.com/share?url=https%3a%2f%2fshuzang.github.io%2f2020%2foptimize-the-implementation-and-testing-of-the-system%2f&text=%e7%a0%94%e7%a9%b6%e8%ae%b0%e5%bd%9511-%e6%96%b0%e8%ae%bf%e9%97%ae%e6%8e%a7%e5%88%b6%e6%96%b9%e6%a1%88%e7%9a%84%e5%ae%9e%e7%8e%b0%e4%b8%8e%e6%b5%8b%e8%af%95&via=" target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-fw"></i></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fshuzang.github.io%2f2020%2foptimize-the-implementation-and-testing-of-the-system%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook-square fa-fw"></i></a><a href="//reddit.com/submit?url=https%3a%2f%2fshuzang.github.io%2f2020%2foptimize-the-implementation-and-testing-of-the-system%2f&title=%e7%a0%94%e7%a9%b6%e8%ae%b0%e5%bd%9511-%e6%96%b0%e8%ae%bf%e9%97%ae%e6%8e%a7%e5%88%b6%e6%96%b9%e6%a1%88%e7%9a%84%e5%ae%9e%e7%8e%b0%e4%b8%8e%e6%b5%8b%e8%af%95" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-fw"></i></a></span></p><p class=copyright-item></p><p class=copyright-item></p></div><br><div class=post-info-more><section><span class=tag><a href=https://shuzang.github.io/tags/%E7%A7%91%E7%A0%94%E8%AE%B0%E5%BD%95/><i class="fas fa-tag fa-fw"></i>&nbsp;科研记录</a>&nbsp;</span></section><section><span><a href=javascript:window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=https://shuzang.github.io>Home</a></span></section></div><div class=post-nav><a href=https://shuzang.github.io/2020/life-weekly-2/ class=prev rel=prev title="书藏的生活周刊第 2 期 (20200110)"><i class="fas fa-angle-left fa-fw"></i>书藏的生活周刊第 2 期 (20200110)</a>
<a href=https://shuzang.github.io/2020/life-weekly-3/ class=next rel=next title="书藏的生活周刊第 3 期 (20200117)">书藏的生活周刊第 3 期 (20200117)<i class="fas fa-angle-right fa-fw"></i></a></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright><div class=copyright-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://shuzang.github.io/about/ target=_blank>shuzang</a> | </span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a> & <a href=https://github.com/dillonzq/LoveIt target=_blank rel="external nofollow noopener noreffer">LoveIt</a></div></div></footer></div><a href=# class=dynamic-to-top id=dynamic-to-top data-scroll><span>&nbsp;</span></a>
<script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-209130979-1','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=/js/lib/jquery/jquery.slim.min.js></script><script src=/js/lib/lazysizes/lazysizes.min.js></script><script src=/js/lib/smooth-scroll/smooth-scroll.polyfills.min.js></script><script>window.scroll=new SmoothScroll('[data-scroll]',{speed:300,speedAsDuration:true});</script><link rel=stylesheet href=/css/lib/katex/katex.min.css><script src=/js/lib/katex/katex.min.js></script><script defer src=/js/lib/katex/auto-render.min.js></script><link rel=stylesheet href=/css/lib/katex/copy-tex.min.css><script defer src=/js/lib/katex/copy-tex.min.js></script><script defer src=/js/lib/katex/mhchem.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:true},{left:"\\(",right:"\\)",display:false},{left:"\\[",right:"\\]",display:true},{left:"$",right:"$",display:false},]});});</script><script src=/js/blog.min.js></script></body></html>