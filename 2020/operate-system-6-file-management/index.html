<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>操作系统6-文件管理 | Shuzang's Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=Description content="书藏的个人博客，包括Golang、数据结构、算法的学习记录，各类生活技能的学习，每周五发布一期自己的生活周刊"><link rel=prev href=https://shuzang.github.io/2020/operate-system-5-device-management/><link rel=next href=https://shuzang.github.io/2020/bash-script-grammer-1/><link rel=canonical href=https://shuzang.github.io/2020/operate-system-6-file-management/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta name=twitter:card content="summary"><meta name=twitter:title content="操作系统6-文件管理"><meta name=twitter:description content="本篇介绍文件管理相关的内容。包括硬盘结构、文件和目录的概念，以及一个文件系统涉及的其它知识。"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"操作系统6-文件管理","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/shuzang.github.io\/2020\/operate-system-6-file-management\/"},"image":{"@type":"ImageObject","url":"https:\/\/shuzang.github.io\/cover.png","width":800,"height":600},"genre":"posts","keywords":"计算机基础","wordcount":4280,"url":"https:\/\/shuzang.github.io\/2020\/operate-system-6-file-management\/","datePublished":"2020-08-18T08:18:00\x2b08:00","dateModified":"2020-08-18T00:00:00\x2b00:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"shuzang","logo":{"@type":"ImageObject","url":"https:\/\/shuzang.github.io\/logo.png","width":127,"height":40}},"description":""}</script><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/lib/fontawesome-free/all.min.css></head><body><script>window.isDark=(window.localStorage&&window.localStorage.getItem('theme'))==='dark';window.isDark&&document.body.classList.add('dark-theme');</script><div class=wrapper><nav class=navbar><div class=top-scroll-bar></div><div class=navbar-container><div class="navbar-header animated bounceIn"><a href=https://shuzang.github.io>Shuzang's Blog</a></div><div class=navbar-menu><a class=menu-item href=https://shuzang.github.io/posts>Posts</a><a class=menu-item href=https://shuzang.github.io/tags>Tags</a><a class=menu-item href=https://shuzang.github.io/categories>Categories</a><a class=menu-item href=https://shuzang.github.io/about>About</a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><nav class=navbar-mobile><div class=top-scroll-bar></div><div class=navbar-container><div class=navbar-header><div class="navbar-header-title animated bounceIn"><a href=https://shuzang.github.io>Shuzang's Blog</a></div><div class=menu-toggle id=menu-toggle><span></span><span></span><span></span></div></div><div class=navbar-menu id=mobile-menu><a class=menu-item href=https://shuzang.github.io/posts>Posts</a><a class=menu-item href=https://shuzang.github.io/tags>Tags</a><a class=menu-item href=https://shuzang.github.io/categories>Categories</a><a class=menu-item href=https://shuzang.github.io/about>About</a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><main class=main><div class=container><article class=page><h1 class="post-title animated flipInX">操作系统6-文件管理</h1><div class=post-meta><i class="far fa-calendar-alt fa-fw"></i>published on&nbsp;<time datetime=2020-08-18>2020-08-18</time>&nbsp;
<i class="fas fa-pencil-alt fa-fw"></i>about 4280 words&nbsp;<span class=post-category><i class="far fa-folder fa-fw"></i>included in&nbsp;<a href=https://shuzang.github.io/categories/%E7%88%B1%E7%BC%96%E7%A8%8B%E7%88%B1%E6%8A%80%E6%9C%AF%E7%9A%84%E5%AD%A9%E5%AD%90/>爱编程爱技术的孩子</a>&nbsp;</span></div><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#1-硬盘结构>1. 硬盘结构</a></li><li><a href=#2-文件与inode>2. 文件与inode</a><ul><li><a href=#21-inode大小>2.1 inode大小</a></li><li><a href=#22-inode号>2.2 inode号</a></li></ul></li><li><a href=#3-目录>3. 目录</a></li><li><a href=#4-软链接和硬链接>4. 软链接和硬链接</a><ul><li><a href=#41-硬链接>4.1 硬链接</a></li><li><a href=#42-软链接>4.2 软链接</a></li></ul></li><li><a href=#5-文件系统实例>5. 文件系统实例</a><ul><li><a href=#51-基本结构>5.1 基本结构</a></li><li><a href=#52-挂载>5.2 挂载</a></li><li><a href=#53-文件读取>5.3 文件读取</a></li></ul></li></ul></nav></div></div><div class=post-toc-mobile id=post-toc-mobile><details><summary><div class=post-toc-title><span>Contents</span>
<span><i class="details icon fas fa-angle-down"></i></span></div></summary><div class=post-toc-content><nav id=TableOfContentsMobile><ul><li><a href=#1-硬盘结构>1. 硬盘结构</a></li><li><a href=#2-文件与inode>2. 文件与inode</a><ul><li><a href=#21-inode大小>2.1 inode大小</a></li><li><a href=#22-inode号>2.2 inode号</a></li></ul></li><li><a href=#3-目录>3. 目录</a></li><li><a href=#4-软链接和硬链接>4. 软链接和硬链接</a><ul><li><a href=#41-硬链接>4.1 硬链接</a></li><li><a href=#42-软链接>4.2 软链接</a></li></ul></li><li><a href=#5-文件系统实例>5. 文件系统实例</a><ul><li><a href=#51-基本结构>5.1 基本结构</a></li><li><a href=#52-挂载>5.2 挂载</a></li><li><a href=#53-文件读取>5.3 文件读取</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>本篇介绍文件管理相关的内容。包括硬盘结构、文件和目录的概念，以及一个文件系统涉及的其它知识。</p><a class=post-dummy-target id=1-硬盘结构></a><h2>1. 硬盘结构</h2><p>硬盘是计算机最主要的外部存储设备，尽管常见的存储设备还有光盘、U盘等，但最常用的还是硬盘。目前，我们所见的硬盘主要有机械硬盘和固态硬盘两类，前者使用磁性盘片来存储数据，后者使用闪存颗粒存储数据。</p><p>机械硬盘主要的组成包括磁盘片、主轴、磁盘臂、磁头等。如下图所示，硬盘中有大量的磁盘片，所有的盘片通过主轴连接在一起，主轴连接到一个电机，以恒定的速率旋转。每个磁盘片有两面，数据在这两面上持久存储，通过磁头可以读取表面的数据。磁盘转动时，磁头所走过的路径会形成一个圆形，叫做磁道，每个磁盘片都有数百上千的磁道，另外，人们把所有磁盘片的相同磁道称作一个柱面。最后，为了便于读写，人们还将每个磁盘片划分为一些相等大小的扇区，一个扇区 512 字节。不过，操作系统读取硬盘的时候，不会一个个扇区地读取，这样效率太低，而是一次性连续读取多个扇区，即一次性读取一个"块&rdquo;（block）。这种由多个扇区组成的"块&rdquo;，是文件存取的最小单位。&ldquo;块"的大小，最常见的是4KB，即连续八个 sector组成一个 block。</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20200818_1597710757496.jpg alt class=lazyload></figure></p><p>固态硬盘不再使用盘片，而是使用某种存储芯片作为存储介质，基本原理是对电荷的存储。固态硬盘在大部分方面都比机械硬盘表现好。固态硬盘已经没有了磁道、柱面等概念，物理单位是一个个的闪存颗粒，每个闪存颗粒由成千上万大小相同的块（Block）组成，块的大小一般为数百 KB 到数 MB，每一个块的内部又分为若干个大小相同的页（Page），页的大小一般为 4KB 或者 8KB。页是基本的读写单位，块是数据擦除的基本单位。</p><p>更大关于固态硬盘的知识可以参考 <a href=https://zhuanlan.zhihu.com/p/114237145 target=_blank>知乎，详解固态硬盘的有趣知识及其底层原理</a></p><a class=post-dummy-target id=2-文件与inode></a><h2>2. 文件与inode</h2><p>可参考：<a href=http://www.ruanyifeng.com/blog/2011/12/inode.html target=_blank>阮一峰，理解inode</a></p><p>文件（file）是一个抽象的概念，最底层就是一串二进制0和1，高一点可以看作一个字节序列，其中每个字节都可以读取或写入。在更高一点的层次，我们用一个叫做 inode 的结构记录关于文件的一些元信息，这个结构的定义可以举个例子</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=k>struct</span> <span class=n>stat</span> <span class=p>{</span>
    <span class=n>dev_t</span> <span class=n>st_dev</span><span class=p>;</span>         <span class=c1>// ID of device containing file
</span><span class=c1></span>    <span class=n>ino_t</span> <span class=n>st_ino</span><span class=p>;</span>         <span class=c1>// inode number
</span><span class=c1></span>    <span class=n>mode_t</span> <span class=n>st_mode</span><span class=p>;</span>       <span class=c1>// protection
</span><span class=c1></span>    <span class=n>nlink_t</span> <span class=n>st_nlink</span><span class=p>;</span>     <span class=c1>// number of hard links
</span><span class=c1></span>    <span class=n>uid_t</span> <span class=n>st_uid</span><span class=p>;</span>         <span class=c1>// user ID of owner
</span><span class=c1></span>    <span class=n>gid_t</span> <span class=n>st_gid</span><span class=p>;</span>         <span class=c1>// group ID of owner
</span><span class=c1></span>    <span class=n>dev_t</span> <span class=n>st_rdev</span><span class=p>;</span>        <span class=c1>// device ID(if special file)
</span><span class=c1></span>    <span class=n>off_t</span> <span class=n>st_size</span><span class=p>;</span>        <span class=c1>// total size, in bytes
</span><span class=c1></span>    <span class=n>blksize_t</span> <span class=n>st_blksize</span><span class=p>;</span> <span class=c1>// blocksize for filesystem I/O
</span><span class=c1></span>    <span class=n>blkcnt_t</span> <span class=n>st_blocks</span><span class=p>;</span>   <span class=c1>// number of blocks allocated
</span><span class=c1></span>    <span class=n>time_t</span> <span class=n>st_atime</span><span class=p>;</span>      <span class=c1>// time of last access
</span><span class=c1></span>    <span class=n>time_t</span> <span class=n>st_mtime</span><span class=p>;</span>      <span class=c1>// time of last modification
</span><span class=c1></span>    <span class=n>time_t</span> <span class=n>st_ctime</span><span class=p>;</span>      <span class=c1>// time of last status change
</span><span class=c1></span><span class=p>}</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><p>我们可以看到主要包含的内容有：inode 号、保护信息（即文件权限）、链接数、文件拥有者的用户 ID 和所在的组 ID、文件总字节数、I/O 读取的单个 Block 大小、底层数据块的位置、实际信息等。</p><p>使用 <code>stat</code> 命令可以读取到这些信息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ stat foo
  文件：foo
  大小：6         	块：8          IO 块：4096   普通文件
设备：805h/2053d	Inode：5767595     硬链接：1
权限：<span class=o>(</span>0664/-rw-rw-r--<span class=o>)</span>  Uid：<span class=o>(</span> 1000/ shuzang<span class=o>)</span>   Gid：<span class=o>(</span> 1000/ shuzang<span class=o>)</span>
最近访问：2020-08-22 19:00:39.660722364 -0700
最近更改：2020-08-22 19:00:29.121819131 -0700
最近改动：2020-08-22 19:00:29.121819131 -0700
创建时间：-
</code></pre></td></tr></table></div></div><p>注意，inode 对底层数据块的引用一般是通过指针完成的，每个指针指向一个磁盘块，为了包含更多的数据，指针可以指向另一个完全由指针组成的块，使用间接指针的方式扩大包含的数据量。通常来讲，inode 中会设置一定数量的直接指针和一个间接指针。</p><a class=post-dummy-target id=21-inode大小></a><h3>2.1 inode大小</h3><p>inode 本身的存储也占据硬盘空间，所以硬盘至少会有两个区：数据区存放文件数据，inode 区存放所有 inode。不过我们习惯将存放 inode 的区域称作 inode 表。</p><p>由于 inode 的内容不多且比较固定，所以其大小也是固定的， 一般是128字节或256字节。</p><p>使用 <code>df</code> 命令可以查看每个硬盘分区的 inode 总数和使用情况</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ df -i
文件系统         Inode 已用<span class=o>(</span>I<span class=o>)</span> 可用<span class=o>(</span>I<span class=o>)</span> 已用<span class=o>(</span>I<span class=o>)</span>% 挂载点
udev            <span class=m>493235</span>     <span class=m>477</span>  <span class=m>492758</span>       1% /dev
tmpfs           <span class=m>500276</span>     <span class=m>938</span>  <span class=m>499338</span>       1% /run
/dev/sda5      <span class=m>6520832</span>  <span class=m>233720</span> <span class=m>6287112</span>       4% /
tmpfs           <span class=m>500276</span>       <span class=m>1</span>  <span class=m>500275</span>       1% /dev/shm
tmpfs           <span class=m>500276</span>       <span class=m>5</span>  <span class=m>500271</span>       1% /run/lock
tmpfs           <span class=m>500276</span>      <span class=m>18</span>  <span class=m>500258</span>       1% /sys/fs/cgroup
/dev/loop0        <span class=m>4338</span>    <span class=m>4338</span>       <span class=m>0</span>     100% /snap/code/39
/dev/loop2       <span class=m>12796</span>   <span class=m>12796</span>       <span class=m>0</span>     100% /snap/core/9804
/dev/loop3       <span class=m>10775</span>   <span class=m>10775</span>       <span class=m>0</span>     100% /snap/core18/1885
/dev/loop5       <span class=m>10756</span>   <span class=m>10756</span>       <span class=m>0</span>     100% /snap/core18/1880
/dev/loop1       <span class=m>12862</span>   <span class=m>12862</span>       <span class=m>0</span>     100% /snap/core/9665
/dev/loop4       <span class=m>24339</span>   <span class=m>24339</span>       <span class=m>0</span>     100% /snap/gnome-3-34-1804/33
/dev/loop6       <span class=m>24339</span>   <span class=m>24339</span>       <span class=m>0</span>     100% /snap/gnome-3-34-1804/36
/dev/loop8       <span class=m>10206</span>   <span class=m>10206</span>       <span class=m>0</span>     100% /snap/go/6123
/dev/loop12        <span class=m>463</span>     <span class=m>463</span>       <span class=m>0</span>     100% /snap/snapd/8542
/dev/loop9       <span class=m>62342</span>   <span class=m>62342</span>       <span class=m>0</span>     100% /snap/gtk-common-themes/1506
/dev/loop11      <span class=m>15827</span>   <span class=m>15827</span>       <span class=m>0</span>     100% /snap/snap-store/467
/dev/loop13        <span class=m>465</span>     <span class=m>465</span>       <span class=m>0</span>     100% /snap/snapd/8790
/dev/loop10      <span class=m>15827</span>   <span class=m>15827</span>       <span class=m>0</span>     100% /snap/snap-store/433
/dev/sda1            <span class=m>0</span>       <span class=m>0</span>       <span class=m>0</span>        - /boot/efi
tmpfs           <span class=m>500276</span>      <span class=m>89</span>  <span class=m>500187</span>       1% /run/user/1000
/dev/loop14       <span class=m>4303</span>    <span class=m>4303</span>       <span class=m>0</span>     100% /snap/code/40
/dev/loop15      <span class=m>10206</span>   <span class=m>10206</span>       <span class=m>0</span>     100% /snap/go/6274
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=22-inode号></a><h3>2.2 inode号</h3><p>每个 inode 都有一个 inode 号，它被操作系统用来识别文件。</p><p>我们应该清除的是，文件名只是为了方便用户使用，操作系统对文件的操作本质是通过 inode。举个例子，当我们打开文件的时候，系统首先通过文件名找到 inode 号，然后通过 inode 号获取 inode 信息，最后根据 inode 信息找到文件数据所在的 block，读取数据。</p><p>通过 inode 号找 inode 的例子如下图，假设 inode 表大小为 20KB，由 80 个 inode 组成，inode 区域从 12KB 开始（即超级块从 0KB 开始，inode 位示图在 4KB 位置，数据位示图在 8KB位置）。要读取 inode 号 32，文件系统首先计算 inode 区域偏移量（32×inode大小，即 8192），将它加上磁盘 inode 表的起始地址（12KB），从而得到希望的 inode 块的正确字节地址：20KB。</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20200818_epub_30179184_249.jfif alt class=lazyload></figure></p><p>使用 <code>ls -i</code> 命令可以查看文件名对应的 inode 号</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ ls -i foo
<span class=m>5767595</span> foo
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=3-目录></a><h2>3. 目录</h2><p>目录也是一种文件，但它的内容比较具体，存储的是它所包含的文件的文件名和对应的 inode 号。该内容用抽象数据结构来表达如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=k>struct</span> <span class=n>dirent</span> <span class=p>{</span>
    <span class=kt>char</span> <span class=n>d_name</span><span class=p>[</span><span class=mi>256</span><span class=p>]</span><span class=p>;</span>     <span class=c1>// filename
</span><span class=c1></span>    <span class=n>ino_t</span> <span class=n>d_ino</span><span class=p>;</span>          <span class=c1>// inode number
</span><span class=c1></span>    <span class=n>off_t</span> <span class=n>d_off</span><span class=p>;</span>          <span class=c1>// offset to the next dirent
</span><span class=c1></span>    <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>d_reclen</span><span class=p>;</span>    <span class=c1>// length of this record
</span><span class=c1></span>    <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>d_type</span><span class=p>;</span>       <span class=c1>// type of file
</span><span class=c1></span><span class=p>}</span>
</code></pre></td></tr></table></div></div><p>举个例子，foo 文件的 inode 号为 10，则目录的内容中会有一条 （foo, 10） 的记录。但我们要记得，目录也是一个文件，因此目录也有自己的 inode。</p><p>注1：目录的层次结构从根目录（/）开始，由根文件系统产生。</p><p>注2：移动文件或重命名文件，只是改变文件名，不改变 inode 号。</p><p>注3：通常来说，系统无法从inode号码得知文件名</p><a class=post-dummy-target id=4-软链接和硬链接></a><h2>4. 软链接和硬链接</h2><a class=post-dummy-target id=41-硬链接></a><h3>4.1 硬链接</h3><p>一般情况下，文件名和 inode 号之间是一一对应的关系，但我们可以令多个文件名指向同一个 inode 号。这种情况就叫<strong>硬链接</strong>。硬链接的本质是增加了一个对应关系，没有改变 inode 和底层数据，这意味着我们使用不同的文件名访问到的是同一个文件，修改和删除数据也会影响到所有文件名。</p><p>Linux 中使用 <code>ln</code> 命令建立硬链接。</p><p>inode 结构中有一项叫做链接数，每建立一个硬链接，该值就会加一，反过来，删除一个文件名，该值就会减一，只有减到零的情况下，系统才会回收该 inode 号和对应的数据。</p><p>系统创建目录时，默认会生成两个目录项：".&ldquo;和&rdquo;.."。前者的inode号码就是当前目录的inode号码，等同于当前目录的"硬链接&rdquo;；后者的inode号码就是当前目录的父目录的inode号码，等同于父目录的"硬链接&rdquo;。所以，任何一个目录的"硬链接"总数，总是等于2加上它的子目录总数（含隐藏目录）。</p><p>硬链接的缺点是不能创建目录的硬链接，也不能链接到其它文件系统。</p><a class=post-dummy-target id=42-软链接></a><h3>4.2 软链接</h3><p>软链接，也叫符号链接，软链接可以为目录创建，也可以链接到其它文件系统。因为软链接的实质类似于指针，加上存在文件 B，为 B 建立软链接 A，实际上是建立了一个新的文件，A 有自己的 inode，只不过 A 的内容是 B 的路径。当我们访问 A 时，会自动导向文件 B。</p><p>因此，软链接 A 是依赖于 B 存在的，如果删除了文件 B，打开文件 A 就会提示指向的文件或目录不存在。</p><p>使用 <code>ln -s</code> 命令创建软链接。</p><a class=post-dummy-target id=5-文件系统实例></a><h2>5. 文件系统实例</h2><p>文件系统是操作系统中与管理文件有关的软件和数据，负责文件的建立、删除、读写、修改、复制以及按名存取和存取控制。</p><p>我们假设磁盘的基本读写单位是 4KB，每 4KB 为一块，一个磁盘可以分为若干块（假设为 N），这些块的地址从 0 到 N-1，下面的介绍以一个只有 64 块的磁盘为例。</p><a class=post-dummy-target id=51-基本结构></a><h3>5.1 基本结构</h3><p>首先，磁盘中主要存放的一定是 <strong>用户数据</strong>，我们将存放用户数据的磁盘区域称为数据区域，假设将 64 个块的最后 56 个专门留给它们。</p><p>此外，文件系统还必须记录每个文件的基本信息，就是 inode，所有的 inode 存放在一个统一的区域，叫做 <strong>inode 表</strong>。由于 inode 大概 128 或 256 字节，所以不需要预留很大的空间，一个 4KB 的块就可以存放 16 个 inode，这里我们在 64 个块中留了 5 个块来存放 inode。</p><p>然后，我们还需要一个结构来记录 inode 和数据块空闲还是已分配。可选的方法很多，比如空闲块链表，将所有的空闲块链接在一起，当需要空闲块时从链头开始摘取并修改头指针，回收空闲块时插入链表尾。但通常使用的是一种简单有效的结构：<strong>位示图</strong>（inode）。位示图的原理是划分一部分空间，将每个比特位对应一个块，如果该位为0，说明对应的块空闲，如果该位为 1，说明对应的块已分配。数据区域和 inode 表通常使用不同的位示图。</p><p>最后还有一个结构叫做 <strong>超级块</strong>，包含文件系统的基本信息，比如有多少个 inode 和数据块、inode 表的起始位置、文件系统的类型等。</p><p>所以基本的结构有五部分，如下图：超级块、inode 位示图、数据区域位示图、inode表、数据区域。</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/BC_20200818_epub_30179184_248.jfif alt class=lazyload></figure></p><p>可以通过 <code>df</code> 命令查看文件系统，然后使用 <code>sudo dumpe2fs /dev/dsa*</code> 查看超级块的信息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>shuzang@ubuntu:~$ df
文件系统           1K-块     已用     可用 已用% 挂载点
udev             <span class=m>1972940</span>        <span class=m>0</span>  <span class=m>1972940</span>    0% /dev
tmpfs             <span class=m>400224</span>     <span class=m>1892</span>   <span class=m>398332</span>    1% /run
/dev/sda5      <span class=m>102168536</span> <span class=m>10744048</span> <span class=m>86191592</span>   12% /
...

$ sudo dumpe2fs /dev/sda5
dumpe2fs 1.45.5 <span class=o>(</span>07-Jan-2020<span class=o>)</span>
Filesystem volume name:   &lt;none&gt;
Last mounted on:          /
Filesystem UUID:          45e4318b-0433-4e09-a0ea-48e29ac60801
Filesystem magic number:  0xEF53
Filesystem revision <span class=c1>#:    1 (dynamic)</span>
Filesystem features:      has_journal ext_attr resize_inode dir_index filetype needs_recovery extent 64bit flex_bg sparse_super large_file huge_file dir_nlink extra_isize metadata_csum
Filesystem flags:         signed_directory_hash 
Default mount options:    user_xattr acl
Filesystem state:         clean
Errors behavior:          Continue
Filesystem OS type:       Linux
Inode count:              <span class=m>6520832</span>
Block count:              <span class=m>26082560</span>
Reserved block count:     <span class=m>1304128</span>
Free blocks:              <span class=m>22924783</span>
Free inodes:              <span class=m>6286837</span>
First block:              <span class=m>0</span>
Block size:               <span class=m>4096</span>
Fragment size:            <span class=m>4096</span>
Group descriptor size:    <span class=m>64</span>
Reserved GDT blocks:      <span class=m>1024</span>
Blocks per group:         <span class=m>32768</span>
Fragments per group:      <span class=m>32768</span>
Inodes per group:         <span class=m>8192</span>
Inode blocks per group:   <span class=m>512</span>
Flex block group size:    <span class=m>16</span>
Filesystem created:       Tue May <span class=m>19</span> 03:52:48 <span class=m>2020</span>
Last mount time:          Fri Aug <span class=m>21</span> 01:35:42 <span class=m>2020</span>
Last write time:          Fri Aug <span class=m>21</span> 01:35:35 <span class=m>2020</span>
Mount count:              <span class=m>7</span>
Maximum mount count:      -1
Last checked:             Tue May <span class=m>19</span> 03:52:48 <span class=m>2020</span>
Check interval:           <span class=m>0</span> <span class=o>(</span>&lt;none&gt;<span class=o>)</span>
Lifetime writes:          <span class=m>26</span> GB
Reserved blocks uid:      <span class=m>0</span> <span class=o>(</span>user root<span class=o>)</span>
Reserved blocks gid:      <span class=m>0</span> <span class=o>(</span>group root<span class=o>)</span>
First inode:              <span class=m>11</span>
Inode size:	          <span class=m>256</span>
...
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=52-挂载></a><h3>5.2 挂载</h3><p>磁盘通常会划分为不同的分区，每个分区可能使用不同的文件系统，挂载就是将该文件系统粘贴到整个操作系统的文件目录树上，挂载的位置是一个路径，进入该路径就相当于进入了该文件系统。</p><a class=post-dummy-target id=53-文件读取></a><h3>5.3 文件读取</h3><p>已知文件名，读取文件的过程我们大致已经熟悉，即通过文件名获得 inode 号，通过 inode 号获得 inode 信息，通过 inode 信息读取数据。</p><p>但这里还不清楚的一点是如何通过文件名找到 inode。文件系统采取的方式是遍历路径名，所有的遍历都从文件系统的根开始，即 <code>/</code> 。文件系统第一次读取根目录的 inode，根目录的 inode 号是众所周知的，一般是 2，因此文件系统就会读入 inode 号为2的块。一旦读入 inode，文件系统就可以查找指向数据块的指针，数据块中包含了根目录的内容。根目录的内容中存放了所有子文件的文件名和 inode 号的对应，所以根据路径可以找到下一级目录或文件的 inode 号，如果是目录，就继续遵循上面的过程进行递归的读取，最后读取得到文件的数据。</p><p>最后要注意的是，简单的读取并不会对位示图进行改变，只有创建或删除文件数据时才会改变位示图的内容。</p></div><div class=post-copyright id=post-footer><p class=copyright-item><span>Author:&nbsp;</span>
<span>shuzang</span></p><p class=copyright-item><span>Updated on:&nbsp;</span>
<span>2020-08-18</span></p><p class=copyright-item><span>Share on:&nbsp;</span>
<span><a href="//twitter.com/share?url=https%3a%2f%2fshuzang.github.io%2f2020%2foperate-system-6-file-management%2f&text=%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f6-%e6%96%87%e4%bb%b6%e7%ae%a1%e7%90%86&via=" target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-fw"></i></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fshuzang.github.io%2f2020%2foperate-system-6-file-management%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook-square fa-fw"></i></a><a href="//reddit.com/submit?url=https%3a%2f%2fshuzang.github.io%2f2020%2foperate-system-6-file-management%2f&title=%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f6-%e6%96%87%e4%bb%b6%e7%ae%a1%e7%90%86" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-fw"></i></a></span></p><p class=copyright-item></p><p class=copyright-item></p></div><br><div class=post-info-more><section><span class=tag><a href=https://shuzang.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/><i class="fas fa-tag fa-fw"></i>&nbsp;计算机基础</a>&nbsp;</span></section><section><span><a href=javascript:window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=https://shuzang.github.io>Home</a></span></section></div><div class=post-nav><a href=https://shuzang.github.io/2020/operate-system-5-device-management/ class=prev rel=prev title=操作系统5-设备管理><i class="fas fa-angle-left fa-fw"></i>操作系统5-设备管理</a>
<a href=https://shuzang.github.io/2020/bash-script-grammer-1/ class=next rel=next title=Bash脚本语法1>Bash脚本语法1<i class="fas fa-angle-right fa-fw"></i></a></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright><div class=copyright-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://shuzang.github.io/about/ target=_blank>shuzang</a> | </span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a> & <a href=https://github.com/dillonzq/LoveIt target=_blank rel="external nofollow noopener noreffer">LoveIt</a></div></div></footer></div><a href=# class=dynamic-to-top id=dynamic-to-top data-scroll><span>&nbsp;</span></a>
<script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-209130979-1','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=/js/lib/jquery/jquery.slim.min.js></script><script src=/js/lib/lazysizes/lazysizes.min.js></script><script src=/js/lib/smooth-scroll/smooth-scroll.polyfills.min.js></script><script>window.scroll=new SmoothScroll('[data-scroll]',{speed:300,speedAsDuration:true});</script><link rel=stylesheet href=/css/lib/katex/katex.min.css><script src=/js/lib/katex/katex.min.js></script><script defer src=/js/lib/katex/auto-render.min.js></script><link rel=stylesheet href=/css/lib/katex/copy-tex.min.css><script defer src=/js/lib/katex/copy-tex.min.js></script><script defer src=/js/lib/katex/mhchem.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:true},{left:"\\(",right:"\\)",display:false},{left:"\\[",right:"\\]",display:true},{left:"$",right:"$",display:false},]});});</script><script src=/js/blog.min.js></script></body></html>