<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>基于Go语言开发在线论坛2-通过模型类与MySQL数据库交互 - Shuzang's Blog</title><meta name=author content="Shuzang"><meta name=author-link content><meta name=description content="在本篇教程中，我们将在 MySQL 中创建一个 chitchat 数据库作为论坛项目的数据库。我选择了在本地安装 MySQL Server，但也可以基于 Docker 容器运行。转自学院君的教程，略有改动。"><meta name=keywords content="Go实战"><meta itemprop=name content="基于Go语言开发在线论坛2-通过模型类与MySQL数据库交互"><meta itemprop=description content="在本篇教程中，我们将在 MySQL 中创建一个 chitchat 数据库作为论坛项目的数据库。我选择了在本地安装 MySQL Server，但也可以基于 Docker 容器运行。转自学院君的教程，略有改动。"><meta itemprop=datePublished content="2020-05-27T18:25:20+08:00"><meta itemprop=dateModified content="2020-06-14T00:00:00+00:00"><meta itemprop=wordCount content="3393"><meta itemprop=image content="https://shuzang.github.io/logo.png"><meta itemprop=keywords content="Go实战,"><meta property="og:title" content="基于Go语言开发在线论坛2-通过模型类与MySQL数据库交互"><meta property="og:description" content="在本篇教程中，我们将在 MySQL 中创建一个 chitchat 数据库作为论坛项目的数据库。我选择了在本地安装 MySQL Server，但也可以基于 Docker 容器运行。转自学院君的教程，略有改动。"><meta property="og:type" content="article"><meta property="og:url" content="https://shuzang.github.io/2020/development-of-online-forum-based-on-golang-2-interact-with-mysql/"><meta property="og:image" content="https://shuzang.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-05-27T18:25:20+08:00"><meta property="article:modified_time" content="2020-06-14T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://shuzang.github.io/logo.png"><meta name=twitter:title content="基于Go语言开发在线论坛2-通过模型类与MySQL数据库交互"><meta name=twitter:description content="在本篇教程中，我们将在 MySQL 中创建一个 chitchat 数据库作为论坛项目的数据库。我选择了在本地安装 MySQL Server，但也可以基于 Docker 容器运行。转自学院君的教程，略有改动。"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://shuzang.github.io/2020/development-of-online-forum-based-on-golang-2-interact-with-mysql/><link rel=prev href=https://shuzang.github.io/2020/development-of-online-forum-based-on-golang-1-overall-design-and-data-model/><link rel=next href=https://shuzang.github.io/2020/golang-cryptographic-algorithm/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><meta name=google-site-verification content="UA-209130979-1"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"基于Go语言开发在线论坛2-通过模型类与MySQL数据库交互","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/shuzang.github.io\/2020\/development-of-online-forum-based-on-golang-2-interact-with-mysql\/"},"genre":"posts","keywords":"Go实战","wordcount":3393,"url":"https:\/\/shuzang.github.io\/2020\/development-of-online-forum-based-on-golang-2-interact-with-mysql\/","datePublished":"2020-05-27T18:25:20+08:00","dateModified":"2020-06-14T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"xueyuanjun"},"description":""}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=right><div class=header-title><a href=/ title="Shuzang's Blog"><img loading=lazy src=/images/avatar.png srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x" sizes=auto data-title="Shuzang's Blog" data-alt="Shuzang's Blog" class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>Shuzang's Blog</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> Posts</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> Categories</a></li><li class=menu-item><a class=menu-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> About</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Shuzang's Blog"><img loading=lazy src=/images/avatar.png srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x" sizes=auto data-title=/images/avatar.png data-alt=/images/avatar.png class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>Shuzang's Blog</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> Posts</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> Categories</a></li><li class=menu-item><a class=menu-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> About</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>基于Go语言开发在线论坛2-通过模型类与MySQL数据库交互</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle" aria-hidden=true></i>
xueyuanjun</span></span>
<span class=post-category>收录于 <a href=/categories/golang%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> Golang学习之路</a></span></div><div class=post-meta-line><span title="发布于 2020-05-27 18:25:20"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden=true></i><time datetime=2020-05-27>2020-05-27</time></span>&nbsp;<span title="更新于 2020-06-14 00:00:00"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden=true></i><time datetime=2020-06-14>2020-06-14</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 3393 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 7 分钟</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-项目初始化>1. 项目初始化</a></li><li><a href=#2-创建数据表>2. 创建数据表</a></li><li><a href=#3-与数据库交互>3. 与数据库交互</a><ul><li><a href=#31-数据库驱动>3.1 数据库驱动</a></li><li><a href=#32-数据库连接>3.2 数据库连接</a></li><li><a href=#33-用户模型相关类>3.3 用户模型相关类</a></li><li><a href=#34-主题模型相关类>3.4 主题模型相关类</a></li></ul></li><li><a href=#4-小结>4. 小结</a></li></ul></nav></div></div><div class=content id=content><p>在本篇教程中，我们将在 MySQL 中创建一个 <code>chitchat</code> 数据库作为论坛项目的数据库。我选择了在本地安装 MySQL Server，但也可以基于 Docker 容器运行。转自学院君的教程，略有改动。</p><h2 id=1-项目初始化>1. 项目初始化</h2><p>首先创建项目目录，命名为 <code>chitchat</code>，然后初始化目录结构如下</p><p><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200527_%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200527_%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png, https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200527_%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200527_%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png 2x" sizes=auto data-title=初始化的目录结构 data-alt=初始化的目录结构 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>各个子目录/文件的作用介绍如下：</p><ul><li><code>main.go</code>：应用入口文件</li><li><code>config.json</code>：全局配置文件</li><li><code>handlers</code>：用于存放处理器代码（可类比为 MVC 模式中的控制器目录）</li><li><code>logs</code>：用于存放日志文件</li><li><code>models</code>：用于存放与数据库交互的模型类</li><li><code>public</code>：用于存放前端资源文件，比如图片、CSS、JavaScript 等</li><li><code>routes</code>：用于存放路由文件和路由器实现代码</li><li><code>views</code>：用于存放视图模板文件</li></ul><p>在 Github 网页端创建同名仓库，然后在本地执行如下命令初始化仓库（我们使用 Github 存储代码）</p><div class=highlight id=id-1><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;# chitchat&#34;</span> &gt;&gt; README.md
</span></span><span class=line><span class=cl>git init
</span></span><span class=line><span class=cl>git add README.md
</span></span><span class=line><span class=cl>git commit -m <span class=s2>&#34;Initialize project directory&#34;</span>
</span></span><span class=line><span class=cl>git remote add origin https://github.com/shuzang/chitchat.git
</span></span><span class=line><span class=cl>git push -u origin master</span></span></code></pre></td></tr></table></div></div><p>然后在 <code>chitchat</code> 目录下初始化 Go 项目， 后续通过 Go Module 来管理依赖</p><div class=highlight id=id-2><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ go mod init github.com/shuzang/chitchat</span></span></code></pre></td></tr></table></div></div><h2 id=2-创建数据表>2. 创建数据表</h2><p>在 MySQL Server 中创建 <code>chitchat</code> 数据库，然后创建数据表，数据表对应的 SQL 语句如下</p><div class=highlight id=id-3><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=nf>users</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>id</span><span class=w>         </span><span class=n>serial</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>uuid</span><span class=w>       </span><span class=kt>varchar</span><span class=p>(</span><span class=mi>64</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=no>null</span><span class=w> </span><span class=k>unique</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>name</span><span class=w>       </span><span class=kt>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>email</span><span class=w>      </span><span class=kt>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=no>null</span><span class=w> </span><span class=k>unique</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>password</span><span class=w>   </span><span class=kt>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=no>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>created_at</span><span class=w> </span><span class=kt>timestamp</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=no>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=nf>sessions</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>id</span><span class=w>         </span><span class=n>serial</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>uuid</span><span class=w>       </span><span class=kt>varchar</span><span class=p>(</span><span class=mi>64</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=no>null</span><span class=w> </span><span class=k>unique</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>email</span><span class=w>      </span><span class=kt>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>user_id</span><span class=w>    </span><span class=kt>integer</span><span class=w> </span><span class=k>references</span><span class=w> </span><span class=nf>users</span><span class=p>(</span><span class=n>id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>created_at</span><span class=w> </span><span class=kt>timestamp</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=no>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=nf>threads</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>id</span><span class=w>         </span><span class=n>serial</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>uuid</span><span class=w>       </span><span class=kt>varchar</span><span class=p>(</span><span class=mi>64</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=no>null</span><span class=w> </span><span class=k>unique</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>topic</span><span class=w>      </span><span class=kt>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>user_id</span><span class=w>    </span><span class=kt>integer</span><span class=w> </span><span class=k>references</span><span class=w> </span><span class=nf>users</span><span class=p>(</span><span class=n>id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>created_at</span><span class=w> </span><span class=kt>timestamp</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=no>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=nf>posts</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>id</span><span class=w>         </span><span class=n>serial</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>uuid</span><span class=w>       </span><span class=kt>varchar</span><span class=p>(</span><span class=mi>64</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=no>null</span><span class=w> </span><span class=k>unique</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>body</span><span class=w>       </span><span class=kt>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>user_id</span><span class=w>    </span><span class=kt>integer</span><span class=w> </span><span class=k>references</span><span class=w> </span><span class=nf>users</span><span class=p>(</span><span class=n>id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>thread_id</span><span class=w>  </span><span class=kt>integer</span><span class=w> </span><span class=k>references</span><span class=w> </span><span class=nf>threads</span><span class=p>(</span><span class=n>id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>created_at</span><span class=w> </span><span class=kt>timestamp</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=no>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div><p>使用 Navicat for MySQL 进行连接测试</p><p><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200527_%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B5%8B%E8%AF%95.png srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200527_%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B5%8B%E8%AF%95.png, https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200527_%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B5%8B%E8%AF%95.png 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200527_%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B5%8B%E8%AF%95.png 2x" sizes=auto data-title=https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200527_%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B5%8B%E8%AF%95.png data-alt=https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200527_%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B5%8B%E8%AF%95.png style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>大量的语句逐条执行很容易出错，可以通过脚本形式批量执行<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>。</p><h2 id=3-与数据库交互>3. 与数据库交互</h2><h3 id=31-数据库驱动>3.1 数据库驱动</h3><p>数据表创建完成后，接下来，需要在 Go 应用代码中与数据库交互，Go 语言开发组并没有为此提供官方的数据库驱动实现，只是提供了数据库交互接口，我们可以通过实现这些接口的第三方扩展包完成与 MySQL 数据库的交互，本项目选择的扩展包是 <a href=https://github.com/go-sql-driver/mysql target=_blank rel="external nofollow noopener noreferrer">go-mysql-driver</a> 。</p><p>我们可以在 Go 应用中编写模型类基于这个扩展包提供的方法与 MySQL 交互完成增删改查操作，开始之前，可以运行如下命令安装这个依赖：</p><div class=highlight id=id-4><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ go get -u github.com/go-sql-driver/mysql</span></span></code></pre></td></tr></table></div></div><h3 id=32-数据库连接>3.2 数据库连接</h3><p>然后在 <code>chitchat/models</code> 目录下创建 <code>db.go</code>，并编写数据库连接初始化方法以及生成 UUID、哈希加密方法：</p><div class=highlight id=id-5><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>models</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;crypto/rand&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;crypto/sha256&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;database/sql&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>_</span> <span class=s>&#34;github.com/go-sql-driver/mysql&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>Db</span> <span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>DB</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=nx>Db</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>sql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;mysql&#34;</span><span class=p>,</span> <span class=s>&#34;root:root@/chitchat?charset=utf8&amp;parseTime=true&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// create a random UUID with from RFC 4122
</span></span></span><span class=line><span class=cl><span class=c1>// adapted from http://github.com/nu7hatch/gouuid
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>createUUID</span><span class=p>()</span> <span class=p>(</span><span class=nx>uuid</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>u</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>([</span><span class=mi>16</span><span class=p>]</span><span class=kt>byte</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rand</span><span class=p>.</span><span class=nf>Read</span><span class=p>(</span><span class=nx>u</span><span class=p>[:])</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=s>&#34;Cannot generate UUID&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 0x40 is reserved variant from RFC 4122
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>u</span><span class=p>[</span><span class=mi>8</span><span class=p>]</span> <span class=p>=</span> <span class=p>(</span><span class=nx>u</span><span class=p>[</span><span class=mi>8</span><span class=p>]</span> <span class=p>|</span> <span class=mh>0x40</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x7F</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Set the four most significant bits (bits 12 through 15) of the
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// time_hi_and_version field to the 4-bit version number.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>u</span><span class=p>[</span><span class=mi>6</span><span class=p>]</span> <span class=p>=</span> <span class=p>(</span><span class=nx>u</span><span class=p>[</span><span class=mi>6</span><span class=p>]</span> <span class=o>&amp;</span> <span class=mh>0xF</span><span class=p>)</span> <span class=p>|</span> <span class=p>(</span><span class=mh>0x4</span> <span class=o>&lt;&lt;</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>uuid</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%x-%x-%x-%x-%x&#34;</span><span class=p>,</span> <span class=nx>u</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>4</span><span class=p>],</span> <span class=nx>u</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>6</span><span class=p>],</span> <span class=nx>u</span><span class=p>[</span><span class=mi>6</span><span class=p>:</span><span class=mi>8</span><span class=p>],</span> <span class=nx>u</span><span class=p>[</span><span class=mi>8</span><span class=p>:</span><span class=mi>10</span><span class=p>],</span> <span class=nx>u</span><span class=p>[</span><span class=mi>10</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// hash plaintext with sha-256
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>Encrypt</span><span class=p>(</span><span class=nx>plaintext</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>cryptext</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>cryptext</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%x&#34;</span><span class=p>,</span> <span class=nx>sha256</span><span class=p>.</span><span class=nf>Sum256</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>plaintext</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>其中，<code>Db</code> 变量代表数据库连接池，通过 <code>init</code> 方法在 Web 应用启动时自动初始化数据库连接，这样，我们就可以在应用中通过 <code>Db</code> 变量对数据库进行增删改查操作了，这也是该变量首字母大写的原因，方便在 <code>models</code> 包之外被引用，具体的操作实现我们放到独立的模型文件中处理。</p><p>注：这里通过 <code>sql.Open</code> 初始化数据库连接，我们写死了数据库连接配置，在实际生产环境，这块配置值应该从配置文件或系统环境变量获取。</p><h3 id=33-用户模型相关类>3.3 用户模型相关类</h3><p>有了代表数据库连接池的 <code>Db</code> 变量之后，就可以为每个数据表编写对应的模型类实现增删改查操作了，首先在 <code>models</code> 目录下创建 <code>user.go</code> 用于定义用户模型类 <code>User</code> 与 <code>users</code> 表进行交互，以及与 <code>sessions</code> 表进行关联：</p><div class=highlight id=id-6><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>models</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Id</span>        <span class=kt>int</span>
</span></span><span class=line><span class=cl>    <span class=nx>Uuid</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>Email</span>     <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>Password</span>  <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>CreatedAt</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create a new session for an existing user
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>user</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>CreateSession</span><span class=p>()</span> <span class=p>(</span><span class=nx>session</span> <span class=nx>Session</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>statement</span> <span class=o>:=</span> <span class=s>&#34;insert into sessions (uuid, email, user_id, created_at) values (?, ?, ?, ?)&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>stmtin</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=nx>statement</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>stmtin</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>uuid</span> <span class=o>:=</span> <span class=nf>createUUID</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>stmtin</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=nx>uuid</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>Email</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>stmtout</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=s>&#34;select id, uuid, email, user_id, created_at from sessions where uuid = ?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>stmtout</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// use QueryRow to return a row and scan the returned id into the Session struct
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>stmtout</span><span class=p>.</span><span class=nf>QueryRow</span><span class=p>(</span><span class=nx>uuid</span><span class=p>).</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>session</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>session</span><span class=p>.</span><span class=nx>Uuid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>session</span><span class=p>.</span><span class=nx>Email</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>session</span><span class=p>.</span><span class=nx>UserId</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>session</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get the session for an existing user
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>user</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>Session</span><span class=p>()</span> <span class=p>(</span><span class=nx>session</span> <span class=nx>Session</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>session</span> <span class=p>=</span> <span class=nx>Session</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>QueryRow</span><span class=p>(</span><span class=s>&#34;SELECT id, uuid, email, user_id, created_at FROM sessions WHERE user_id = ?&#34;</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>Id</span><span class=p>).</span>
</span></span><span class=line><span class=cl>        <span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>session</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>session</span><span class=p>.</span><span class=nx>Uuid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>session</span><span class=p>.</span><span class=nx>Email</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>session</span><span class=p>.</span><span class=nx>UserId</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>session</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create a new user, save user info into the database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>user</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>Create</span><span class=p>()</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Postgres does not automatically return the last insert id, because it would be wrong to assume
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// you&#39;re always using a sequence.You need to use the RETURNING keyword in your insert to get this
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// information from postgres.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>statement</span> <span class=o>:=</span> <span class=s>&#34;insert into users (uuid, name, email, password, created_at) values (?, ?, ?, ?, ?)&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>stmtin</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=nx>statement</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>stmtin</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>uuid</span> <span class=o>:=</span> <span class=nf>createUUID</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>stmtin</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=nx>uuid</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>Email</span><span class=p>,</span> <span class=nf>Encrypt</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>Password</span><span class=p>),</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>stmtout</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=s>&#34;select id, uuid, created_at from users where uuid = ?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>stmtout</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// use QueryRow to return a row and scan the returned id into the User struct
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>stmtout</span><span class=p>.</span><span class=nf>QueryRow</span><span class=p>(</span><span class=nx>uuid</span><span class=p>).</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Uuid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Delete user from database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>user</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>Delete</span><span class=p>()</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>statement</span> <span class=o>:=</span> <span class=s>&#34;delete from users where id = ?&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>stmt</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=nx>statement</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>stmt</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>stmt</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>Id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Update user information in the database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>user</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>Update</span><span class=p>()</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>statement</span> <span class=o>:=</span> <span class=s>&#34;update users set name = ?, email = ? where id = ?&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>stmt</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=nx>statement</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>stmt</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>stmt</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>Email</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>Id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Delete all users from database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>UserDeleteAll</span><span class=p>()</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>statement</span> <span class=o>:=</span> <span class=s>&#34;delete from users&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=nx>statement</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get all users in the database and returns it
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>Users</span><span class=p>()</span> <span class=p>(</span><span class=nx>users</span> <span class=p>[]</span><span class=nx>User</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>rows</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;SELECT id, uuid, name, email, password, created_at FROM users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Uuid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Email</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Password</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>users</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>users</span><span class=p>,</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>rows</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get a single user given the email
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>UserByEmail</span><span class=p>(</span><span class=nx>email</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>user</span> <span class=nx>User</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>user</span> <span class=p>=</span> <span class=nx>User</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>QueryRow</span><span class=p>(</span><span class=s>&#34;SELECT id, uuid, name, email, password, created_at FROM users WHERE email = ?&#34;</span><span class=p>,</span> <span class=nx>email</span><span class=p>).</span>
</span></span><span class=line><span class=cl>        <span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Uuid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Email</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Password</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get a single user given the UUID
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>UserByUUID</span><span class=p>(</span><span class=nx>uuid</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>user</span> <span class=nx>User</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>user</span> <span class=p>=</span> <span class=nx>User</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>QueryRow</span><span class=p>(</span><span class=s>&#34;SELECT id, uuid, name, email, password, created_at FROM users WHERE uuid = ?&#34;</span><span class=p>,</span> <span class=nx>uuid</span><span class=p>).</span>
</span></span><span class=line><span class=cl>        <span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Uuid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Email</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Password</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>创建 <code>session.go</code> 用于定义会话模型类 <code>Session</code>：</p><div class=highlight id=id-7><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>models</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Session</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Id</span>        <span class=kt>int</span>
</span></span><span class=line><span class=cl>    <span class=nx>Uuid</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>Email</span>     <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>UserId</span>    <span class=kt>int</span>
</span></span><span class=line><span class=cl>    <span class=nx>CreatedAt</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Check if session is valid in the database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>session</span> <span class=o>*</span><span class=nx>Session</span><span class=p>)</span> <span class=nf>Check</span><span class=p>()</span> <span class=p>(</span><span class=nx>valid</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>QueryRow</span><span class=p>(</span><span class=s>&#34;SELECT id, uuid, email, user_id, created_at FROM sessions WHERE uuid = ?&#34;</span><span class=p>,</span> <span class=nx>session</span><span class=p>.</span><span class=nx>Uuid</span><span class=p>).</span>
</span></span><span class=line><span class=cl>        <span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>session</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>session</span><span class=p>.</span><span class=nx>Uuid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>session</span><span class=p>.</span><span class=nx>Email</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>session</span><span class=p>.</span><span class=nx>UserId</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>session</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>valid</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>session</span><span class=p>.</span><span class=nx>Id</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>valid</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Delete session from database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>session</span> <span class=o>*</span><span class=nx>Session</span><span class=p>)</span> <span class=nf>DeleteByUUID</span><span class=p>()</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>statement</span> <span class=o>:=</span> <span class=s>&#34;delete from sessions where uuid = ?&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>stmt</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=nx>statement</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>stmt</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>stmt</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=nx>session</span><span class=p>.</span><span class=nx>Uuid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get the user from the session
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>session</span> <span class=o>*</span><span class=nx>Session</span><span class=p>)</span> <span class=nf>User</span><span class=p>()</span> <span class=p>(</span><span class=nx>user</span> <span class=nx>User</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>user</span> <span class=p>=</span> <span class=nx>User</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>QueryRow</span><span class=p>(</span><span class=s>&#34;SELECT id, uuid, name, email, created_at FROM users WHERE id = ?&#34;</span><span class=p>,</span> <span class=nx>session</span><span class=p>.</span><span class=nx>UserId</span><span class=p>).</span>
</span></span><span class=line><span class=cl>        <span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Uuid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Email</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Delete all sessions from database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>SessionDeleteAll</span><span class=p>()</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>statement</span> <span class=o>:=</span> <span class=s>&#34;delete from sessions&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=nx>statement</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>这里面定义了基于 <code>Db</code> 数据库连接实例实现用户模型和会话模型相关的增删改查操作，具体的语法可以参考 <code>go-mysql-driver</code> 的 <a href=https://github.com/go-sql-driver/mysql target=_blank rel="external nofollow noopener noreferrer">官方文档</a>。</p><h3 id=34-主题模型相关类>3.4 主题模型相关类</h3><p>编写好用户相关模型类后，接下来在同级目录下创建 <code>thread.go</code>，定义群组模型类 <code>Thread</code> 与 <code>threads</code> 表进行交互：</p><div class=highlight id=id-8><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>models</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Thread</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Id</span>        <span class=kt>int</span>
</span></span><span class=line><span class=cl>    <span class=nx>Uuid</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>Topic</span>     <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>UserId</span>    <span class=kt>int</span>
</span></span><span class=line><span class=cl>    <span class=nx>CreatedAt</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// format the CreatedAt date to display nicely on the screen
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>thread</span> <span class=o>*</span><span class=nx>Thread</span><span class=p>)</span> <span class=nf>CreatedAtDate</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>thread</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>.</span><span class=nf>Format</span><span class=p>(</span><span class=s>&#34;Jan 2, 2006 at 3:04pm&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// get the number of posts in a thread
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>thread</span> <span class=o>*</span><span class=nx>Thread</span><span class=p>)</span> <span class=nf>NumReplies</span><span class=p>()</span> <span class=p>(</span><span class=nx>count</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>rows</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;SELECT count(*) FROM posts where thread_id = ?&#34;</span><span class=p>,</span> <span class=nx>thread</span><span class=p>.</span><span class=nx>Id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>count</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>rows</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// get posts to a thread
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>thread</span> <span class=o>*</span><span class=nx>Thread</span><span class=p>)</span> <span class=nf>Posts</span><span class=p>()</span> <span class=p>(</span><span class=nx>posts</span> <span class=p>[]</span><span class=nx>Post</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>rows</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;SELECT id, uuid, body, user_id, thread_id, created_at FROM posts where thread_id = ?&#34;</span><span class=p>,</span> <span class=nx>thread</span><span class=p>.</span><span class=nx>Id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>post</span> <span class=o>:=</span> <span class=nx>Post</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>post</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>post</span><span class=p>.</span><span class=nx>Uuid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>post</span><span class=p>.</span><span class=nx>Body</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>post</span><span class=p>.</span><span class=nx>UserId</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>post</span><span class=p>.</span><span class=nx>ThreadId</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>post</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>posts</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>posts</span><span class=p>,</span> <span class=nx>post</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>rows</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get all threads in the database and returns it
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>Threads</span><span class=p>()</span> <span class=p>(</span><span class=nx>threads</span> <span class=p>[]</span><span class=nx>Thread</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>rows</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;SELECT id, uuid, topic, user_id, created_at FROM threads ORDER BY created_at DESC&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>conv</span> <span class=o>:=</span> <span class=nx>Thread</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>conv</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>conv</span><span class=p>.</span><span class=nx>Uuid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>conv</span><span class=p>.</span><span class=nx>Topic</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>conv</span><span class=p>.</span><span class=nx>UserId</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>conv</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>threads</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>threads</span><span class=p>,</span> <span class=nx>conv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>rows</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get a thread by the UUID
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ThreadByUUID</span><span class=p>(</span><span class=nx>uuid</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>conv</span> <span class=nx>Thread</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>conv</span> <span class=p>=</span> <span class=nx>Thread</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>QueryRow</span><span class=p>(</span><span class=s>&#34;SELECT id, uuid, topic, user_id, created_at FROM threads WHERE uuid = ?&#34;</span><span class=p>,</span> <span class=nx>uuid</span><span class=p>).</span>
</span></span><span class=line><span class=cl>        <span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>conv</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>conv</span><span class=p>.</span><span class=nx>Uuid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>conv</span><span class=p>.</span><span class=nx>Topic</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>conv</span><span class=p>.</span><span class=nx>UserId</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>conv</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get the user who started this thread
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>thread</span> <span class=o>*</span><span class=nx>Thread</span><span class=p>)</span> <span class=nf>User</span><span class=p>()</span> <span class=p>(</span><span class=nx>user</span> <span class=nx>User</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>user</span> <span class=p>=</span> <span class=nx>User</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>Db</span><span class=p>.</span><span class=nf>QueryRow</span><span class=p>(</span><span class=s>&#34;SELECT id, uuid, name, email, created_at FROM users WHERE id = ?&#34;</span><span class=p>,</span> <span class=nx>thread</span><span class=p>.</span><span class=nx>UserId</span><span class=p>).</span>
</span></span><span class=line><span class=cl>        <span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Uuid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Email</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>以及 <code>post.go</code> 编写主题模型类与 <code>posts</code> 表进行交互：</p><div class=highlight id=id-9><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>models</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Post</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Id</span>        <span class=kt>int</span>
</span></span><span class=line><span class=cl>    <span class=nx>Uuid</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>Body</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>UserId</span>    <span class=kt>int</span>
</span></span><span class=line><span class=cl>    <span class=nx>ThreadId</span>  <span class=kt>int</span>
</span></span><span class=line><span class=cl>    <span class=nx>CreatedAt</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>post</span> <span class=o>*</span><span class=nx>Post</span><span class=p>)</span> <span class=nf>CreatedAtDate</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>post</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>.</span><span class=nf>Format</span><span class=p>(</span><span class=s>&#34;Jan 2, 2006 at 3:04pm&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get the user who wrote the post
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>post</span> <span class=o>*</span><span class=nx>Post</span><span class=p>)</span> <span class=nf>User</span><span class=p>()</span> <span class=p>(</span><span class=nx>user</span> <span class=nx>User</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>user</span> <span class=p>=</span> <span class=nx>User</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>Db</span><span class=p>.</span><span class=nf>QueryRow</span><span class=p>(</span><span class=s>&#34;SELECT id, uuid, name, email, created_at FROM users WHERE id = ?&#34;</span><span class=p>,</span> <span class=nx>post</span><span class=p>.</span><span class=nx>UserId</span><span class=p>).</span>
</span></span><span class=line><span class=cl>        <span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Uuid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Email</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>此外，我们到 <code>user.go</code> 中为 <code>User</code> 模型新增如下两个方法与 <code>Thread</code>、<code>Post</code> 模型进行关联，用于创建新的群组和主题：</p><div class=highlight id=id-10><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Create a new thread
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>user</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>CreateThread</span><span class=p>(</span><span class=nx>topic</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>conv</span> <span class=nx>Thread</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>statement</span> <span class=o>:=</span> <span class=s>&#34;insert into threads (uuid, topic, user_id, created_at) values (?, ?, ?, ?)&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>stmtin</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=nx>statement</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>stmtin</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>uuid</span> <span class=o>:=</span> <span class=nf>createUUID</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>stmtin</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=nx>uuid</span><span class=p>,</span> <span class=nx>topic</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>stmtout</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=s>&#34;select id, uuid, topic, user_id, created_at from threads where uuid = ?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>stmtout</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// use QueryRow to return a row and scan the returned id into the Session struct
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>stmtout</span><span class=p>.</span><span class=nf>QueryRow</span><span class=p>(</span><span class=nx>uuid</span><span class=p>).</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>conv</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>conv</span><span class=p>.</span><span class=nx>Uuid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>conv</span><span class=p>.</span><span class=nx>Topic</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>conv</span><span class=p>.</span><span class=nx>UserId</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>conv</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create a new post to a thread
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>user</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>CreatePost</span><span class=p>(</span><span class=nx>conv</span> <span class=nx>Thread</span><span class=p>,</span> <span class=nx>body</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>post</span> <span class=nx>Post</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>statement</span> <span class=o>:=</span> <span class=s>&#34;insert into posts (uuid, body, user_id, thread_id, created_at) values (?, ?, ?, ?, ?)&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>stmtin</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=nx>statement</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>stmtin</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>uuid</span> <span class=o>:=</span> <span class=nf>createUUID</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>stmtin</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=nx>uuid</span><span class=p>,</span> <span class=nx>body</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span> <span class=nx>conv</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>stmtout</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>Db</span><span class=p>.</span><span class=nf>Prepare</span><span class=p>(</span><span class=s>&#34;select id, uuid, body, user_id, thread_id, created_at from posts where uuid = ?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>stmtout</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// use QueryRow to return a row and scan the returned id into the Session struct
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>stmtout</span><span class=p>.</span><span class=nf>QueryRow</span><span class=p>(</span><span class=nx>uuid</span><span class=p>).</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>post</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>post</span><span class=p>.</span><span class=nx>Uuid</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>post</span><span class=p>.</span><span class=nx>Body</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>post</span><span class=p>.</span><span class=nx>UserId</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>post</span><span class=p>.</span><span class=nx>ThreadId</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>post</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=4-小结>4. 小结</h2><p>在上述编写的模型类中，模型类与数据表的映射由 <code>go-mysql-driver</code> 底层实现，每次从数据库查询到结果之后，可以通过 <code>Scan</code> 方法将数据表字段值映射到对应的结构体模型类，而将模型类保存到数据库时，又可以基于字段映射关系将结构体属性值转化为对应的数据表字段值。</p><p>底层数据库交互逻辑定义好了之后，接下来，我们就可以编写上层实现代码了，下一篇介绍在线论坛项目上层路由和处理器方法的实现。</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://www.cnblogs.com/kenkofox/archive/2011/01/14/1935422.html target=_blank rel="external nofollow noopener noreferrer">mysql下如何执行sql脚本</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2020-06-14 00:00:00">更新于 2020-06-14&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/2020/development-of-online-forum-based-on-golang-2-interact-with-mysql/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://shuzang.github.io/2020/development-of-online-forum-based-on-golang-2-interact-with-mysql/ data-title=基于Go语言开发在线论坛2-通过模型类与MySQL数据库交互 data-hashtags=Go实战><i class="fa-brands fa-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://shuzang.github.io/2020/development-of-online-forum-based-on-golang-2-interact-with-mysql/ data-hashtag=Go实战><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://shuzang.github.io/2020/development-of-online-forum-based-on-golang-2-interact-with-mysql/ data-title=基于Go语言开发在线论坛2-通过模型类与MySQL数据库交互><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/go%E5%AE%9E%E6%88%98/ class=post-tag>Go实战</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/2020/development-of-online-forum-based-on-golang-1-overall-design-and-data-model/ class=post-nav-item rel=prev title=基于Go语言开发在线论坛1-整体设计与数据模型><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>基于Go语言开发在线论坛1-整体设计与数据模型</a>
<a href=/2020/golang-cryptographic-algorithm/ class=post-nav-item rel=next title=Golang密码学算法>Golang密码学算法<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.117.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.2.18"><img class=fixit-icon src=/fixit.min.svg alt="FixIt logo">&nbsp;FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=/>Shuzang</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div><div class="footer-line visitor"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class="variant-numeric d-none">0%</span></div></div><a href=https://github.com/shuzang title="View source on GitHub" target=_blank rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;top:0></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><link rel=stylesheet href=/lib/pace/themes/blue/pace-theme-minimal.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/twemoji/twemoji.min.js defer></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script src=/lib/pace/pace.min.js async defer></script><script>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{enable:!1},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:30,threshold:.3,type:"fuse",useExtendedSearch:!1},twemoji:!0}</script><script src=/js/theme.min.js defer></script></body></html>