<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>基于Go语言开发在线论坛8-消息、视图和日期时间本地化 - Shuzang's Blog</title><meta name=author content="Shuzang"><meta name=author-link content><meta name=description content="由于之前所有页面和消息文本都是英文的，而我们开发的应用基本都是面向中文用户的，所以需要对项目进行本地化，因此本篇介绍如何在 Go Web 应用中进行国际化和本地化编程，由于项目比较简单，只介绍消息提示、视图模板和日期格式的本地化。"><meta name=keywords content="Go实战"><meta itemprop=name content="基于Go语言开发在线论坛8-消息、视图和日期时间本地化"><meta itemprop=description content="由于之前所有页面和消息文本都是英文的，而我们开发的应用基本都是面向中文用户的，所以需要对项目进行本地化，因此本篇介绍如何在 Go Web 应用中进行国际化和本地化编程，由于项目比较简单，只介绍消息提示、视图模板和日期格式的本地化。"><meta itemprop=datePublished content="2020-06-07T20:30:00+08:00"><meta itemprop=dateModified content="2020-06-07T00:00:00+00:00"><meta itemprop=wordCount content="2326"><meta itemprop=image content="https://shuzang.github.io/logo.png"><meta itemprop=keywords content="Go实战,"><meta property="og:title" content="基于Go语言开发在线论坛8-消息、视图和日期时间本地化"><meta property="og:description" content="由于之前所有页面和消息文本都是英文的，而我们开发的应用基本都是面向中文用户的，所以需要对项目进行本地化，因此本篇介绍如何在 Go Web 应用中进行国际化和本地化编程，由于项目比较简单，只介绍消息提示、视图模板和日期格式的本地化。"><meta property="og:type" content="article"><meta property="og:url" content="https://shuzang.github.io/2020/development-of-online-forum-based-on-golang-8-message-view-and-date-time-localizationsingleton-mode/"><meta property="og:image" content="https://shuzang.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-06-07T20:30:00+08:00"><meta property="article:modified_time" content="2020-06-07T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://shuzang.github.io/logo.png"><meta name=twitter:title content="基于Go语言开发在线论坛8-消息、视图和日期时间本地化"><meta name=twitter:description content="由于之前所有页面和消息文本都是英文的，而我们开发的应用基本都是面向中文用户的，所以需要对项目进行本地化，因此本篇介绍如何在 Go Web 应用中进行国际化和本地化编程，由于项目比较简单，只介绍消息提示、视图模板和日期格式的本地化。"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://shuzang.github.io/2020/development-of-online-forum-based-on-golang-8-message-view-and-date-time-localizationsingleton-mode/><link rel=prev href=https://shuzang.github.io/2020/development-of-online-forum-based-on-golang-7-get-global-configuration-through-singleton-mode/><link rel=next href=https://shuzang.github.io/2020/development-of-online-forum-based-on-golang-9-deploy-go-web-application/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><meta name=google-site-verification content="UA-209130979-1"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"基于Go语言开发在线论坛8-消息、视图和日期时间本地化","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/shuzang.github.io\/2020\/development-of-online-forum-based-on-golang-8-message-view-and-date-time-localizationsingleton-mode\/"},"genre":"posts","keywords":"Go实战","wordcount":2326,"url":"https:\/\/shuzang.github.io\/2020\/development-of-online-forum-based-on-golang-8-message-view-and-date-time-localizationsingleton-mode\/","datePublished":"2020-06-07T20:30:00+08:00","dateModified":"2020-06-07T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"xueyuanjun"},"description":""}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=right><div class=header-title><a href=/ title="Shuzang's Blog"><img loading=lazy src=/images/avatar.png srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x" sizes=auto data-title="Shuzang's Blog" data-alt="Shuzang's Blog" class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>Shuzang's Blog</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Shuzang's Blog"><img loading=lazy src=/images/avatar.png srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x" sizes=auto data-title=/images/avatar.png data-alt=/images/avatar.png class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>Shuzang's Blog</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>基于Go语言开发在线论坛8-消息、视图和日期时间本地化</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle" aria-hidden=true></i>
xueyuanjun</span></span>
<span class=post-category>收录于 <a href=/categories/golang%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> Golang学习之路</a></span></div><div class=post-meta-line><span title="发布于 2020-06-07 20:30:00"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden=true></i><time datetime=2020-06-07>2020-06-07</time></span>&nbsp;<span title="更新于 2020-06-07 00:00:00"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden=true></i><time datetime=2020-06-07>2020-06-07</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 2326 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 5 分钟</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-消息本地化>1. 消息本地化</a><ul><li><a href=#11-安装-go-i18n-扩展包>1.1 安装 go-i18n 扩展包</a></li><li><a href=#12-通过-go-i18n-自动生成翻译文件>1.2 通过 go-i18n 自动生成翻译文件</a></li><li><a href=#13-编写中文版本翻译文件>1.3 编写中文版本翻译文件</a></li><li><a href=#14-本地化配置初始化>1.4 本地化配置初始化</a></li><li><a href=#15-在处理器方法中返回本地化消息>1.5 在处理器方法中返回本地化消息</a></li><li><a href=#16-测试消息本地化>1.6 测试消息本地化</a></li></ul></li><li><a href=#2-视图本地化>2. 视图本地化</a><ul><li><a href=#21-创建本地化视图模板>2.1 创建本地化视图模板</a></li><li><a href=#22-通过配置加载本地化视图>2.2 通过配置加载本地化视图</a></li><li><a href=#23-测试视图本地化>2.3 测试视图本地化</a></li></ul></li><li><a href=#3-日期时间本地化>3. 日期时间本地化</a><ul><li><a href=#31-将自定义函数应用到视图模板>3.1 将自定义函数应用到视图模板</a></li><li><a href=#32-调用自定义函数格式化本地日期时间>3.2 调用自定义函数格式化本地日期时间</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>由于之前所有页面和消息文本都是英文的，而我们开发的应用基本都是面向中文用户的，所以需要对项目进行本地化，因此本篇介绍如何在 Go Web 应用中进行国际化和本地化编程，由于项目比较简单，只介绍消息提示、视图模板和日期格式的本地化。</p><h2 id=1-消息本地化>1. 消息本地化</h2><h3 id=11-安装-go-i18n-扩展包>1.1 安装 go-i18n 扩展包</h3><p>首先来看消息提示文本，消息提示文本通常包括表单验证消息、应用异常消息、接口响应消息等后端接口返回的消息字符串片段，关于这一块的本地化，可以借助 Go 官方自带的 <code>golang.org/x/text</code> 扩展包实现，这个扩展包扩展性好，但是上手起来有点复杂，因此我们使用的是一款更容易上手的第三方扩展包 —— <a href=https://github.com/nicksnyder/go-i18n target=_blank rel="external nofollow noopener noreferrer">go-i18n</a>。</p><p>在使用这个扩展包之前，先在项目根目录下运行如下命令下载相关的扩展包：</p><div class=highlight id=id-1><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go get -u github.com/nicksnyder/go-i18n/v2/i18n
</span></span><span class=line><span class=cl>go get -u github.com/nicksnyder/go-i18n/v2/goi18n</span></span></code></pre></td></tr></table></div></div><p>下载完成后，我们可以运行 <code>goi18n -help</code> 确保 <code>goi18n</code> 命令可执行</p><h3 id=12-通过-go-i18n-自动生成翻译文件>1.2 通过 go-i18n 自动生成翻译文件</h3><p>接下来，我们来编写消息文本模板用于生成翻译文件。在这个项目中，只有一个消息提示文本，那就是访问的群组不存在时返回的 <code>Cannot read thread</code>，因此，我们在项目根目录下创建 <code>messages.go</code>，并基于 <code>go-i18n</code> 提供的类型编写消息模板如下：</p><div class=highlight id=id-2><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;github.com/nicksnyder/go-i18n/v2/i18n&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>messages</span> <span class=p>=</span> <span class=p>[]</span><span class=nx>i18n</span><span class=p>.</span><span class=nx>Message</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>ID</span><span class=p>:</span> <span class=s>&#34;thread_not_found&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>Description</span><span class=p>:</span> <span class=s>&#34;Thread not exists in db&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>Other</span><span class=p>:</span> <span class=s>&#34;Cannot read thread&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>其中 <code>ID</code> 是消息文本的唯一标识，<code>Other</code> 则是对应的翻译字符串（默认是英文），然后基于 <code>goi18n</code> 命令自动生成翻译文件到 <code>locales</code> 目录（执行前先创建 <code>locales</code> 目录）：</p><div class=highlight id=id-3><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>mkdir</span> <span class=nx>locales</span>
</span></span><span class=line><span class=cl><span class=nx>goi18n</span> <span class=nx>extract</span> <span class=o>-</span><span class=nx>outdir</span><span class=p>=</span><span class=nx>locales</span> <span class=o>-</span><span class=nx>format</span><span class=p>=</span><span class=nx>json</span> <span class=nx>messages</span><span class=p>.</span><span class=k>go</span></span></span></code></pre></td></tr></table></div></div><p>这样，就会在 <code>locales</code> 目录下生成可以被 <code>go-i18n</code> 包识别并解析的 JSON 格式翻译文件 <code>active.en.json</code>：</p><p><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200607_Snipaste_2020-06-07_20-37-07.png srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200607_Snipaste_2020-06-07_20-37-07.png, https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200607_Snipaste_2020-06-07_20-37-07.png 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200607_Snipaste_2020-06-07_20-37-07.png 2x" sizes=auto data-title=https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200607_Snipaste_2020-06-07_20-37-07.png data-alt=https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200607_Snipaste_2020-06-07_20-37-07.png style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><h3 id=13-编写中文版本翻译文件>1.3 编写中文版本翻译文件</h3><p>然后，要进行本地化编程，可以在同级目录下创建并编辑 <code>active.zh.json</code> 用于存放消息文本的中文翻译：</p><p><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200607_Snipaste_2020-06-07_20-38-01.png srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200607_Snipaste_2020-06-07_20-38-01.png, https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200607_Snipaste_2020-06-07_20-38-01.png 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200607_Snipaste_2020-06-07_20-38-01.png 2x" sizes=auto data-title=https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200607_Snipaste_2020-06-07_20-38-01.png data-alt=https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200607_Snipaste_2020-06-07_20-38-01.png style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><h3 id=14-本地化配置初始化>1.4 本地化配置初始化</h3><p>回到在在线论坛项目，打开配置文件 <code>config.json</code>，新增本地化目录和语言配置：</p><div class=highlight id=id-4><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;App&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;Locale&#34;</span><span class=p>:</span> <span class=s>&#34;locales&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;Language&#34;</span><span class=p>:</span> <span class=s>&#34;zh&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>然后在 <code>config/config.go</code> 中新增与之映射的结构体字段，以及对应的初始化设置：</p><div class=highlight id=id-5><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>config</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;encoding/json&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/nicksnyder/go-i18n/v2/i18n&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;golang.org/x/text/language&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;sync&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>App</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>Locale</span>       <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>Language</span>     <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Configuration</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>App</span> <span class=nx>App</span>
</span></span><span class=line><span class=cl>    <span class=nx>Db</span>  <span class=nx>Database</span>
</span></span><span class=line><span class=cl>    <span class=nx>LocaleBundle</span> <span class=o>*</span><span class=nx>i18n</span><span class=p>.</span><span class=nx>Bundle</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>config</span> <span class=o>*</span><span class=nx>Configuration</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>once</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Once</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 通过单例模式初始化全局配置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>LoadConfig</span><span class=p>()</span> <span class=o>*</span><span class=nx>Configuration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>once</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>file</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;config.json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=s>&#34;Cannot open config file&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>decoder</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewDecoder</span><span class=p>(</span><span class=nx>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>config</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>Configuration</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=nx>err</span> <span class=p>=</span> <span class=nx>decoder</span><span class=p>.</span><span class=nf>Decode</span><span class=p>(</span><span class=nx>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=s>&#34;Cannot get configuration from file&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 本地化初始设置
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>bundle</span> <span class=o>:=</span> <span class=nx>i18n</span><span class=p>.</span><span class=nf>NewBundle</span><span class=p>(</span><span class=nx>language</span><span class=p>.</span><span class=nx>English</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>bundle</span><span class=p>.</span><span class=nf>RegisterUnmarshalFunc</span><span class=p>(</span><span class=s>&#34;json&#34;</span><span class=p>,</span> <span class=nx>json</span><span class=p>.</span><span class=nx>Unmarshal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>bundle</span><span class=p>.</span><span class=nf>MustLoadMessageFile</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>App</span><span class=p>.</span><span class=nx>Locale</span> <span class=o>+</span> <span class=s>&#34;/active.en.json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>bundle</span><span class=p>.</span><span class=nf>MustLoadMessageFile</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>App</span><span class=p>.</span><span class=nx>Locale</span> <span class=o>+</span> <span class=s>&#34;/active.&#34;</span> <span class=o>+</span> <span class=nx>config</span><span class=p>.</span><span class=nx>App</span><span class=p>.</span><span class=nx>Language</span> <span class=o>+</span> <span class=s>&#34;.json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>config</span><span class=p>.</span><span class=nx>LocaleBundle</span> <span class=p>=</span> <span class=nx>bundle</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>config</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>注意我们在 <code>App</code> 结构体中新增了一个 <code>*i18n.Bundle</code> 类型的 <code>LocaleBundle</code> 字段，用于存放全局本地化 Bundle 实例，并且在 <code>LoadConfig()</code> 方法中以单例模式初始化该实例。</p><h3 id=15-在处理器方法中返回本地化消息>1.5 在处理器方法中返回本地化消息</h3><p>接下来，我们打开 <code>handlers/helper.go</code>，在 <code>init</code> 方法中初始化 Localizer 以便被所有处理器方法使用：</p><div class=highlight id=id-6><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>handlers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/nicksnyder/go-i18n/v2/i18n&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span> <span class=s>&#34;github.com/xueyuanjun/chitchat/config&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>logger</span> <span class=o>*</span><span class=nx>log</span><span class=p>.</span><span class=nx>Logger</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>config</span> <span class=o>*</span><span class=nx>Configuration</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>localizer</span> <span class=o>*</span><span class=nx>i18n</span><span class=p>.</span><span class=nx>Localizer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取全局配置实例
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>config</span> <span class=p>=</span> <span class=nf>LoadConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取本地化实例
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>localizer</span> <span class=p>=</span> <span class=nx>i18n</span><span class=p>.</span><span class=nf>NewLocalizer</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>LocaleBundle</span><span class=p>,</span> <span class=nx>config</span><span class=p>.</span><span class=nx>App</span><span class=p>.</span><span class=nx>Language</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span></span></span></code></pre></td></tr></table></div></div><p>最后在 <code>handlers/thread.go</code> 和 <code>handlers/post.go</code> 中调用 <code>errorMessage</code> 辅助函数的地方调用 Localizer 提供的方法对消息文本进行翻译并返回给用户：</p><div class=highlight id=id-7><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>msg</span> <span class=o>:=</span> <span class=nx>localizer</span><span class=p>.</span><span class=nf>MustLocalize</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>i18n</span><span class=p>.</span><span class=nx>LocalizeConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>MessageID</span><span class=p>:</span> <span class=s>&#34;thread_not_found&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=nf>errorMessage</span><span class=p>(</span><span class=nx>writer</span><span class=p>,</span> <span class=nx>request</span><span class=p>,</span> <span class=nx>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=16-测试消息本地化>1.6 测试消息本地化</h3><p>重新启动应用，如果试图访问一个不存在的群组页面，就会返回如下中文提示信息：</p><p><img loading=lazy src=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869249174748.jpg srcset="https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869249174748.jpg, https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869249174748.jpg 1.5x, https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869249174748.jpg 2x" sizes=auto data-title=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869249174748.jpg data-alt=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869249174748.jpg style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'>说明我们的本地化翻译生效了，当然这里只是使用了 <code>go-i18n</code> 提供的最基本的功能，想要了解更多使用示例，可以参考如下链接：</p><ul><li><a href=https://github.com/nicksnyder/go-i18n target=_blank rel="external nofollow noopener noreferrer">官方文档</a></li><li><a href=https://zyfdegh.github.io/post/201809-translation-go-i18n/ target=_blank rel="external nofollow noopener noreferrer">借助 go-i18n 更简单地实现全球化</a></li></ul><h2 id=2-视图本地化>2. 视图本地化</h2><p>所谓视图本地化指的是静态 HTML 视图模板的本地化，这里就不再适合使用消息文本翻译的方式实现了，最简单的方式就是为每个语言创建独立的视图模板进行本地化，然后在应用代码中通过读取全局配置、用户手动选择、客户端参数（比如 HTML 请求头中的 <code>Accept-Language</code> 字段）、或者域名信息来判断加载那种本地化视图模板，为了简化演示流程，这里我们使用全局配置的方式，也就是我们上面配置文件中设置的 <code>Language</code> 字段。</p><h3 id=21-创建本地化视图模板>2.1 创建本地化视图模板</h3><p>首先，我们在 <code>views</code> 目录下新增 <code>en</code> 和 <code>zh</code> 两个子目录，分别用于存放英文视图模板和中文视图模板，然后将原有视图文件移动到 <code>en</code> 目录下，并且在 <code>zh</code> 目录下创建每个视图模板的中文版本，以首页 <code>index.html</code> 为例，对应的中文版本如下：</p><p><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/Snipaste_2020-06-07_20-40-32.png srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Snipaste_2020-06-07_20-40-32.png, https://picped-1301226557.cos.ap-beijing.myqcloud.com/Snipaste_2020-06-07_20-40-32.png 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/Snipaste_2020-06-07_20-40-32.png 2x" sizes=auto data-title=https://picped-1301226557.cos.ap-beijing.myqcloud.com/Snipaste_2020-06-07_20-40-32.png data-alt=https://picped-1301226557.cos.ap-beijing.myqcloud.com/Snipaste_2020-06-07_20-40-32.png style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>其他中文视图模板也是类似，将其中的英文文本统一翻译成中文即可。</p><h3 id=22-通过配置加载本地化视图>2.2 通过配置加载本地化视图</h3><p>打开 <code>handlers/helper.go</code>，在 <code>generateHTML</code> 方法中通过读取全局配置加载对应的本地化视图模板：</p><div class=highlight id=id-8><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>generateHTML</span><span class=p>(</span><span class=nx>writer</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>data</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>filenames</span> <span class=o>...</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>files</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>file</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>filenames</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>files</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>files</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;views/%s/%s.html&#34;</span><span class=p>,</span> <span class=nx>config</span><span class=p>.</span><span class=nx>App</span><span class=p>.</span><span class=nx>Language</span><span class=p>,</span> <span class=nx>file</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>templates</span> <span class=o>:=</span> <span class=nx>template</span><span class=p>.</span><span class=nf>Must</span><span class=p>(</span><span class=nx>template</span><span class=p>.</span><span class=nf>ParseFiles</span><span class=p>(</span><span class=nx>files</span><span class=o>...</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>templates</span><span class=p>.</span><span class=nf>ExecuteTemplate</span><span class=p>(</span><span class=nx>writer</span><span class=p>,</span> <span class=s>&#34;layout&#34;</span><span class=p>,</span> <span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>非常简单，不再赘述。</p><blockquote><p>注：同时移除 <code>parseTemplateFiles</code> 方法，并将调用该方法的地方调整为调用 <code>generateHTML</code> 以避免维护两个地方。</p></blockquote><h3 id=23-测试视图本地化>2.3 测试视图本地化</h3><p>重启应用，访问首页，即可看到页面视图已经都是中文显示了：</p><p><img loading=lazy src=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869255064861.jpg srcset="https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869255064861.jpg, https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869255064861.jpg 1.5x, https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869255064861.jpg 2x" sizes=auto data-title=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869255064861.jpg data-alt=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869255064861.jpg style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p><img loading=lazy src=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869255266935.jpg srcset="https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869255266935.jpg, https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869255266935.jpg 1.5x, https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869255266935.jpg 2x" sizes=auto data-title=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869255266935.jpg data-alt=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869255266935.jpg style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p><img loading=lazy src=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869256552424.jpg srcset="https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869256552424.jpg, https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869256552424.jpg 1.5x, https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869256552424.jpg 2x" sizes=auto data-title=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869256552424.jpg data-alt=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869256552424.jpg style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p><img loading=lazy src=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869256718104.jpg srcset="https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869256718104.jpg, https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869256718104.jpg 1.5x, https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869256718104.jpg 2x" sizes=auto data-title=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869256718104.jpg data-alt=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869256718104.jpg style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><h2 id=3-日期时间本地化>3. 日期时间本地化</h2><p>看起来都已经 OK 了，不过还有个小问题，那就是日期时间显示还是英文风格的，对应的实现代码在 <code>models/thread.go</code> 中：</p><div class=highlight id=id-9><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>thread</span> <span class=o>*</span><span class=nx>Thread</span><span class=p>)</span> <span class=nf>CreatedAtDate</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>thread</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>.</span><span class=nf>Format</span><span class=p>(</span><span class=s>&#34;Jan 2, 2006 at 3:04pm&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>我们当然可以直接修改这里来实现类似 <code>2006-01-02 15:04:05</code> 的日期时间格式（该时间节点是 Go 语言元年），不过，学院君这里换一种复杂一点的实现，以便顺手介绍下如何在 Go 视图模板中通过管道模式调用自定义函数。</p><h3 id=31-将自定义函数应用到视图模板>3.1 将自定义函数应用到视图模板</h3><p>打开 <code>handlers/helper.go</code>，新增一个格式化日期时间的函数 <code>formatDate</code>，然后在 <code>generateHTML</code> 方法中将这个函数通过 <code>template.FuncMap</code> 组装后再通过 <code>Funcs</code> 方法应用到视图模板中，这样，就可以在所有视图模板中通过 <code>fdate</code> 别名来调用 <code>formatDate</code> 函数了：</p><div class=highlight id=id-10><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 生成 HTML 模板
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>generateHTML</span><span class=p>(</span><span class=nx>writer</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>data</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>filenames</span> <span class=o>...</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>files</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>file</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>filenames</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>files</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>files</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;views/%s/%s.html&#34;</span><span class=p>,</span> <span class=nx>config</span><span class=p>.</span><span class=nx>App</span><span class=p>.</span><span class=nx>Language</span><span class=p>,</span> <span class=nx>file</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>funcMap</span> <span class=o>:=</span> <span class=nx>template</span><span class=p>.</span><span class=nx>FuncMap</span><span class=p>{</span><span class=s>&#34;fdate&#34;</span><span class=p>:</span> <span class=nx>formatDate</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>t</span> <span class=o>:=</span> <span class=nx>template</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;layout&#34;</span><span class=p>).</span><span class=nf>Funcs</span><span class=p>(</span><span class=nx>funcMap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>templates</span> <span class=o>:=</span> <span class=nx>template</span><span class=p>.</span><span class=nf>Must</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nf>ParseFiles</span><span class=p>(</span><span class=nx>files</span><span class=o>...</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>templates</span><span class=p>.</span><span class=nf>ExecuteTemplate</span><span class=p>(</span><span class=nx>writer</span><span class=p>,</span> <span class=s>&#34;layout&#34;</span><span class=p>,</span> <span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 日期格式化辅助函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>formatDate</span><span class=p>(</span><span class=nx>t</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>datetime</span> <span class=o>:=</span> <span class=s>&#34;2006-01-02 15:04:05&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>t</span><span class=p>.</span><span class=nf>Format</span><span class=p>(</span><span class=nx>datetime</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=32-调用自定义函数格式化本地日期时间>3.2 调用自定义函数格式化本地日期时间</h3><p>然后我们在所有视图文件中将群组创建日期渲染调整为如下方式，即通过管道连接符的方式将 <code>.CreatedAt</code> 变量作为参数传入 <code>fdate</code> 并输出返回值：</p><div class=highlight id=id-11><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=p>{{</span> <span class=p>.</span><span class=nx>CreatedAt</span> <span class=p>|</span> <span class=nx>fdate</span> <span class=p>}}</span></span></span></code></pre></td></tr></table></div></div><p>注意这里一定要使用 <code>.CreatedAt</code>，这个变量才是 <code>time.Time</code> 类型，而 <code>.CreatedAtDate</code> 是字符串类型。</p><p>再次重新启动应用，访问首页和群组详情页就可以看到格式化后的本地日期时间格式了：</p><p><img loading=lazy src=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869318235491.jpg srcset="https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869318235491.jpg, https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869318235491.jpg 1.5x, https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869318235491.jpg 2x" sizes=auto data-title=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869318235491.jpg data-alt=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869318235491.jpg style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p><img loading=lazy src=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869318394657.jpg srcset="https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869318394657.jpg, https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869318394657.jpg 1.5x, https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869318394657.jpg 2x" sizes=auto data-title=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869318394657.jpg data-alt=https://qcdn.xueyuanjun.com/storage/uploads/images/gallery/2020-04/image-15869318394657.jpg style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2020-06-07 00:00:00">更新于 2020-06-07&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/2020/development-of-online-forum-based-on-golang-8-message-view-and-date-time-localizationsingleton-mode/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://shuzang.github.io/2020/development-of-online-forum-based-on-golang-8-message-view-and-date-time-localizationsingleton-mode/ data-title=基于Go语言开发在线论坛8-消息、视图和日期时间本地化 data-hashtags=Go实战><i class="fa-brands fa-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://shuzang.github.io/2020/development-of-online-forum-based-on-golang-8-message-view-and-date-time-localizationsingleton-mode/ data-hashtag=Go实战><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://shuzang.github.io/2020/development-of-online-forum-based-on-golang-8-message-view-and-date-time-localizationsingleton-mode/ data-title=基于Go语言开发在线论坛8-消息、视图和日期时间本地化><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/go%E5%AE%9E%E6%88%98/ class=post-tag>Go实战</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/2020/development-of-online-forum-based-on-golang-7-get-global-configuration-through-singleton-mode/ class=post-nav-item rel=prev title=基于Go语言开发在线论坛7-通过单例模式获取全局配置><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>基于Go语言开发在线论坛7-通过单例模式获取全局配置</a>
<a href=/2020/development-of-online-forum-based-on-golang-9-deploy-go-web-application/ class=post-nav-item rel=next title="基于Go语言开发在线论坛9-部署Go Web应用">基于Go语言开发在线论坛9-部署Go Web应用<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.117.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.2.18"><img class=fixit-icon src=/fixit.min.svg alt="FixIt logo">&nbsp;FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=/>Shuzang</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div><div class="footer-line visitor"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class="variant-numeric d-none">0%</span></div></div><a href=https://github.com/shuzang title="View source on GitHub" target=_blank rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;top:0></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><link rel=stylesheet href=/lib/pace/themes/blue/pace-theme-minimal.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/twemoji/twemoji.min.js defer></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script src=/lib/pace/pace.min.js async defer></script><script>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{enable:!1},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:30,threshold:.3,type:"fuse",useExtendedSearch:!1},twemoji:!0}</script><script src=/js/theme.min.js defer></script></body></html>