<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>Golang使用gorilla、mux包 - Shuzang's Blog</title><meta name=author content><meta name=author-link content><meta name=description content="本文介绍 gorilla/mux 包的使用。"><meta name=keywords content="Golang"><meta itemprop=name content="Golang使用gorilla、mux包"><meta itemprop=description content="本文介绍 gorilla/mux 包的使用。"><meta itemprop=datePublished content="2020-05-29T13:38:00+08:00"><meta itemprop=dateModified content="2020-05-29T00:00:00+00:00"><meta itemprop=wordCount content="2559"><meta itemprop=image content="https://shuzang.github.io/logo.png"><meta itemprop=keywords content="Golang,"><meta property="og:title" content="Golang使用gorilla、mux包"><meta property="og:description" content="本文介绍 gorilla/mux 包的使用。"><meta property="og:type" content="article"><meta property="og:url" content="https://shuzang.github.io/2020/golang-use-gorilla/mux-package/"><meta property="og:image" content="https://shuzang.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-05-29T13:38:00+08:00"><meta property="article:modified_time" content="2020-05-29T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://shuzang.github.io/logo.png"><meta name=twitter:title content="Golang使用gorilla、mux包"><meta name=twitter:description content="本文介绍 gorilla/mux 包的使用。"><meta name=application-name content="Shuzang's Blog"><meta name=apple-mobile-web-app-title content="Shuzang's Blog"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://shuzang.github.io/2020/golang-use-gorilla/mux-package/><link rel=prev href=https://shuzang.github.io/2020/golang-start-http-server/><link rel=next href=https://shuzang.github.io/2020/golang-template/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://unpkg.com/@fortawesome/fontawesome-free@6.2.0/css/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://unpkg.com/@fortawesome/fontawesome-free@6.2.0/css/all.min.css></noscript><link rel=preload href=https://unpkg.com/animate.css@4.1.1/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://unpkg.com/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Golang使用gorilla、mux包","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/shuzang.github.io\/2020\/golang-use-gorilla\/mux-package\/"},"genre":"posts","keywords":"Golang","wordcount":2559,"url":"https:\/\/shuzang.github.io\/2020\/golang-use-gorilla\/mux-package\/","datePublished":"2020-05-29T13:38:00+08:00","dateModified":"2020-05-29T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"作者"},"description":""}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=right><div class=header-title><a href=/ title="Shuzang's Blog"><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/avatar.png data-title="Shuzang's Blog" data-alt="Shuzang's Blog" class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>Shuzang's Blog</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/collection/><i class="fa-solid fa-bookmark fa-fw fa-sm" aria-hidden=true></i> 集子</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Shuzang's Blog"><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/avatar.png data-title=https://picped-1301226557.cos.ap-beijing.myqcloud.com/avatar.png data-alt=https://picped-1301226557.cos.ap-beijing.myqcloud.com/avatar.png class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>Shuzang's Blog</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/collection/><i class="fa-solid fa-bookmark fa-fw fa-sm" aria-hidden=true></i> 集子</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Golang使用gorilla、mux包</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle" aria-hidden=true></i></span></span>
<span class=post-category>收录于 <a href=/categories/%E7%88%B1%E7%BC%96%E7%A8%8B%E7%88%B1%E6%8A%80%E6%9C%AF%E7%9A%84%E5%AD%A9%E5%AD%90/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> 爱编程爱技术的孩子</a></span></div><div class=post-meta-line><span title="发布于 2020-05-29 13:38:00"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden=true></i><time datetime=2020-05-29>2020-05-29</time></span>&nbsp;<span title="更新于 2020-05-29 00:00:00"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden=true></i><time datetime=2020-05-29>2020-05-29</time></span>&nbsp;<span title="2559 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 2600 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 6 分钟</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-使用入门>1. 使用入门</a></li><li><a href=#2-路由代码拆分>2. 路由代码拆分</a><ul><li><a href=#21-路由器>2.1 路由器</a></li><li><a href=#22-服务器>2.2 服务器</a></li><li><a href=#23-处理器>2.3 处理器</a></li></ul></li><li><a href=#3-路由匹配规则>3. 路由匹配规则</a><ul><li><a href=#31-常用匹配规则>3.1 常用匹配规则</a></li><li><a href=#32-自定义匹配规则>3.2 自定义匹配规则</a></li><li><a href=#33-路由命名>3.3 路由命名</a></li></ul></li><li><a href=#4-路由中间件>4. 路由中间件</a></li><li><a href=#5-处理静态资源响应>5. 处理静态资源响应</a></li></ul></nav></div></div><div class=content id=content><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fa-solid fa-exclamation-triangle fa-fw" aria-hidden=true></i>警告<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>本文最后更新于 2020-05-29，文中内容可能已过时。</div></div></div><p>本文介绍 <a href=https://github.com/gorilla/mux target=_blank rel="external nofollow noopener noreferrer">gorilla/mux</a> 包的使用。</p><p>我们已知 Go 标准库 net/http 提供的默认路由是 DefaultServeMux，虽然简单易上手，但存在很多不足，比如</p><ul><li>不支持参数设定，例如 <code>/user/:uid</code> 这种泛类型匹配；</li><li>对 REST 风格接口支持不友好，无法限制访问路由的方法；</li><li>对于拥有很多路由规则的应用，编写大量路由规则非常繁琐。</li></ul><p>为此，我们可以使用第三方库 <code>gorilla/mux</code> 提供的更加强大的路由处理器（<code>mux</code> 代表 <code>HTTP request multiplexer</code>，即 HTTP 请求多路复用器），和 <code>http.ServeMux</code> 实现原理一样，<code>gorilla/mux</code> 提供的路由器实现类 <code>mux.Router</code> 也会匹配用户请求与系统注册的路由规则，然后将用户请求转发过去。</p><div class=highlight id=id-1><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Router</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Configurable Handler to be used when no route matches.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>NotFoundHandler</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Configurable Handler to be used when the request method does not match the route.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>MethodNotAllowedHandler</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Routes to be matched, in order.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>routes</span> <span class=p>[]</span><span class=o>*</span><span class=nx>Route</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Routes by name for URL building.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>namedRoutes</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>Route</span>
</span></span><span class=line><span class=cl>	<span class=c1>// If true, do not clear the request context after handling the request.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Deprecated: No effect, since the context is stored on the request itself.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>KeepContext</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Slice of middlewares to be called after a match is found
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>middlewares</span> <span class=p>[]</span><span class=nx>middleware</span>
</span></span><span class=line><span class=cl>	<span class=c1>// configuration shared with `Route`
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>routeConf</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p><code>mux.Router</code> 主要具备以下特性：</p><ul><li>实现了 <code>http.Handler</code> 接口，所以和 <code>http.ServeMux</code> 完全兼容；</li><li>可以基于 URL 主机、路径、前缀、scheme、请求头、请求参数、请求方法进行路由匹配；</li><li>URL 主机、路径、查询字符串支持可选的正则匹配；</li><li>支持构建或反转已注册的 URL 主机，以便维护对资源的引用；</li><li>支持路由嵌套，以便不同路由可以共享通用条件，比如主机、路径前缀等。</li></ul><h2 id=1-使用入门>1. 使用入门</h2><p>运行如下命令进行安装</p><div class=highlight id=id-2><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ go get -u github.com/gorilla/mux</span></span></code></pre></td></tr></table></div></div><p>一个简单的示例如下</p><div class=highlight id=id-3><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span> <span class=o>:=</span> <span class=nx>mux</span><span class=p>.</span><span class=nf>NewRouter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=nx>HomeHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/products&#34;</span><span class=p>,</span> <span class=nx>ProductsHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/articles&#34;</span><span class=p>,</span> <span class=nx>ArticlesHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:8080&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p><code>main</code> 函数中的第一行显式初始化了 <code>mux.Router</code> 作为路由器，然后在这个路由器中注册路由规则，最后将这个路由器传入 <code>http.ListenAndServe</code> 方法，整个调用过程和之前并无二致，因为<code>mux.Router</code> 也实现了 <code>Handler</code> 接口。</p><p>路径中可以包含变量。变量的定义形式为 <code>{name}</code> 或 <code>{name:pattern}</code>，只能是小写字母，不支持其它字符，同时，name 可以是正则表达式，如下面的例子所示</p><div class=highlight id=id-4><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span> <span class=o>:=</span> <span class=nx>mux</span><span class=p>.</span><span class=nf>NewRouter</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/products/{key}&#34;</span><span class=p>,</span> <span class=nx>ProductHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/articles/{category}/&#34;</span><span class=p>,</span> <span class=nx>ArticlesCategoryHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/articles/{category}/{id:[0-9]+}&#34;</span><span class=p>,</span> <span class=nx>ArticleHandler</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>相应地，在闭包处理函数中，我们使用 <code>mux.Vars()</code> 解析路由参数：</p><div class=highlight id=id-5><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>ArticlesCategoryHandler</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>vars</span> <span class=o>:=</span> <span class=nx>mux</span><span class=p>.</span><span class=nf>Vars</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>w</span><span class=p>.</span><span class=nf>WriteHeader</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Category: %v\n&#34;</span><span class=p>,</span> <span class=nx>vars</span><span class=p>[</span><span class=s>&#34;category&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=2-路由代码拆分>2. 路由代码拆分</h2><p>比较简单的情况下，所有的路由、处理器都放在应用入口文件中，一般是 main.go，但如果项目比较大，甚至仅仅是博客这种级别的项目，就要处理文章、用户、图片等众多资源，所以我们需要针对这种情况进行一定的优化。</p><p>优化的办法就是将路由器与控制器分离，为了使代码结构更加清晰明了，我们把服务器、路由器、路由定义、处理器方法全都拆分开。</p><h3 id=21-路由器>2.1 路由器</h3><p>我们在项目根目录下新建 <code>routes</code> 目录用来存放路由定义及实现。</p><p>首先在 <code>routes</code> 目录下创建 <code>routes.go</code> 存放路由定义，文件内容如下</p><div class=highlight id=id-6><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>routes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 定义一个 WebRoute 结构体用于存放单个路由
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>WebRoute</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span>        <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>Method</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>Pattern</span>     <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>HandlerFunc</span> <span class=nx>http</span><span class=p>.</span><span class=nx>HandlerFunc</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 声明 WebRoutes 切片存放所有 Web 路由
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>WebRoutes</span> <span class=p>[]</span><span class=nx>WebRoute</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 定义所有 Web 路由
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>webRoutes</span> <span class=p>=</span> <span class=nx>WebRoutes</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>在这里，我们定义了一个 <code>WebRoute</code> 结构体来表示单个路由，其中包含了路由名称、请求方法、匹配字符串模式、以及对应的处理器方法，路由器可以根据这些配置请求请求分发。</p><p>然后定义了一个 <code>WebRoutes</code> 切片来存放所有 <code>WebRoute</code> 类型的路由，最后初始化这个切片为空，表示还没有定义任何路由。</p><p>接下来，在 <code>routes</code> 目录下创建 <code>router.go</code> 用来编写路由器实现</p><div class=highlight id=id-7><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>routes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;github.com/gorilla/mux&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 返回一个 mux.Router 类型指针，从而可以当作处理器使用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewRouter</span><span class=p>()</span> <span class=o>*</span><span class=nx>mux</span><span class=p>.</span><span class=nx>Router</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建 mux.Router 路由器示例
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>router</span> <span class=o>:=</span> <span class=nx>mux</span><span class=p>.</span><span class=nf>NewRouter</span><span class=p>().</span><span class=nf>StrictSlash</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 遍历 web.go 中定义的所有 webRoutes
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>route</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>webRoutes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 将每个 web 路由应用到路由器
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>router</span><span class=p>.</span><span class=nf>Methods</span><span class=p>(</span><span class=nx>route</span><span class=p>.</span><span class=nx>Method</span><span class=p>).</span>
</span></span><span class=line><span class=cl>            <span class=nf>Path</span><span class=p>(</span><span class=nx>route</span><span class=p>.</span><span class=nx>Pattern</span><span class=p>).</span>
</span></span><span class=line><span class=cl>            <span class=nf>Name</span><span class=p>(</span><span class=nx>route</span><span class=p>.</span><span class=nx>Name</span><span class=p>).</span>
</span></span><span class=line><span class=cl>            <span class=nf>Handler</span><span class=p>(</span><span class=nx>route</span><span class=p>.</span><span class=nx>HandlerFunc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>router</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>StrictSlash 定义斜杠尾随行为，意思是，传入 true 时，如果路由路径是 <code>/path</code> 这种形式，将重定向到 <code>/path/</code> ，反之亦然。传入 false 时，不会重定向，这两种情况不会看作一种。</p><p>Methods，Path，Name，Handler分别用来限定请求方法、匹配字符串模式、路由名和处理器方法。通过这种方式，我们将 routes.go 中定义的所有 Web 路由都应用到了使用 mux.NewRouter 创建的路由器，以便可以处理用户请求的路由匹配和分发。</p><h3 id=22-服务器>2.2 服务器</h3><p>在入口文件 main.go 中使用如下方法启动服务器</p><div class=highlight id=id-8><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>     <span class=p>.</span> <span class=s>&#34;github.com/shuzang/projectname/routes&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>startWebServer</span><span class=p>(</span><span class=s>&#34;8080&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>startWebServer</span><span class=p>(</span><span class=nx>port</span> <span class=kt>string</span><span class=p>)</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span> <span class=o>:=</span> <span class=nf>NewRouter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>http</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Starting HTTP service at &#34;</span> <span class=o>+</span> <span class=nx>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:&#34;</span><span class=o>+</span><span class=nx>port</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span> <span class=c1>// Goroutine will block here
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;An error occured starting HTTP listener at port &#34;</span> <span class=o>+</span> <span class=nx>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Error: &#34;</span> <span class=o>+</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>我们将 Web 服务器启动逻辑封装到 <code>startWebServer</code> 方法中实现，该方法需要传入端口参数。在具体实现时，我们调用了 <code>routes/router.go</code> 中定义的 <code>NewRouter</code> 方法，将其返回值作为处理器传入 <code>http.Handle</code> 方法，最后调用 <code>http.ListenAndServe</code> 启动 Web 服务器并监听传入的端口号。</p><p>最后在 <code>main</code> 方法中调用 <code>startWebServer</code> 方法即可。</p><h3 id=23-处理器>2.3 处理器</h3><p>上层代码写完后，现在定义处理器方法。在项目根目录下新建 <code>handlers</code> 目录存放处理器方法，这里举 2 个示例，分别定义在 <code>common.go</code> 和 <code>user.go</code> 两个文件中，用来处理通用请求和用户资源。</p><p>首先在 <code>common.go</code> 中编写首页请求处理器方法</p><div class=highlight id=id-9><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>handlers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;io&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Home</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>io</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Welcome to my site&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>然后在 <code>user.go</code> 中定义获取指定用户对应处理器方法</p><div class=highlight id=id-10><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>handlers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gorilla/mux&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;io&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>GetUser</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Get user from DB by id...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>params</span> <span class=o>:=</span> <span class=nx>mux</span><span class=p>.</span><span class=nf>Vars</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span> <span class=o>:=</span> <span class=nx>params</span><span class=p>[</span><span class=s>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>io</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Return user info with id = &#34;</span> <span class=o>+</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>这时要记得，<code>routes/routes.go</code> 中的路由切片还是空的，用实现的处理器填充它</p><div class=highlight id=id-11><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>webRoutes</span> <span class=p>=</span> <span class=nx>WebRoutes</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>WebRoute</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;Home&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;GET&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>handlers</span><span class=p>.</span><span class=nx>Home</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>WebRoute</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;User&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;GET&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;/user/{id}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>handlers</span><span class=p>.</span><span class=nx>GetUser</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=3-路由匹配规则>3. 路由匹配规则</h2><p>第一部分的路由匹配规则只是简单介绍，实际上，gorilla/mux 实现的匹配规则非常强大。</p><h3 id=31-常用匹配规则>3.1 常用匹配规则</h3><p><strong>限定请求方法</strong></p><div class=highlight id=id-12><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/books/{title}&#34;</span><span class=p>,</span> <span class=nx>CreateBook</span><span class=p>).</span><span class=nf>Methods</span><span class=p>(</span><span class=s>&#34;POST&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/books/{title}&#34;</span><span class=p>,</span> <span class=nx>ReadBook</span><span class=p>).</span><span class=nf>Methods</span><span class=p>(</span><span class=s>&#34;GET&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/books/{title}&#34;</span><span class=p>,</span> <span class=nx>UpdateBook</span><span class=p>).</span><span class=nf>Methods</span><span class=p>(</span><span class=s>&#34;PUT&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/books/{title}&#34;</span><span class=p>,</span> <span class=nx>DeleteBook</span><span class=p>).</span><span class=nf>Methods</span><span class=p>(</span><span class=s>&#34;DELETE&#34;</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p><strong>限定主机名或子域名</strong></p><div class=highlight id=id-13><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/books/{title}&#34;</span><span class=p>,</span> <span class=nx>BookHandler</span><span class=p>).</span><span class=nf>Host</span><span class=p>(</span><span class=s>&#34;www.mybookstore.com&#34;</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p><strong>限定 Scheme</strong></p><div class=highlight id=id-14><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/secure&#34;</span><span class=p>,</span> <span class=nx>SecureHandler</span><span class=p>).</span><span class=nf>Schemes</span><span class=p>(</span><span class=s>&#34;https&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/insecure&#34;</span><span class=p>,</span> <span class=nx>InsecureHandler</span><span class=p>).</span><span class=nf>Schemes</span><span class=p>(</span><span class=s>&#34;http&#34;</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p><strong>限定前缀和子路由</strong></p><div class=highlight id=id-15><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>bookrouter</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>PathPrefix</span><span class=p>(</span><span class=s>&#34;/books&#34;</span><span class=p>).</span><span class=nf>Subrouter</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>bookrouter</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=nx>AllBooks</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>bookrouter</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/{title}&#34;</span><span class=p>,</span> <span class=nx>GetBook</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p><strong>限定请求参数</strong></p><div class=highlight id=id-16><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/request/header&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>header</span> <span class=o>:=</span> <span class=s>&#34;X-Requested-With&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;包含指定请求头[%s=%s]&#34;</span><span class=p>,</span> <span class=nx>header</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Header</span><span class=p>[</span><span class=nx>header</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>}).</span><span class=nf>Headers</span><span class=p>(</span><span class=s>&#34;X-Requested-With&#34;</span><span class=p>,</span> <span class=s>&#34;XMLHttpRequest&#34;</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><h3 id=32-自定义匹配规则>3.2 自定义匹配规则</h3><p><code>gorilla/mux</code> 路由支持通过 <code>MatcherFunc</code> 方法自定义路由匹配规则，在该方法中，可以获取到请求实例 <code>request</code>，这样我们就可以拿到所有的用户请求信息，并对其进行判断，符合我们预期的请求才能匹配并访问该方法应用到的路由。</p><p>比如下面这个示例，我们限定只有来自 <code>https://baidu.com</code> 域名的请求才可以匹配到 <code>/custom/matcher</code> 路由</p><div class=highlight id=id-17><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/custom/matcher&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;请求来自指定域名: %s&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Referer</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}).</span><span class=nf>MatcherFunc</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>request</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span> <span class=nx>match</span> <span class=o>*</span><span class=nx>mux</span><span class=p>.</span><span class=nx>RouteMatch</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>request</span><span class=p>.</span><span class=nf>Referer</span><span class=p>()</span> <span class=o>==</span> <span class=s>&#34;https://baidu.com&#34;</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></td></tr></table></div></div><h3 id=33-路由命名>3.3 路由命名</h3><p>通过 <code>Name</code> 方法在路由规则中指定</p><div class=highlight id=id-18><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>postRouter</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>PathPrefix</span><span class=p>(</span><span class=s>&#34;/posts&#34;</span><span class=p>).</span><span class=nf>Subrouter</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>postRouter</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=nx>listPosts</span><span class=p>).</span><span class=nf>Methods</span><span class=p>(</span><span class=s>&#34;GET&#34;</span><span class=p>).</span><span class=nf>Name</span><span class=p>(</span><span class=s>&#34;posts.index&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>postRouter</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/create&#34;</span><span class=p>,</span> <span class=nx>createPost</span><span class=p>).</span><span class=nf>Methods</span><span class=p>(</span><span class=s>&#34;POST&#34;</span><span class=p>).</span><span class=nf>Name</span><span class=p>(</span><span class=s>&#34;posts.create&#34;</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><h2 id=4-路由中间件>4. 路由中间件</h2><h2 id=5-处理静态资源响应>5. 处理静态资源响应</h2><p>使用默认<code>http</code>包处理静态资源的方法如下</p><div class=highlight id=id-19><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>fs</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>FileServer</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nf>Dir</span><span class=p>(</span><span class=s>&#34;assets/&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nx>http</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=s>&#34;/static/&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nf>StripPrefix</span><span class=p>(</span><span class=s>&#34;/static/&#34;</span><span class=p>,</span> <span class=nx>fs</span><span class=p>))</span></span></span></code></pre></td></tr></table></div></div><p>使用 gorilla/mux 时，处理方法很相似</p><div class=highlight id=id-20><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span> <span class=o>:=</span> <span class=nf>NewRouter</span><span class=p>()</span> <span class=c1>// 通过 router.go 中定义的路由器来分发请求
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>assets</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>FileServer</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nf>Dir</span><span class=p>(</span><span class=s>&#34;public&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>PathPrefix</span><span class=p>(</span><span class=s>&#34;/static/&#34;</span><span class=p>).</span><span class=nf>Handler</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nf>StripPrefix</span><span class=p>(</span><span class=s>&#34;/static/&#34;</span><span class=p>,</span> <span class=nx>assets</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>http</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span> <span class=c1>// 应用路由器到 HTTP 服务器
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=o>...</span></span></span></code></pre></td></tr></table></div></div><p>虽然 <code>gorilla/mux</code> 路由器提供了对静态资源的支持，但是通常我们还是会基于 Nginx 来处理静态资源，然后将动态请求转发给 Go HTTP 服务器，因为 Nginx 作为一款强大的反向代理服务器，并发处理静态资源的能力非常强悍，没必要自己去处理这块逻辑。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2020-05-29 00:00:00">更新于 2020-05-29&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/2020/golang-use-gorilla/mux-package/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Pocket" data-sharer=pocket data-url=https://shuzang.github.io/2020/golang-use-gorilla/mux-package/><i class="fa-brands fa-get-pocket fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://shuzang.github.io/2020/golang-use-gorilla/mux-package/ data-title=Golang使用gorilla、mux包><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/golang/ class=post-tag>Golang</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/2020/golang-start-http-server/ class=post-nav-item rel=prev title=Golang启动HTTP服务器><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>Golang启动HTTP服务器</a>
<a href=/2020/golang-template/ class=post-nav-item rel=next title=Golang模板>Golang模板<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div class=post-reward><div class=comment></div><input type=checkbox class=reward-input name=reward id=fi-reward hidden>
<label class=reward-button for=fi-reward>赞赏</label><div class=reward-ways data-mode=static><div><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/alipay.png data-title=" 支付宝" data-alt=" 支付宝" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span>支付宝</span></div><div><img loading=lazy src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/wechatpay.png data-title=" 微信" data-alt=" 微信" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span>微信</span></div></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line custom">Hava a great day !</div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2018 - 2024</span><span class=author itemprop=copyrightHolder>
<a href=/></a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class="variant-numeric d-none">0%</span></div></div><a href=https://github.com/shuzang/shuzang.github.io title="View source on GitHub" target=_blank rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;top:0></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=https://unpkg.com/lightgallery@2.6.1/css/lightgallery-bundle.min.css><link rel=preload href=https://unpkg.com/katex@0.16.2/dist/katex.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://unpkg.com/katex@0.16.2/dist/katex.min.css></noscript><link rel=stylesheet href=https://unpkg.com/pace-js@1.2.4/themes/blue/pace-theme-minimal.css><script src=https://unpkg.com/autocomplete.js@0.38.1/dist/autocomplete.min.js defer></script><script src=https://unpkg.com/fuse.js@6.6.2/dist/fuse.min.js defer></script><script src=https://unpkg.com/twemoji@14.0.2/dist/twemoji.min.js defer></script><script src=https://unpkg.com/lightgallery@2.6.1/lightgallery.min.js defer></script><script src=https://unpkg.com/lightgallery@2.6.1/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=https://unpkg.com/lightgallery@2.6.1/plugins/zoom/lg-zoom.min.js defer></script><script src=https://unpkg.com/sharer.js@0.5.1/sharer.min.js async defer></script><script src=https://unpkg.com/katex@0.16.2/dist/katex.min.js defer></script><script src=https://unpkg.com/katex@0.16.2/dist/contrib/auto-render.min.js defer></script><script src=https://unpkg.com/katex@0.16.2/dist/contrib/copy-tex.min.js defer></script><script src=https://unpkg.com/katex@0.16.2/dist/contrib/mhchem.min.js defer></script><script src=https://unpkg.com/pangu@4.0.7/dist/browser/pangu.min.js defer></script><script src=https://unpkg.com/pace-js@1.2.4/pace.min.js async defer></script><script>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{enable:!1},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},pangu:{enable:!0,selector:"article"},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:30,threshold:.3,type:"fuse",useExtendedSearch:!1},twemoji:!0}</script><script src=/js/theme.min.js defer></script></body></html>