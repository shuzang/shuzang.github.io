<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>区块链学习6-IBFT共识 | Shuzang's Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=Description content="书藏的个人博客，包括Golang、数据结构、算法的学习记录，各类生活技能的学习，每周五发布一期自己的生活周刊"><link rel=prev href=https://shuzang.github.io/2019/sec-blockedge-security-threats-in-blockchain-edge-based-iiot-network/><link rel=next href=https://shuzang.github.io/2019/golang-syntax-4-operators-and-flow-control/><link rel=canonical href=https://shuzang.github.io/2019/ibft-consensus/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta name=twitter:card content="summary"><meta name=twitter:title content="区块链学习6-IBFT共识"><meta name=twitter:description content="AMIS公司提出的 Istanbul Byzantine Fault Tolerance Consensus（简称IBFT或Istanbul BFT），是一个基于PBFT的交易一致性的共识。因为要考虑可能发"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"区块链学习6-IBFT共识","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/shuzang.github.io\/2019\/ibft-consensus\/"},"image":{"@type":"ImageObject","url":"https:\/\/shuzang.github.io\/cover.png","width":800,"height":600},"genre":"posts","keywords":"区块链","wordcount":2733,"url":"https:\/\/shuzang.github.io\/2019\/ibft-consensus\/","datePublished":"2019-10-29T00:00:00\x2b00:00","dateModified":"2019-10-29T00:00:00\x2b00:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"shuzang","logo":{"@type":"ImageObject","url":"https:\/\/shuzang.github.io\/logo.png","width":127,"height":40}},"description":""}</script><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/lib/fontawesome-free/all.min.css></head><body><script>window.isDark=(window.localStorage&&window.localStorage.getItem('theme'))==='dark';window.isDark&&document.body.classList.add('dark-theme');</script><div class=wrapper><nav class=navbar><div class=top-scroll-bar></div><div class=navbar-container><div class="navbar-header animated bounceIn"><a href=https://shuzang.github.io>Shuzang's Blog</a></div><div class=navbar-menu><a class=menu-item href=https://shuzang.github.io/posts>Posts</a><a class=menu-item href=https://shuzang.github.io/tags>Tags</a><a class=menu-item href=https://shuzang.github.io/categories>Categories</a><a class=menu-item href=https://shuzang.github.io/about>About</a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><nav class=navbar-mobile><div class=top-scroll-bar></div><div class=navbar-container><div class=navbar-header><div class="navbar-header-title animated bounceIn"><a href=https://shuzang.github.io>Shuzang's Blog</a></div><div class=menu-toggle id=menu-toggle><span></span><span></span><span></span></div></div><div class=navbar-menu id=mobile-menu><a class=menu-item href=https://shuzang.github.io/posts>Posts</a><a class=menu-item href=https://shuzang.github.io/tags>Tags</a><a class=menu-item href=https://shuzang.github.io/categories>Categories</a><a class=menu-item href=https://shuzang.github.io/about>About</a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><main class=main><div class=container><article class=page><h1 class="post-title animated flipInX">区块链学习6-IBFT共识</h1><div class=post-meta><i class="far fa-calendar-alt fa-fw"></i>published on&nbsp;<time datetime=2019-10-29>2019-10-29</time>&nbsp;
<i class="fas fa-pencil-alt fa-fw"></i>about 2733 words&nbsp;<span class=post-category><i class="far fa-folder fa-fw"></i>included in&nbsp;<a href=https://shuzang.github.io/categories/%E7%A0%94%E7%A9%B6%E7%94%9F%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF/>研究生的区块链学习之路</a>&nbsp;</span></div><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#术语>术语</a></li><li><a href=#共识>共识</a><ul><li><a href=#1-共识状态>1. 共识状态</a></li><li><a href=#2-状态转换>2. 状态转换</a></li><li><a href=#3-round-change工作流>3. Round change工作流</a></li><li><a href=#4-proposer选择>4. Proposer选择</a></li><li><a href=#5-验证者列表投票>5. 验证者列表投票</a></li></ul></li><li><a href=#问题>问题</a></li></ul></nav></div></div><div class=post-toc-mobile id=post-toc-mobile><details><summary><div class=post-toc-title><span>Contents</span>
<span><i class="details icon fas fa-angle-down"></i></span></div></summary><div class=post-toc-content><nav id=TableOfContentsMobile><ul><li><a href=#术语>术语</a></li><li><a href=#共识>共识</a><ul><li><a href=#1-共识状态>1. 共识状态</a></li><li><a href=#2-状态转换>2. 状态转换</a></li><li><a href=#3-round-change工作流>3. Round change工作流</a></li><li><a href=#4-proposer选择>4. Proposer选择</a></li><li><a href=#5-验证者列表投票>5. 验证者列表投票</a></li></ul></li><li><a href=#问题>问题</a></li></ul></nav></div></details></div><div class=post-content><p>AMIS公司提出的 Istanbul Byzantine Fault Tolerance Consensus（简称IBFT或Istanbul BFT），是一个基于PBFT的交易一致性的共识。因为要考虑可能发生的异常，对共识的原始文档作一次通读，仔细理解一下。原始文档位于github <a href=https://github.com/ethereum/EIPs/issues/650 target=_blank>ethereum/EIPs#650</a>，以下一边翻译一边阅读。</p><p>注：EIP，即Ethereum Improvement Proposal，以太坊改进建议</p><hr><p>这一工作深受Clique POA的启发，并在协议层中尽可能设计相同的机制，比如验证者投票。我们遵循EIP风格，将背景和原理放在所提出的共识协议的后面供开发者阅读。这一工作也受到Hyperledger&rsquo;s SBFT，Tendermint，HydraChain和NCCU BFT的启发。</p><a class=post-dummy-target id=术语></a><h2>术语</h2><ul><li>Validator：区块验证者</li><li>Proposer：一轮共识中被选举出打包新区块的验证者。</li><li>Round：共识轮数。一轮共识起始于Proposer打包一个新区块，结束于新区块提交或轮数改变（轮数改变可能由于验证不通过或区块更新）。</li><li>Proposal：共识正在处理的新打包的区块。</li><li>Sequence：新区块的序号（从创世区块起排列的一个顺序），这一数字应大于所有之前区块的序号。目前，每个区块的高度都是它的序号。</li><li>Backlog：将来的共识信息记录在这里面。</li><li>Round state：指定轮数和序号的共识信息，包括预准备信息、准备信息和提交信息。</li><li>Consensus proof：提交的区块签名，每个验证者验证后都会对区块签名，可以证明区块经历了整个共识过程。</li><li>Snapshot：验证者投票状态。</li></ul><a class=post-dummy-target id=共识></a><h2>共识</h2><p>Istanbul BFT基于 <a href=http://pmg.csail.mit.edu/papers/osdi99.pdf target=_blank>PBFT</a> 算法，然而，原始的PBFT需要做一些调整来适应区块链。首先，没有具体的发送请求和等待结果的<code>client</code>的概念，所有的 validator 都可以视作<code>clients</code>。其次，为了保证区块链的运行，需要在每一轮共识中持续不断的选举出 proposer 来打包新的区块，同样，每轮共识的结果是一个可验证的区块而不是文件系统的一组读写操作。</p><p>Istanbul BFT 继承了 PBFT 共识的三阶段：pre-prepare，prepare 和 commit，我们称之为预准备阶段、准备阶段和提交阶段。系统可以容忍 N 个 validator 节点的网络中F个节点错误，其中 N = 3F + 1。每一轮之前，validators会首先投票选出一个proposer，默认的选举方式是轮询。选出的proposer将会打包一个新的区块并附随 pre-prepare 消息广播出去，当接收到 pre-prepare 消息，validators 会进入 pre-prepared 状态，然后广播 prepare 消息。这一步是为了确认所有的 validators 在同一个 sequence 和同一个 round上工作。当接收到 2F + 1个 prepare 消息，validator 就会进入 prepared 状态并广播 commit 消息。这一步是为了通知其它节点它验证了新区块并且将会把新区块添加到了区块链中。最后，验证者们等待 2F + 1 个 commit 消息并进入 committed 状态，最后把区块添加到区块链末尾。</p><p>Istanbul BFT共识中的区块符合最终一致性，这也就是说所有的区块都必须位于主链中，区块链没有分叉。为了防止恶意节点生成一条和主链完全不同的链，每个验证者都要在将区块添加到区块链末尾之前附加 2F + 1 个收到的 commit 签名到区块头的 extraData 字段。因此，所有区块都是自验证的并且支持轻节点。然而，动态的 extraData字段可能造成区块哈希计算的相关问题，因为不同的验证者在同一轮共识中收到的一组 commit 消息可能不同，从而导致 extraData 字段不同，最终整个区块的哈希值不一致，为了应对这种情况，在计算区块哈希时会排除 commit 签名部分。因此，依然可以保持区块/区块哈希的一致性，并把一致性证明放在区块头。</p><a class=post-dummy-target id=1-共识状态></a><h3>1. 共识状态</h3><p>Istanbul BFT是一个状态机复制算法，每个验证者为了达成区块一致都维持一个状态机副本。</p><p>状态(States)：</p><ul><li>new round：proposer打包新区块，验证者等待 pre-prepare 消息</li><li>pre-prepared：验证者接收 pre-prepare 消息，广播 prepare 消息，然后等待 2F + 1 个 prepare 或 commit 消息</li><li>prepared：验证者收到了 2F + 1 个 prepare 消息并广播 commit 消息，然后等待 2F + 1 个commit消息</li><li>commited：验证者收到了 2F + 1 个 commit 消息，可以将新区块插入区块链末尾了</li><li>final commited：新区块成功插入区块链末尾，验证者准备下一轮</li><li>round change：验证者等待同一轮上的 2F + 1 个round change消息</li></ul><a class=post-dummy-target id=2-状态转换></a><h3>2. 状态转换</h3><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/YJS_20191029_%e7%8a%b6%e6%80%81%e8%bd%ac%e6%8d%a2%e5%9b%be.png alt class=lazyload></figure></p><ul><li>New round —> Pre-prepared<ul><li>proposer从交易池收集交易</li><li>proposer打包新区块并广播，然后进入 pre-prepared 状态</li><li>每个验证者收到pre-prepare消息后，若符合如下条件，进入pre-prepared状态<ul><li>新区块来自有效的proposer</li><li>区块头有效</li><li>新区块的序号和轮数符合验证者状态</li></ul></li><li>验证者向其它验证者广播prepare消息</li></ul></li><li>Pre-prepared —> Prepared<ul><li>验证者收到 2F+1 个有效prepare消息后进入prepared状态，prepare消息有效是指符合如下条件<ul><li>序号和轮数匹配</li><li>区块哈希匹配</li><li>消息来自已知验证者</li></ul></li><li>验证者进入prepared状态后广播commit消息</li></ul></li><li>Prepared —> Committed<ul><li>验证者收到 2F+1 个有效commit消息后进入committed状态，commit消息有效是指符合如下条件<ul><li>序号和轮数匹配</li><li>区块哈希匹配</li><li>消息来自已知验证者</li></ul></li></ul></li><li>Commited —> Final committed<ul><li>验证者附加2F+1个提交签名到extraData字段，将区块插入区块链末尾</li><li>区块插入成功后验证者进入Final committed状态</li></ul></li><li>Final Commited —> New round<ul><li>验证者选举新的proposer并启动新一轮共识计时器</li></ul></li></ul><a class=post-dummy-target id=3-round-change工作流></a><h3>3. Round change工作流</h3><ul><li>以下三种情况将会触发 Round change<ul><li>Round change 计时器超时</li><li>无效 prepared 消息</li><li>区块插入失败</li></ul></li><li>当一个验证者发现符合以上三种情况任一种时，就会将新的轮数附加到 round change消息上广播出去，然后等待来自其它验证者的 round change消息。附加的新的轮数根据以下条件确定<ul><li>如果验证者收到来自其它节点的 round change 消息，它会从数量超过F+1个的轮数消息中选择最大的那个轮数</li><li>否则，将 当前轮数+1 作为新的轮数</li></ul></li><li>无论何时，验证者一旦收到同一个轮数上的F+1个 round change 消息，它就会比较收到的轮数和自己的轮数，如果收到的更大，验证者会以收到的轮数再次广播 round change 消息</li><li>一旦收到了同一个轮数上的 2F+1 个round change消息，验证者就会退出round change循环，选举新的proposer，然后进入new round状态</li><li>另一个验证者跳出轮数改变循环的情况是它通过节点同步收到了已验证的区块</li></ul><a class=post-dummy-target id=4-proposer选择></a><h3>4. Proposer选择</h3><p>当前支持两种策略：round robin和sticky proposer</p><ul><li>round robin：每一次区块和轮数更改都会换一个proposer</li><li>sticky proposer：只有轮数改变时才会更改proposer</li></ul><a class=post-dummy-target id=5-验证者列表投票></a><h3>5. 验证者列表投票</h3><p>IBFT使用一个和Clique相似的验证者投票机制，每个epoch交易都会重置验证者投票，这意味着当授权或取消授权投票过程正在进行，投票过程将中止。</p><p>对所有交易区块而言</p><ul><li>proposer可以投一票提议更改验证者列表</li></ul><p>未完待续</p><a class=post-dummy-target id=问题></a><h2>问题</h2><ul><li><p><a href=https://github.com/jpmorganchase/quorum/issues/305 target=_blank>Istanbul BFT&rsquo;s design cannot successfully tolerate fail-stop failures #305</a></p></li><li><p><a href=https://arxiv.org/pdf/1901.07160.pdf target=_blank>Correctness Analysis of Istanbul Byzantine Fault Tolerance</a></p></li><li><p>没有激励机制</p></li></ul></div><div class=post-copyright id=post-footer><p class=copyright-item><span>Author:&nbsp;</span>
<span>shuzang</span></p><p class=copyright-item><span>Updated on:&nbsp;</span>
<span>2019-10-29</span></p><p class=copyright-item><span>Share on:&nbsp;</span>
<span><a href="//twitter.com/share?url=https%3a%2f%2fshuzang.github.io%2f2019%2fibft-consensus%2f&text=%e5%8c%ba%e5%9d%97%e9%93%be%e5%ad%a6%e4%b9%a06-IBFT%e5%85%b1%e8%af%86&via=" target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-fw"></i></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fshuzang.github.io%2f2019%2fibft-consensus%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook-square fa-fw"></i></a><a href="//reddit.com/submit?url=https%3a%2f%2fshuzang.github.io%2f2019%2fibft-consensus%2f&title=%e5%8c%ba%e5%9d%97%e9%93%be%e5%ad%a6%e4%b9%a06-IBFT%e5%85%b1%e8%af%86" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-fw"></i></a></span></p><p class=copyright-item></p><p class=copyright-item></p></div><br><div class=post-info-more><section><span class=tag><a href=https://shuzang.github.io/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/><i class="fas fa-tag fa-fw"></i>&nbsp;区块链</a>&nbsp;</span></section><section><span><a href=javascript:window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=https://shuzang.github.io>Home</a></span></section></div><div class=post-nav><a href=https://shuzang.github.io/2019/sec-blockedge-security-threats-in-blockchain-edge-based-iiot-network/ class=prev rel=prev title="SEC-BlockEdge Security Threats in Blockchain-Edge based IIoT Network"><i class="fas fa-angle-left fa-fw"></i>SEC-BlockEdge Security Threats in Blockchain-Edge based IIoT Network</a>
<a href=https://shuzang.github.io/2019/golang-syntax-4-operators-and-flow-control/ class=next rel=next title=Golang语法基础4-运算符与流程控制>Golang语法基础4-运算符与流程控制<i class="fas fa-angle-right fa-fw"></i></a></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright><div class=copyright-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://shuzang.github.io/about/ target=_blank>shuzang</a> | </span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a> & <a href=https://github.com/dillonzq/LoveIt target=_blank rel="external nofollow noopener noreffer">LoveIt</a></div></div></footer></div><a href=# class=dynamic-to-top id=dynamic-to-top data-scroll><span>&nbsp;</span></a>
<script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-209130979-1','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=/js/lib/jquery/jquery.slim.min.js></script><script src=/js/lib/lazysizes/lazysizes.min.js></script><script src=/js/lib/smooth-scroll/smooth-scroll.polyfills.min.js></script><script>window.scroll=new SmoothScroll('[data-scroll]',{speed:300,speedAsDuration:true});</script><link rel=stylesheet href=/css/lib/katex/katex.min.css><script src=/js/lib/katex/katex.min.js></script><script defer src=/js/lib/katex/auto-render.min.js></script><link rel=stylesheet href=/css/lib/katex/copy-tex.min.css><script defer src=/js/lib/katex/copy-tex.min.js></script><script defer src=/js/lib/katex/mhchem.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:true},{left:"\\(",right:"\\)",display:false},{left:"\\[",right:"\\]",display:true},{left:"$",right:"$",display:false},]});});</script><script src=/js/blog.min.js></script></body></html>